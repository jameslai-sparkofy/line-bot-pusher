<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flex Carousel Á∑®ËºØÂô® - ÊàøÂú∞Áî¢Â∞àÁî®</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            height: 100vh;
            overflow: hidden;
        }

        /* È†≠ÈÉ®Â∑•ÂÖ∑Âàó */
        .editor-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        .editor-title {
            font-size: 20px;
            font-weight: bold;
        }

        .editor-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 14px;
        }

        .btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .btn-primary {
            background: rgba(255,255,255,0.9);
            color: #667eea;
            font-weight: 500;
        }

        /* ‰∏ªË¶ÅÁ∑®ËºØÂçÄÂüü */
        .editor-main {
            display: flex;
            height: calc(100vh - 70px);
        }

        /* Â∑¶ÂÅ¥Ê®°ÊùøÈÅ∏ÊìáÈù¢Êùø */
        .template-panel {
            width: 320px;
            background: white;
            border-right: 1px solid #e1e8ed;
            display: flex;
            flex-direction: column;
        }

        .panel-header {
            padding: 20px;
            border-bottom: 1px solid #e1e8ed;
            background: #f8f9fa;
        }

        .panel-title {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        /* Èù¢ÊùøÊ®ôÁ±§ */
        .panel-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #e1e8ed;
        }

        .panel-tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
            font-size: 14px;
            background: transparent;
            border: none;
        }

        .panel-tab.active {
            background: white;
            border-bottom-color: #667eea;
            color: #667eea;
            font-weight: bold;
        }

        .panel-tab:hover {
            background: #e9ecef;
        }

        /* Êñ∞ÁöÑËÆäÊï∏ÁÆ°ÁêÜÊ®£Âºè */
        .variable-floating-panel {
            position: fixed;
            top: 70px;
            right: 20px;
            width: 350px;
            max-height: calc(100vh - 100px);
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            z-index: 1000;
            overflow: hidden;
        }

        .variable-panel-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .variable-panel-header h4 {
            margin: 0;
            font-size: 16px;
        }

        .variable-panel-content {
            padding: 20px;
            max-height: calc(100vh - 180px);
            overflow-y: auto;
        }

        .variable-section-title {
            font-size: 14px;
            font-weight: bold;
            color: #333;
            margin: 20px 0 10px 0;
            padding-bottom: 5px;
            border-bottom: 2px solid #e9ecef;
        }

        .variable-row {
            margin-bottom: 15px;
        }

        .variable-row label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: #555;
            margin-bottom: 5px;
        }

        .variable-input-group {
            display: flex;
            gap: 5px;
        }

        .variable-input-group input,
        .variable-input-group textarea {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .variable-input-group textarea {
            min-height: 60px;
            max-height: 120px;
        }

        .insert-var-btn {
            padding: 8px 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            white-space: nowrap;
        }

        .insert-var-btn:hover {
            background: #5a67d8;
        }

        /* Ë°®Ê†ºÁ∑®ËºØÂô®Ê®£Âºè */
        .table-editor-header {
            margin-bottom: 10px;
        }

        .add-row-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .add-row-btn:hover {
            background: #218838;
        }

        .table-editor {
            border: 1px solid #e1e8ed;
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .table-row {
            display: flex;
            border-bottom: 1px solid #e1e8ed;
            background: white;
        }

        .table-row:last-child {
            border-bottom: none;
        }

        .table-row:nth-child(even) {
            background: #f8f9fa;
        }

        .table-cell {
            flex: 1;
            padding: 8px 12px;
            border-right: 1px solid #e1e8ed;
            display: flex;
            align-items: center;
        }

        .table-cell:last-child {
            border-right: none;
        }

        .table-cell input {
            width: 100%;
            border: none;
            background: transparent;
            font-size: 13px;
            padding: 2px;
        }

        .table-cell input:focus {
            outline: 1px solid #667eea;
            border-radius: 2px;
        }

        .table-cell-header {
            background: #f1f3f4;
            font-weight: 600;
            font-size: 12px;
            color: #333;
        }

        .delete-row-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
        }

        .delete-row-btn:hover {
            background: #c82333;
        }

        /* ËÆäÊï∏Ê®°ÂºèÊåáÁ§∫Âô® */
        .variable-mode-active {
            background: #28a745 !important;
            color: white !important;
            border-color: #28a745 !important;
        }

        /* ËÆäÊï∏È´ò‰∫ÆÊ®£Âºè */
        .variable-highlight {
            background-color: #e7f3ff;
            color: #1976d2;
            padding: 2px 4px;
            border-radius: 3px;
            font-weight: bold;
        }

        /* ÊèíÂÖ•ËÆäÊï∏ÊåâÈàï */
        .insert-variable-btn {
            background: #f8f9fa;
            border: 1px solid #ddd;
            color: #667eea;
            font-size: 12px;
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            margin-left: 5px;
        }

        .insert-variable-btn:hover {
            background: #667eea;
            color: white;
        }

        /* ËÆäÊï∏ÂÄºÁ∑®ËºØÂçÄÊ®£Âºè */
        .variable-values-section h5 {
            margin-bottom: 15px;
            color: #333;
        }

        .variable-editor-row {
            margin-bottom: 15px;
            padding: 12px;
            border: 1px solid #e1e8ed;
            border-radius: 6px;
            background: #f8f9fa;
        }

        .variable-editor-label {
            font-size: 13px;
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
            display: block;
        }

        .variable-editor-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }

        .variable-editor-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }

        /* Ë§áÈõúËÆäÊï∏Á∑®ËºØÂô® */
        .complex-variable-editor {
            margin-top: 10px;
        }

        .complex-editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .complex-editor-title {
            font-size: 12px;
            font-weight: bold;
            color: #666;
        }

        .add-item-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
        }

        .add-item-btn:hover {
            background: #218838;
        }

        .complex-item {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            align-items: center;
        }

        .complex-item input {
            flex: 1;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 12px;
        }

        .remove-item-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 4px 6px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 10px;
        }

        .remove-item-btn:hover {
            background: #c82333;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .template-list {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
        }


        .template-item {
            padding: 12px 15px;
            margin-bottom: 8px;
            background: white;
            border: 1px solid #e1e8ed;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }

        .template-item:hover {
            background: #f8f9ff;
            border-color: #667eea;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .template-item.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .template-item-title {
            font-weight: 500;
            margin-bottom: 4px;
        }

        .template-item-info {
            font-size: 12px;
            color: #666;
        }

        .template-item.active .template-item-info {
            color: rgba(255,255,255,0.8);
        }

        .template-item-actions {
            display: flex;
            gap: 5px;
            margin-top: 8px;
        }

        .template-delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 11px;
            cursor: pointer;
        }

        .template-delete-btn:hover {
            background: #c82333;
        }

        /* ‰∏≠ÈñìÂÖßÂÆπÁ∑®ËºØÂçÄ */
        .content-editor {
            flex: 1;
            background: white;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #e1e8ed;
        }

        .tabs-header {
            padding: 15px 20px;
            border-bottom: 1px solid #e1e8ed;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .carousel-tabs {
            display: flex;
            gap: 8px;
            flex: 1;
        }

        .tab-item {
            background: #e9ecef;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .tab-item:hover {
            background: #dee2e6;
        }

        .tab-item.active {
            background: #667eea;
            color: white;
        }

        .tab-close {
            margin-left: 8px;
            font-weight: bold;
            opacity: 0.7;
        }

        .tab-close:hover {
            opacity: 1;
        }

        .add-tab {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
        }

        .content-form {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .form-section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #f0f0f0;
        }

        .form-section:last-child {
            border-bottom: none;
        }

        .section-title {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .section-icon {
            margin-right: 8px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 6px;
            font-size: 14px;
            font-weight: 500;
            color: #333;
        }

        .form-input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e1e8ed;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-textarea {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e1e8ed;
            border-radius: 6px;
            font-size: 14px;
            resize: vertical;
            min-height: 80px;
        }

        /* Âè≥ÂÅ¥È†êË¶ΩÂçÄ */
        .preview-area {
            width: 400px;
            background: #f0f2f5;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 30px 20px;
        }

        .phone-preview {
            width: 320px;
            height: 580px;
            background: #000;
            border-radius: 25px;
            padding: 15px 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            position: relative;
        }

        .phone-screen {
            width: 100%;
            height: 100%;
            background: #f0f0f0;
            border-radius: 18px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            background: #00b300;
            color: white;
            padding: 12px;
            font-size: 14px;
            font-weight: bold;
            text-align: center;
        }

        .chat-content {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
        }

        .carousel-preview {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding: 10px 0;
        }

        .bubble-preview {
            min-width: 200px;
            max-width: 200px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .bubble-image {
            width: 100%;
            height: 100px;
            object-fit: cover;
            background: #f0f0f0;
        }

        .bubble-content {
            padding: 12px;
        }

        .bubble-title {
            font-size: 14px;
            font-weight: bold;
            color: #333;
            margin-bottom: 4px;
        }

        .bubble-buttons {
            padding: 8px 12px;
            border-top: 1px solid #f0f0f0;
        }

        .bubble-button {
            display: block;
            width: 100%;
            padding: 8px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 4px;
            margin-bottom: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .bubble-button:last-child {
            margin-bottom: 0;
        }

        .bubble-button.secondary {
            background: #f8f9fa;
            color: #333;
            border: 1px solid #dee2e6;
        }

        .bubble-button.share {
            background: #1db446;
        }

        /* Toast ÈÄöÁü•Ê®£Âºè */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #333;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            z-index: 9999;
            opacity: 0;
            transform: translateX(300px);
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }

        .toast.success {
            background: #28a745;
        }

        .toast.error {
            background: #dc3545;
        }

        /* Èù¢ÊùøÂàÜÈ†ÅÊ®£Âºè */
        .panel-tabs {
            display: flex;
            border-bottom: 1px solid #e1e8ed;
            background: #f8f9fa;
        }

        .panel-tab {
            flex: 1;
            padding: 12px 16px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            color: #666;
            transition: all 0.2s;
            border-bottom: 2px solid transparent;
        }

        .panel-tab:hover {
            background: #e9ecef;
            color: #333;
        }

        .panel-tab.active {
            color: #667eea;
            background: white;
            border-bottom-color: #667eea;
        }

        .panel-content {
            padding: 15px;
            flex: 1;
            overflow-y: auto;
        }

        .panel-actions {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
        }

        /* ËÆäÊï∏ÁÆ°ÁêÜÊ®£Âºè */
        .variables-container {
            height: 100%;
        }

        .variables-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .variable-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e1e8ed;
        }

        .variable-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .variable-name {
            font-weight: bold;
            color: #333;
            font-size: 14px;
        }

        .variable-code {
            font-family: 'Monaco', 'Menlo', monospace;
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 12px;
            color: #667eea;
        }

        .variable-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
            transition: border-color 0.2s;
        }

        .variable-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }

        .copy-variable-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .copy-variable-btn:hover {
            background: #5a6fd8;
        }
    </style>
</head>
<body>
    <!-- È†≠ÈÉ®Â∑•ÂÖ∑Âàó -->
    <div class="editor-header">
        <div style="display: flex; align-items: center; gap: 15px;">
            <a href="./management" style="color: white; text-decoration: none; font-size: 14px; font-weight: bold; padding: 10px 16px; border-radius: 8px; background: #667eea; border: 2px solid #667eea; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1);" onmouseover="this.style.background='#5a67d8'; this.style.borderColor='#5a67d8'; this.style.transform='translateY(-1px)'" onmouseout="this.style.background='#667eea'; this.style.borderColor='#667eea'; this.style.transform='translateY(0)'">‚Üê ËøîÂõûÁÆ°ÁêÜÈ†ÅÈù¢</a>
            <div class="editor-title" id="editor-title" onclick="editTemplateTitle()" style="cursor: pointer;">üèóÔ∏è Flex Carousel Á∑®ËºØÂô®</div>
        </div>
        <div class="editor-actions">
            <button class="btn" onclick="showJsonPreview()">üìù Ê™¢Ë¶ñ JSON</button>
            <button class="btn btn-primary" onclick="window.close()">‚úï ÈóúÈñâ</button>
        </div>
    </div>

    <!-- ‰∏ªË¶ÅÁ∑®ËºØÂçÄÂüü -->
    <div class="editor-main">
        <!-- Â∑¶ÂÅ¥ÁÆ°ÁêÜÈù¢Êùø -->
        <div class="template-panel">
            <!-- ÂàÜÈ†ÅÊ®ôÁ±§ -->
            <div class="panel-tabs">
                <button class="panel-tab active" onclick="switchPanelTab('templates')" id="tab-templates">üìã Ê®°ÊùøÁÆ°ÁêÜ</button>
                <button class="panel-tab" onclick="switchPanelTab('variables')" id="tab-variables">üéØ ËÆäÊï∏ÁÆ°ÁêÜ</button>
            </div>
            
            <!-- Ê®°ÊùøÁÆ°ÁêÜÂàÜÈ†Å -->
            <div class="panel-content" id="panel-templates">
                <div class="panel-actions">
                    <button class="btn" onclick="addNewTemplate()" style="background: #28a745; color: white; border: none; padding: 6px 10px; border-radius: 4px; font-size: 12px;">+ Êñ∞Â¢û</button>
                    <button class="btn" onclick="saveTemplate()" style="background: #007bff; color: white; border: none; padding: 6px 10px; border-radius: 4px; font-size: 12px;">üíæ ÂÑ≤Â≠ò</button>
                </div>
                <div class="template-list" id="template-list">
                    <!-- ÂãïÊÖãËºâÂÖ•Ê®°ÊùøÂàóË°® -->
                </div>
            </div>
            
            <!-- ËÆäÊï∏ÁÆ°ÁêÜÂàÜÈ†Å -->
            <div class="panel-content" id="panel-variables" style="display: none;">
                <div class="variables-container">
                    <div class="variables-header">
                        <h4 style="margin: 0 0 15px 0; color: #333;">üéØ ËÆäÊï∏ÁÆ°ÁêÜ</h4>
                        <p style="color: #666; font-size: 12px; margin-bottom: 20px;">Ë®≠ÂÆöËÆäÊï∏È†êË®≠ÂÄºÔºåÊ®°ÊùøÈ†êË¶ΩÊúÉËá™Âãï‰ª£ÂÖ•ÈÄô‰∫õÂÄº</p>
                    </div>
                    <div class="variables-list" id="variables-list">
                        <!-- ÂãïÊÖãËºâÂÖ•ËÆäÊï∏ÂàóË°® -->
                    </div>
                </div>
            </div>

        </div>

        <!-- ‰∏≠ÈñìÂÖßÂÆπÁ∑®ËºØÂçÄ -->
        <div class="content-editor">
            <!-- Ê®°ÊùøÊ®ôÈ°å -->
            <div style="padding: 15px 20px; background: #f8f9fa; border-bottom: 1px solid #e1e8ed;">
                <input type="text" id="template-title" class="form-input" placeholder="Ê®°ÊùøÊ®ôÈ°å" style="font-size: 16px; font-weight: bold; border: 1px solid #ddd; padding: 8px 12px;" onchange="updateCurrentTemplateTitle(this.value)">
            </div>
            <div class="tabs-header">
                <div class="carousel-tabs" id="carousel-tabs">
                    <!-- ÂãïÊÖãËºâÂÖ•ÂàÜÈ†ÅÊ®ôÁ±§ -->
                </div>
                <button class="add-tab" onclick="addNewTab()">+ Êñ∞Â¢ûÂàÜÈ†Å</button>
            </div>

            <div class="content-form" id="content-form">
                <!-- ÂãïÊÖãËºâÂÖ•Ë°®ÂñÆÂÖßÂÆπ -->
            </div>
        </div>

        <!-- Âè≥ÂÅ¥È†êË¶ΩÂçÄ -->
        <div class="preview-area">
            <div class="phone-preview">
                <div class="phone-screen">
                    <div class="chat-header">LINE Chat È†êË¶Ω</div>
                    <div class="chat-content">
                        <div class="carousel-preview" id="carousel-preview">
                            <!-- ÂãïÊÖãÁî¢ÁîüÈ†êË¶ΩÂÖßÂÆπ -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ÂÖ®ÂüüËÆäÊï∏
        let currentTemplateIndex = 0;
        let currentTabIndex = 0;
        let templates = [];
        let carouselData = {
            type: 'carousel',
            contents: []
        };

        // ËÆäÊï∏ÁÆ°ÁêÜ
        let templateVariables = {
            project_name: '',
            total_progress: '',
            manager: '',
            date: '',
            building_progress: [],
            today_progress: [],
            work_log: ''
        };

        // ËÆäÊï∏Ê®°Êùø
        const variableTemplate = {
            "type": "carousel",
            "contents": [
                // Á¨¨‰∏ÄÈ†ÅÔºö‰ªäÊó•ÈÄ≤Â∫¶
                {
                    "type": "bubble",
                    "hero": {
                        "type": "image",
                        "url": "https://developers-resource.landpress.line.me/fx/img/01_2_restaurant.png",
                        "size": "full",
                        "aspectRatio": "20:13",
                        "aspectMode": "cover"
                    },
                    "body": {
                        "type": "box",
                        "layout": "vertical",
                        "spacing": "md",
                        "contents": [
                            {
                                "type": "text",
                                "text": "{{project_name}}",
                                "size": "xl",
                                "weight": "bold"
                            },
                            {
                                "type": "text",
                                "text": "‰ªäÊó•ÈÄ≤Â∫¶Â†±Âëä",
                                "size": "md",
                                "color": "#666666",
                                "margin": "sm"
                            },
                            {
                                "type": "box",
                                "layout": "vertical",
                                "spacing": "sm",
                                "margin": "lg",
                                "contents": []
                            },
                            {
                                "type": "separator",
                                "margin": "lg"
                            },
                            {
                                "type": "box",
                                "layout": "baseline",
                                "spacing": "sm",
                                "margin": "lg",
                                "contents": [
                                    {
                                        "type": "text",
                                        "text": "Ë≤†Ë≤¨‰∫∫Ôºö",
                                        "size": "sm",
                                        "color": "#aaaaaa",
                                        "flex": 0
                                    },
                                    {
                                        "type": "text",
                                        "text": "{{manager}}",
                                        "size": "sm",
                                        "color": "#666666",
                                        "wrap": true
                                    }
                                ]
                            },
                            {
                                "type": "text",
                                "text": "{{date}}",
                                "size": "xs",
                                "color": "#aaaaaa",
                                "margin": "sm"
                            }
                        ]
                    }
                },
                // Á¨¨‰∫åÈ†ÅÔºöÁ∏ΩÈÄ≤Â∫¶ËàáÊ£üÂà•ÈÄ≤Â∫¶
                {
                    "type": "bubble",
                    "hero": {
                        "type": "image",
                        "url": "https://developers-resource.landpress.line.me/fx/img/01_2_restaurant.png",
                        "size": "full",
                        "aspectRatio": "20:13",
                        "aspectMode": "cover"
                    },
                    "body": {
                        "type": "box",
                        "layout": "vertical",
                        "spacing": "md",
                        "contents": [
                            {
                                "type": "text",
                                "text": "{{project_name}}",
                                "size": "xl",
                                "weight": "bold"
                            },
                            {
                                "type": "box",
                                "layout": "baseline",
                                "spacing": "sm",
                                "margin": "lg",
                                "contents": [
                                    {
                                        "type": "text",
                                        "text": "Á∏ΩÈÄ≤Â∫¶Ôºö",
                                        "size": "md",
                                        "color": "#333333",
                                        "flex": 0
                                    },
                                    {
                                        "type": "text",
                                        "text": "{{total_progress}}",
                                        "size": "xl",
                                        "color": "#00B900",
                                        "weight": "bold"
                                    }
                                ]
                            },
                            {
                                "type": "separator",
                                "margin": "lg"
                            },
                            {
                                "type": "text",
                                "text": "ÂêÑÊ£üÈÄ≤Â∫¶",
                                "size": "md",
                                "weight": "bold",
                                "margin": "lg"
                            },
                            {
                                "type": "box",
                                "layout": "vertical",
                                "spacing": "sm",
                                "contents": []
                            },
                            {
                                "type": "text",
                                "text": "{{date}} Êõ¥Êñ∞",
                                "size": "xs",
                                "color": "#aaaaaa",
                                "margin": "lg"
                            }
                        ]
                    }
                }
            ]
        };

        // È†êË®≠Ê®°Êùø
        const defaultBubbleTemplate = {
            "type": "bubble",
            "hero": {
                "type": "image",
                "url": "https://developers-resource.landpress.line.me/fx/img/01_2_restaurant.png",
                "size": "full",
                "aspectRatio": "20:13",
                "aspectMode": "cover",
                "action": {
                    "type": "uri",
                    "uri": "https://line.me/"
                }
            },
            "body": {
                "type": "box",
                "layout": "vertical",
                "spacing": "md",
                "action": {
                    "type": "uri",
                    "uri": "https://line.me/"
                },
                "contents": [
                    {
                        "type": "text",
                        "text": "ÂãùÁæé - Âª∫ÂäüÊÆµ",
                        "size": "xl",
                        "weight": "bold"
                    },
                    {
                        "type": "box",
                        "layout": "vertical",
                        "spacing": "sm",
                        "contents": [
                            {
                                "type": "box",
                                "layout": "baseline",
                                "contents": [
                                    {
                                        "type": "icon",
                                        "url": "https://developers-resource.landpress.line.me/fx/img/restaurant_regular_32.png"
                                    },
                                    {
                                        "type": "text",
                                        "text": "AÊ£ü",
                                        "weight": "bold",
                                        "margin": "sm",
                                        "flex": 0
                                    },
                                    {
                                        "type": "text",
                                        "text": "95%",
                                        "size": "sm",
                                        "align": "end",
                                        "color": "#aaaaaa"
                                    }
                                ]
                            },
                            {
                                "type": "box",
                                "layout": "baseline",
                                "contents": [
                                    {
                                        "type": "icon",
                                        "url": "https://developers-resource.landpress.line.me/fx/img/restaurant_large_32.png"
                                    },
                                    {
                                        "type": "text",
                                        "text": "{{building_progress}}",
                                        "weight": "bold",
                                        "margin": "sm",
                                        "flex": 0
                                    },
                                    {
                                        "type": "text",
                                        "text": "{{building_progress}}",
                                        "size": "sm",
                                        "align": "end",
                                        "color": "#aaaaaa"
                                    }
                                ]
                            }
                        ]
                    },
                    {
                        "type": "text",
                        "text": "2025-08-24 ÈÄ≤Â∫¶Â†±Âëä",
                        "wrap": true,
                        "color": "#aaaaaa",
                        "size": "xs"
                    }
                ],
                "paddingBottom": "xs"
            },
            "footer": {
                "type": "box",
                "layout": "vertical",
                "contents": [
                    {
                        "type": "button",
                        "style": "secondary",
                        "color": "#84C7D0",
                        "margin": "lg",
                        "action": {
                            "type": "uri",
                            "label": "‰∫ÜËß£Êõ¥Â§ö",
                            "uri": "https://line.me/"
                        },
                        "offsetTop": "none",
                        "offsetEnd": "none",
                        "offsetStart": "none",
                        "offsetBottom": "xs"
                    },
                    {
                        "type": "button",
                        "action": {
                            "type": "uri",
                            "label": "ÂàÜ‰∫´",
                            "uri": "http://linecorp.com/"
                        },
                        "offsetTop": "none",
                        "offsetEnd": "none",
                        "offsetBottom": "none",
                        "offsetStart": "none",
                        "adjustMode": "shrink-to-fit",
                        "margin": "md",
                        "style": "secondary"
                    }
                ],
                "paddingAll": "md",
                "paddingTop": "none"
            }
        };

        // ========== Êñ∞ÁöÑËÆäÊï∏ÁÆ°ÁêÜÂäüËÉΩ ==========
        
        let isVariableMode = false;
        let buildingProgressData = [];
        let todayProgressData = [];
        
        // ÂàáÊèõËÆäÊï∏Ê®°Âºè
        function toggleVariableMode() {
            isVariableMode = !isVariableMode;
            const btn = document.getElementById('variable-mode-btn');
            const panel = document.getElementById('variable-panel');
            
            if (isVariableMode) {
                btn.textContent = '‚úì ËÆäÊï∏Ê®°Âºè';
                btn.classList.add('variable-mode-active');
                panel.style.display = 'block';
                
                // ÂàùÂßãÂåñËÆäÊï∏ÁÆ°ÁêÜÈù¢Êùø
                initializeVariablePanel();
                
                // Âú®Á∑®ËºØË°®ÂñÆ‰∏≠Êñ∞Â¢ûÊèíÂÖ•ËÆäÊï∏ÊåâÈàï
                addVariableButtonsToForm();
            } else {
                btn.textContent = 'üéØ ËÆäÊï∏Ê®°Âºè';
                btn.classList.remove('variable-mode-active');
                panel.style.display = 'none';
                
                // ÁßªÈô§ÊèíÂÖ•ËÆäÊï∏ÊåâÈàï
                removeVariableButtonsFromForm();
            }
        }
        
        // ÈóúÈñâËÆäÊï∏Èù¢Êùø
        function closeVariablePanel() {
            isVariableMode = false;
            const btn = document.getElementById('variable-mode-btn');
            const panel = document.getElementById('variable-panel');
            
            btn.textContent = 'üéØ ËÆäÊï∏Ê®°Âºè';
            btn.classList.remove('variable-mode-active');
            panel.style.display = 'none';
            
            removeVariableButtonsFromForm();
        }
        
        // Âª∫Á´ãËÆäÊï∏Ê®°Êùø
        function createVariableTemplate() {
            // Êñ∞Â¢ûËÆäÊï∏Ê®°Êùø
            const newTemplate = {
                id: Date.now(),
                name: 'Êñ∞ËÆäÊï∏Ê®°Êùø',
                carouselData: JSON.parse(JSON.stringify(variableTemplate))
            };
            
            templates.push(newTemplate);
            currentTemplateIndex = templates.length - 1;
            carouselData = newTemplate.carouselData;
            
            renderTemplateList();
            updateTabs();
            updatePreview();
            
            // Ëá™ÂãïÈñãÂïüËÆäÊï∏Ê®°Âºè
            if (!isVariableMode) {
                toggleVariableMode();
            }
            
            // ÂàùÂßãÂåñËÆäÊï∏ÂÄº
            initializeVariableValues();
            
            alert('ËÆäÊï∏Ê®°ÊùøÂ∑≤Âª∫Á´ãÔºÅÊ≠£Âú®ÈñãÂïüËÆäÊï∏ÁÆ°ÁêÜÈù¢Êùø„ÄÇ');
        }
        
        // ÂàùÂßãÂåñËÆäÊï∏Èù¢Êùø
        function initializeVariablePanel() {
            // ÂàùÂßãÂåñÂü∫Êú¨ËÆäÊï∏
            if (!document.getElementById('var-project-name').value) {
                document.getElementById('var-project-name').value = 'ÂãùÁæé - Âª∫ÂäüÊÆµ';
            }
            if (!document.getElementById('var-total-progress').value) {
                document.getElementById('var-total-progress').value = '78%';
            }
            if (!document.getElementById('var-manager').value) {
                document.getElementById('var-manager').value = 'ÂºµÁ∂ìÁêÜ';
            }
            if (!document.getElementById('var-date').value) {
                document.getElementById('var-date').value = new Date().toISOString().split('T')[0];
            }
            if (!document.getElementById('var-work-log').value) {
                document.getElementById('var-work-log').value = '‰ªäÊó•ÂÆåÊàêBÊ£ü3Ê®ìËá≥4Ê®ìÊ¢ÅÊü±ÊñΩÂ∑•ÔºåCÊ£üÂú∞Âü∫ÈñãÊåñ';
            }
            
            // ÂàùÂßãÂåñÊ£üÂà•ÈÄ≤Â∫¶
            if (buildingProgressData.length === 0) {
                buildingProgressData = [
                    {name: "AÊ£ü", progress: "95%"},
                    {name: "BÊ£ü", progress: "80%"},
                    {name: "CÊ£ü", progress: "60%"}
                ];
            }
            
            // ÂàùÂßãÂåñ‰ªäÊó•ÈÄ≤Â∫¶
            if (todayProgressData.length === 0) {
                todayProgressData = [
                    {building: "BÊ£ü", work: "3FB4Ê®ìÁâà", url: "https://example.com/b3fb4"},
                    {building: "CÊ£ü", work: "Âú∞Âü∫ÊñΩÂ∑•", url: "https://example.com/foundation"}
                ];
            }
            
            // Ê∏≤ÊüìË°®Ê†º
            renderBuildingProgressTable();
            renderTodayProgressTable();
            
            // Êõ¥Êñ∞ËÆäÊï∏
            updateVariables();
        }
        
        // ÂàùÂßãÂåñËÆäÊï∏ÂÄº(‰øùÊåÅÁõ∏ÂÆπÊÄß)
        function initializeVariableValues() {
            initializeVariablePanel();
        }
        
        // Êõ¥Êñ∞ËÆäÊï∏
        function updateVariables() {
            // ËÆÄÂèñËÆäÊï∏ÂÄº
            templateVariables.project_name = document.getElementById('var-project-name').value || 'Â∞àÊ°àÂêçÁ®±';
            templateVariables.total_progress = document.getElementById('var-total-progress').value || '0%';
            templateVariables.manager = document.getElementById('var-manager').value || 'Ë≤†Ë≤¨‰∫∫';
            templateVariables.date = document.getElementById('var-date').value || new Date().toISOString().split('T')[0];
            templateVariables.work_log = document.getElementById('var-work-log').value || '';
            
            // ‰ΩøÁî®Ë°®Ê†ºÊï∏Êìö
            templateVariables.building_progress = buildingProgressData;
            templateVariables.today_progress = todayProgressData;
            
            // Â¶ÇÊûúÁõÆÂâçÊ®°ÊùøÂê´ÊúâËÆäÊï∏ÔºåÊõ¥Êñ∞È†êË¶Ω
            if (templates.length > 0 && hasVariables(carouselData)) {
                applyVariablesToTemplate();
                updatePreview();
            }
        }
        
        // Ê™¢Êü•Ê®°ÊùøÊòØÂê¶Âê´ÊúâËÆäÊï∏
        function hasVariables(data) {
            const str = JSON.stringify(data);
            return str.includes('{{') && str.includes('}}');
        }
        
        // ÊèíÂÖ•ËÆäÊï∏Âà∞ÁõÆÂâçÁÑ¶ÈªûÁöÑËº∏ÂÖ•Ê°Ü
        function insertVariable(varName) {
            const activeElement = document.activeElement;
            const variableText = `{{${varName}}}`;
            
            if (activeElement && (activeElement.tagName === 'INPUT' || activeElement.tagName === 'TEXTAREA')) {
                const start = activeElement.selectionStart;
                const end = activeElement.selectionEnd;
                const text = activeElement.value;
                
                activeElement.value = text.substring(0, start) + variableText + text.substring(end);
                activeElement.setSelectionRange(start + variableText.length, start + variableText.length);
                activeElement.focus();
                
                // Ëß∏Áôº onchange ‰∫ã‰ª∂
                const event = new Event('change', { bubbles: true });
                activeElement.dispatchEvent(event);
            } else {
                alert('Ë´ãÂÖàÈªûÊìäË¶ÅÊèíÂÖ•ËÆäÊï∏ÁöÑËº∏ÂÖ•Ê°Ü');
            }
        }
        
        // Â∞áËÆäÊï∏ÊáâÁî®Âà∞Ê®°Êùø
        function applyVariablesToTemplate() {
            if (!carouselData || !carouselData.contents) return;
            
            carouselData.contents.forEach((bubble, pageIndex) => {
                if (pageIndex === 0) {
                    // Á¨¨‰∏ÄÈ†ÅÔºö‰ªäÊó•ÈÄ≤Â∫¶
                    applyVariablesToBubble(bubble, true);
                } else if (pageIndex === 1) {
                    // Á¨¨‰∫åÈ†ÅÔºöÁ∏ΩÈÄ≤Â∫¶
                    applyVariablesToBubble(bubble, false);
                }
            });
            
            // Êõ¥Êñ∞Ê®°ÊùøË≥áÊñô
            if (templates[currentTemplateIndex]) {
                templates[currentTemplateIndex].carouselData = carouselData;
            }
        }
        
        // ÊáâÁî®ËÆäÊï∏Âà∞Âçï‰∏Ä bubble
        function applyVariablesToBubble(bubble, isTodayProgressPage) {
            if (!bubble.body || !bubble.body.contents) return;
            
            bubble.body.contents.forEach(content => {
                if (content.type === 'text') {
                    // ÊõøÊèõÊñáÂ≠óËÆäÊï∏
                    content.text = replaceVariables(content.text);
                } else if (content.type === 'box' && content.layout === 'vertical' && content.contents) {
                    if (isTodayProgressPage && content.contents.length === 0) {
                        // Á¨¨‰∏ÄÈ†ÅÁöÑ‰ªäÊó•ÈÄ≤Â∫¶ÂçÄÂüü
                        content.contents = generateTodayProgressItems(templateVariables.today_progress);
                    } else if (!isTodayProgressPage && content.contents.length === 0) {
                        // Á¨¨‰∫åÈ†ÅÁöÑÊ£üÂà•ÈÄ≤Â∫¶ÂçÄÂüü
                        content.contents = generateBuildingProgressItems(templateVariables.building_progress);
                    }
                } else if (content.type === 'box' && content.layout === 'baseline' && content.contents) {
                    // ËôïÁêÜ baseline ÂÖßÁöÑÊñáÂ≠ó
                    content.contents.forEach(item => {
                        if (item.type === 'text') {
                            item.text = replaceVariables(item.text);
                        }
                    });
                }
            });
        }
        
        // ÊõøÊèõËÆäÊï∏
        function replaceVariables(text) {
            if (!text) return text;
            
            return text
                .replace(/{{project_name}}/g, templateVariables.project_name)
                .replace(/{{total_progress}}/g, templateVariables.total_progress)
                .replace(/{{manager}}/g, templateVariables.manager)
                .replace(/{{date}}/g, templateVariables.date)
                .replace(/{{work_log}}/g, templateVariables.work_log);
        }
        
        // ÁîüÊàê‰ªäÊó•ÈÄ≤Â∫¶È†ÖÁõÆ
        function generateTodayProgressItems(todayProgressData) {
            if (!Array.isArray(todayProgressData) || todayProgressData.length === 0) {
                return [{
                    "type": "text",
                    "text": "ÁÑ°‰ªäÊó•ÈÄ≤Â∫¶Ë≥áÊñô",
                    "size": "sm",
                    "color": "#aaaaaa"
                }];
            }
            
            return todayProgressData.map(item => ({
                "type": "box",
                "layout": "baseline",
                "spacing": "sm",
                "contents": [
                    {
                        "type": "text",
                        "text": item.building || 'Êú™Áü•',
                        "size": "sm",
                        "color": "#333333",
                        "weight": "bold",
                        "flex": 0
                    },
                    {
                        "type": "text",
                        "text": item.work || 'Êú™Áü•Â∑•‰Ωú',
                        "size": "sm",
                        "color": item.url ? "#0099CC" : "#666666",
                        "wrap": true,
                        "action": item.url ? {
                            "type": "uri",
                            "uri": item.url
                        } : null
                    }
                ]
            }));
        }
        
        // ÁîüÊàêÊ£üÂà•ÈÄ≤Â∫¶È†ÖÁõÆ
        function generateBuildingProgressItems(buildingProgressData) {
            if (!Array.isArray(buildingProgressData) || buildingProgressData.length === 0) {
                return [{
                    "type": "text",
                    "text": "ÁÑ°Ê£üÂà•ÈÄ≤Â∫¶Ë≥áÊñô",
                    "size": "sm",
                    "color": "#aaaaaa"
                }];
            }
            
            return buildingProgressData.map(building => ({
                "type": "box",
                "layout": "baseline",
                "spacing": "sm",
                "contents": [
                    {
                        "type": "text",
                        "text": building.name || 'Êú™Áü•Ê£üÂà•',
                        "size": "sm",
                        "color": "#333333",
                        "weight": "bold",
                        "flex": 0
                    },
                    {
                        "type": "text",
                        "text": building.progress || '0%',
                        "size": "sm",
                        "color": "#00B900",
                        "align": "end"
                    }
                ]
            }));
        }

        // ========== Ë°®Ê†ºÁ∑®ËºØÂô®ÂäüËÉΩ ==========
        
        // Ê∏≤ÊüìÊ£üÂà•ÈÄ≤Â∫¶Ë°®Ê†º
        function renderBuildingProgressTable() {
            const table = document.getElementById('building-progress-table');
            let html = '';
            
            // Ë°®Ê†ºÊ®ôÈ†≠
            html += '<div class="table-row">';
            html += '<div class="table-cell table-cell-header">Ê£üÂêç</div>';
            html += '<div class="table-cell table-cell-header">ÈÄ≤Â∫¶</div>';
            html += '<div class="table-cell table-cell-header" style="flex: 0 0 60px;">Êìç‰Ωú</div>';
            html += '</div>';
            
            // Êï∞ÊçÆË°å
            buildingProgressData.forEach((building, index) => {
                html += '<div class="table-row">';
                html += `<div class="table-cell"><input type="text" value="${building.name || ''}" onchange="updateBuildingProgress(${index}, 'name', this.value)"></div>`;
                html += `<div class="table-cell"><input type="text" value="${building.progress || ''}" onchange="updateBuildingProgress(${index}, 'progress', this.value)" placeholder="‰æã: 85%"></div>`;
                html += `<div class="table-cell" style="flex: 0 0 60px;"><button class="delete-row-btn" onclick="deleteBuildingRow(${index})">√ó</button></div>`;
                html += '</div>';
            });
            
            table.innerHTML = html;
        }
        
        // Ê∏≤Êüì‰ªäÊó•ÈÄ≤Â∫¶Ë°®Ê†º
        function renderTodayProgressTable() {
            const table = document.getElementById('today-progress-table');
            let html = '';
            
            // Ë°®Ê†ºÊ®ôÈ†≠
            html += '<div class="table-row">';
            html += '<div class="table-cell table-cell-header">Ê£üÂà•</div>';
            html += '<div class="table-cell table-cell-header">Â∑•‰ΩúÂÖßÂÆπ</div>';
            html += '<div class="table-cell table-cell-header">ÈÄ£Áµê</div>';
            html += '<div class="table-cell table-cell-header" style="flex: 0 0 60px;">Êìç‰Ωú</div>';
            html += '</div>';
            
            // Êï∞ÊçÆË°å
            todayProgressData.forEach((progress, index) => {
                html += '<div class="table-row">';
                html += `<div class="table-cell"><input type="text" value="${progress.building || ''}" onchange="updateTodayProgress(${index}, 'building', this.value)"></div>`;
                html += `<div class="table-cell"><input type="text" value="${progress.work || ''}" onchange="updateTodayProgress(${index}, 'work', this.value)"></div>`;
                html += `<div class="table-cell"><input type="url" value="${progress.url || ''}" onchange="updateTodayProgress(${index}, 'url', this.value)" placeholder="https://..."></div>`;
                html += `<div class="table-cell" style="flex: 0 0 60px;"><button class="delete-row-btn" onclick="deleteTodayProgressRow(${index})">√ó</button></div>`;
                html += '</div>';
            });
            
            table.innerHTML = html;
        }
        
        // Êñ∞Â¢ûÊ£üÂà•Ë°å
        function addBuildingRow() {
            buildingProgressData.push({name: '', progress: ''});
            renderBuildingProgressTable();
            updateVariables();
        }
        
        // Êñ∞Â¢û‰ªäÊó•ÈÄ≤Â∫¶Ë°å
        function addTodayProgressRow() {
            todayProgressData.push({building: '', work: '', url: ''});
            renderTodayProgressTable();
            updateVariables();
        }
        
        // Êõ¥Êñ∞Ê£üÂà•ÈÄ≤Â∫¶
        function updateBuildingProgress(index, field, value) {
            if (buildingProgressData[index]) {
                buildingProgressData[index][field] = value;
                updateVariables();
            }
        }
        
        // Êõ¥Êñ∞‰ªäÊó•ÈÄ≤Â∫¶
        function updateTodayProgress(index, field, value) {
            if (todayProgressData[index]) {
                todayProgressData[index][field] = value;
                updateVariables();
            }
        }
        
        // Âà™Èô§Ê£üÂà•Ë°å
        function deleteBuildingRow(index) {
            buildingProgressData.splice(index, 1);
            renderBuildingProgressTable();
            updateVariables();
        }
        
        // Âà™Èô§‰ªäÊó•ÈÄ≤Â∫¶Ë°å
        function deleteTodayProgressRow(index) {
            todayProgressData.splice(index, 1);
            renderTodayProgressTable();
            updateVariables();
        }
        
        // Âú®Á∑®ËºØË°®ÂñÆ‰∏≠Êñ∞Â¢ûÊèíÂÖ•ËÆäÊï∏ÊåâÈàï
        function addVariableButtonsToForm() {
            // ÈÄôÂÄãÂäüËÉΩÂ∞áÂú®‰∏ã‰∏ÄÈöéÊÆµÂØ¶‰Ωú
        }
        
        // ÁßªÈô§ÊèíÂÖ•ËÆäÊï∏ÊåâÈàï
        function removeVariableButtonsFromForm() {
            // ÈÄôÂÄãÂäüËÉΩÂ∞áÂú®‰∏ã‰∏ÄÈöéÊÆµÂØ¶‰Ωú
        }

        // ÂàùÂßãÂåñÁ∑®ËºØÂô®
        async function init() {
            console.log('Carousel Á∑®ËºØÂô®ÂàùÂßãÂåñ...');
            
            // ËºâÂÖ•Â∑≤ÂÑ≤Â≠òÁöÑÊ®°Êùø
            await loadTemplates();
            
            // Â¶ÇÊûúÊ≤íÊúâÊ®°ÊùøÔºåÂª∫Á´ãÁ¨¨‰∏ÄÂÄãÈ†êË®≠Ê®°Êùø
            if (templates.length === 0) {
                addNewTemplate();
            } else {
                selectTemplate(0);
            }
            
            updateTabs();
            updatePreview();
        }

        // Á∑®ËºØÊ®°ÊùøÊ®ôÈ°å
        function editTemplateTitle() {
            if (templates.length === 0) return;
            
            const currentTemplate = templates[currentTemplateIndex];
            const newName = prompt('Ë´ãËº∏ÂÖ•Êñ∞ÁöÑÊ®°ÊùøÂêçÁ®±:', currentTemplate.name);
            
            if (newName && newName !== currentTemplate.name) {
                currentTemplate.name = newName;
                document.getElementById('editor-title').textContent = 'üìù ' + newName;
                renderTemplateList();
            }
        }

        // ËºâÂÖ•Â∑≤ÂÑ≤Â≠òÁöÑÊ®°Êùø
        async function loadTemplates() {
            try {
                const response = await fetch('/api/flex-templates');
                const data = await response.json();
                
                if (data.success && data.templates) {
                    templates = data.templates.map(t => ({
                        id: t.template_id,
                        name: t.template_name,
                        carouselData: JSON.parse(t.flex_content)
                    }));
                }
            } catch (error) {
                console.error('ËºâÂÖ•Ê®°ÊùøÂ§±Êïó:', error);
                templates = [];
            }
            
            renderTemplateList();
        }

        // Ê∏≤ÊüìÊ®°ÊùøÂàóË°®
        function renderTemplateList() {
            const container = document.getElementById('template-list');
            let html = '';
            
            templates.forEach((template, index) => {
                const isActive = index === currentTemplateIndex;
                const bubbleCount = template.carouselData?.contents?.length || 0;
                
                html += '<div class="template-item' + (isActive ? ' active' : '') + '" onclick="selectTemplate(' + index + ')">';
                html += '<div class="template-item-title">' + template.name + '</div>';
                html += '<div class="template-item-info">' + bubbleCount + ' ÂÄãÂàÜÈ†Å</div>';
                html += '<div class="template-item-actions">';
                html += '<button class="template-delete-btn" onclick="event.stopPropagation(); deleteTemplate(' + index + ')">Âà™Èô§</button>';
                html += '</div>';
                html += '</div>';
            });
            
            container.innerHTML = html;
        }

        // Êõ¥Êñ∞Áï∂ÂâçÊ®°ÊùøÊ®ôÈ°å
        function updateCurrentTemplateTitle(title) {
            if (templates.length > 0 && title) {
                templates[currentTemplateIndex].name = title;
                document.getElementById('editor-title').textContent = 'üìù ' + title;
                renderTemplateList();
            }
        }

        // ÈÅ∏ÊìáÊ®°Êùø
        function selectTemplate(index) {
            if (index >= 0 && index < templates.length) {
                currentTemplateIndex = index;
                carouselData = templates[index].carouselData;
                currentTabIndex = 0;
                
                document.querySelector('.editor-title').textContent = 'üìù ' + templates[index].name;
                document.getElementById('template-title').value = templates[index].name;
                
                renderTemplateList();
                updateTabs();
                updatePreview();
            }
        }

        // Êñ∞Â¢ûÊ®°Êùø
        function addNewTemplate() {
            const templateName = prompt('Ë´ãËº∏ÂÖ•Ê®°ÊùøÂêçÁ®±:', 'Êñ∞Ê®°Êùø ' + (templates.length + 1));
            if (!templateName) return;
            
            const newTemplate = {
                id: 'temp_' + Date.now(),
                name: templateName,
                carouselData: {
                    type: 'carousel',
                    contents: [JSON.parse(JSON.stringify(defaultBubbleTemplate))]
                }
            };
            
            templates.push(newTemplate);
            currentTemplateIndex = templates.length - 1;
            carouselData = newTemplate.carouselData;
            currentTabIndex = 0;
            
            document.querySelector('.editor-title').textContent = 'üìù ' + templateName;
            
            renderTemplateList();
            updateTabs();
            updatePreview();
        }

        // Âà™Èô§Ê®°Êùø
        async function deleteTemplate(index) {
            if (templates.length <= 1) {
                alert('Ëá≥Â∞ëÈúÄË¶Å‰øùÁïô‰∏ÄÂÄãÊ®°Êùø');
                return;
            }
            
            if (!confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§Ê®°Êùø "' + templates[index].name + '" ÂóéÔºü')) {
                return;
            }

            const templateToDelete = templates[index];
            
            // Â¶ÇÊûúÊúâ template_idÔºåÂæûË≥áÊñôÂ∫´Âà™Èô§
            if (templateToDelete.id && !templateToDelete.id.startsWith('temp_')) {
                try {
                    const response = await fetch('/api/flex-templates/' + templateToDelete.id, {
                        method: 'DELETE'
                    });
                    const result = await response.json();
                    if (!result.success) {
                        console.error('Delete template failed:', result.error);
                    }
                } catch (error) {
                    console.error('Delete template error:', error);
                }
            }
            
            templates.splice(index, 1);
            
            // Ë™øÊï¥Áï∂ÂâçÈÅ∏‰∏≠ÁöÑÊ®°ÊùøÁ¥¢Âºï
            if (currentTemplateIndex >= templates.length) {
                currentTemplateIndex = templates.length - 1;
            } else if (currentTemplateIndex >= index && currentTemplateIndex > 0) {
                currentTemplateIndex--;
            }
            
            // ÂàáÊèõÂà∞Ë™øÊï¥ÂæåÁöÑÊ®°Êùø
            if (templates.length > 0) {
                carouselData = templates[currentTemplateIndex].carouselData;
                document.querySelector('.editor-title').textContent = 'üìù ' + templates[currentTemplateIndex].name;
                document.getElementById('template-title').value = templates[currentTemplateIndex].name;
            }
            
            renderTemplateList();
            updateTabs();
            updatePreview();
        }

        // ËºâÂÖ•È†êË®≠Ê®°ÊùøÔºà‰øùÁïôÂêëÂæåÂÖºÂÆπÔºâ
        function loadDefaultTemplate() {
            // ÈÄôÂÄãÂáΩÊï∏ÁèæÂú®‰∏ªË¶ÅÁî®ÊñºÂêëÂæåÂÖºÂÆπ
            // ÂØ¶ÈöõÁöÑÊ®°ÊùøËºâÂÖ•Âú® init() ‰∏≠ËôïÁêÜ
        }

        // Êõ¥Êñ∞ÂàÜÈ†ÅÊ®ôÁ±§
        function updateTabs() {
            const tabsContainer = document.getElementById('carousel-tabs');
            let html = '';
            
            carouselData.contents.forEach((bubble, index) => {
                const isActive = index === currentTabIndex;
                const title = getBubbleTitle(bubble, index);
                html += '<button class="tab-item' + (isActive ? ' active' : '') + '" onclick="selectTab('+index+')">';
                html += title;
                if (carouselData.contents.length > 1) {
                    html += '<span class="tab-close" onclick="event.stopPropagation(); removeTab('+index+')">√ó</span>';
                }
                html += '</button>';
            });
            
            tabsContainer.innerHTML = html;
            loadTabContent();
        }

        // ÂèñÂæóÊ∞£Ê≥°Ê®ôÈ°å
        function getBubbleTitle(bubble, index) {
            // Êü•Êâæ‰∏ªÊ®ôÈ°åÔºàÁ¨¨‰∏ÄÂÄã text ÂÖÉÁ¥†‰∏î weight ÁÇ∫ boldÔºâ
            const titleContent = bubble.body?.contents?.find(c => 
                c.type === 'text' && c.weight === 'bold'
            );
            
            if (titleContent?.text) {
                return titleContent.text.length > 8 ? 
                    titleContent.text.substring(0, 8) + '...' : 
                    titleContent.text;
            }
            
            return 'ÂàÜÈ†Å ' + (index + 1);
        }

        // ÈÅ∏ÊìáÂàÜÈ†Å
        function selectTab(index) {
            if (index >= 0 && index < carouselData.contents.length) {
                currentTabIndex = index;
                updateTabs();
            }
        }

        // Êñ∞Â¢ûÂàÜÈ†Å
        function addNewTab() {
            const newBubble = JSON.parse(JSON.stringify(defaultBubbleTemplate));
            // ‰øÆÊîπÊ®ôÈ°åÁÇ∫Êñ∞ÁöÑÂàÜÈ†ÅÁ∑®Ëôü
            newBubble.body.contents[0].text = 'ÂàÜÈ†Å ' + (carouselData.contents.length + 1);
            
            carouselData.contents.push(newBubble);
            currentTabIndex = carouselData.contents.length - 1;
            
            // Êõ¥Êñ∞Â∞çÊáâÁöÑÊ®°Êùø
            templates[currentTemplateIndex].carouselData = carouselData;
            
            renderTemplateList();
            updateTabs();
            updatePreview();
        }

        // ÁßªÈô§ÂàÜÈ†Å
        function removeTab(index) {
            if (carouselData.contents.length > 1) {
                carouselData.contents.splice(index, 1);
                if (currentTabIndex >= carouselData.contents.length) {
                    currentTabIndex = carouselData.contents.length - 1;
                }
                if (currentTabIndex >= index && currentTabIndex > 0) {
                    currentTabIndex--;
                }
                
                // Êõ¥Êñ∞Â∞çÊáâÁöÑÊ®°Êùø
                templates[currentTemplateIndex].carouselData = carouselData;
                
                renderTemplateList();
                updateTabs();
                updatePreview();
            } else {
                alert('Ëá≥Â∞ëÈúÄË¶Å‰øùÁïô‰∏ÄÂÄãÂàÜÈ†Å');
            }
        }

        // ËºâÂÖ•ÂàÜÈ†ÅÂÖßÂÆπË°®ÂñÆ
        function loadTabContent() {
            const form = document.getElementById('content-form');
            const bubble = carouselData.contents[currentTabIndex];
            
            if (!bubble) return;
            
            let html = '';
            
            // ‰∏ªÂúñË®≠ÂÆö
            html += '<div class="form-section">';
            html += '<div class="section-title"><span class="section-icon">üñºÔ∏è</span>‰∏ªÂúñË®≠ÂÆö</div>';
            html += '<div class="form-group">';
            html += '<label class="form-label">ÂúñÁâá‰∏äÂÇ≥</label>';
            html += '<input type="file" class="form-input hero-upload" accept="image/*" onchange="uploadHeroImage(this)" style="margin-bottom: 5px;">';
            html += '<div class="upload-status" style="font-size: 12px; color: #666; margin-bottom: 5px;"></div>';
            html += '<img class="hero-preview" src="' + (bubble.hero?.url || '') + '" style="max-width: 100%; height: 100px; object-fit: cover; border-radius: 4px; display: ' + (bubble.hero?.url ? 'block' : 'none') + ';">';
            html += '</div>';
            html += '</div>';
            
            // ÂÖßÂÆπË®≠ÂÆö - ÊåâÈ†ÜÂ∫èÂÆöÁæ©ÂÖßÂÆπÂÖÉÁ¥†
            const body = bubble.body?.contents || [];
            const titleContent = body[0]; // ‰∏ªÊ®ôÈ°åÔºàÁ¨¨‰∏ÄÂÄãÂÖÉÁ¥†Ôºâ
            const subtitleContent = body.find(c => c.type === 'text' && c !== titleContent && c.color !== '#aaaaaa' && c.size !== 'xs' && !c.wrap); // ÂâØÊ®ôÈ°åÔºàÊôÆÈÄöÊñáÂ≠óÔºâ
            const buildingBox = body.find(c => c.type === 'box' && c.layout === 'vertical' && c.spacing === 'sm'); // Ê£üÂà•box
            const bottomContent = body.find(c => c.type === 'text' && c !== titleContent && c !== subtitleContent && c.wrap === true); // ‰∏ãÊñπÂÖßÂÆπÔºàÊúâwrapÁöÑÊñáÂ≠óÔºâ
            const dateContent = body.find(c => c.type === 'text' && c.color === '#aaaaaa' && c.size === 'xs'); // Êó•ÊúüË≥áË®äÔºàÁÅ∞Ëâ≤Â∞èÂ≠óÔºâ
            
            html += '<div class="form-section">';
            html += '<div class="section-title"><span class="section-icon">üìù</span>ÂÖßÂÆπË®≠ÂÆö</div>';
            html += '<div class="form-group">';
            html += '<label class="form-label">‰∏ªÊ®ôÈ°å</label>';
            html += '<input type="text" class="form-input" value="' + (titleContent?.text || '') + '" onchange="updateMainTitle(this.value)" placeholder="‰æãÔºöÂãùÁæé - Âª∫ÂäüÊÆµ">';
            html += '</div>';
            html += '<div class="form-group">';
            html += '<label class="form-label">ÂâØÊ®ôÈ°å</label>';
            html += '<input type="text" class="form-input" value="' + (subtitleContent?.text || '') + '" onchange="updateSubtitle(this.value)" placeholder="‰æãÔºöÂè∞ÂåóÂ∏Ç‰ø°Áæ©ÂçÄ">';
            html += '</div>';
            html += '<div class="form-group">';
            html += '<label class="form-label">‰∏ãÊñπÂÖßÂÆπ</label>';
            html += '<textarea class="form-textarea" onchange="updateBottomContent(this.value)" placeholder="‰æãÔºöÂ∑•Á®ãÈÄ≤Â∫¶Ë™™ÊòéÊàñÂÖ∂‰ªñË£úÂÖÖË≥áË®ä">' + (bottomContent?.text || '') + '</textarea>';
            html += '</div>';
            html += '<div class="form-group">';
            html += '<label class="form-label">Êó•ÊúüË≥áË®ä</label>';
            html += '<input type="text" class="form-input" value="' + (dateContent?.text || '') + '" onchange="updateDateInfo(this.value)" placeholder="‰æãÔºö2025-08-24 ÈÄ≤Â∫¶Â†±Âëä">';
            html += '</div>';
            html += '</div>';
            
            // ÊåâÈàïË®≠ÂÆö
            const buttons = bubble.footer?.contents || [];
            html += '<div class="form-section">';
            html += '<div class="section-title"><span class="section-icon">üîò</span>ÊåâÈàïË®≠ÂÆö</div>';
            buttons.forEach((button, index) => {
                html += '<div class="form-group" style="border: 1px solid #e1e8ed; padding: 10px; margin-bottom: 10px; border-radius: 4px;">';
                html += '<label class="form-label">ÊåâÈàï ' + (index + 1) + '</label>';
                html += '<input type="text" class="form-input" value="' + (button.action?.label || '') + '" onchange="updateButtonLabel(' + index + ', this.value)" placeholder="ÊåâÈàïÊñáÂ≠ó" style="margin-bottom: 5px;">';
                html += '<input type="url" class="form-input" value="' + (button.action?.uri || '') + '" onchange="updateButtonUri(' + index + ', this.value)" placeholder="ÊåâÈàïÈÄ£Áµê" style="margin-bottom: 5px;">';
                html += '<label class="form-label">ÊåâÈàïÈ°èËâ≤</label>';
                html += '<input type="text" class="form-input" value="' + (button.color || '#1976d2') + '" onchange="updateButtonColor(' + index + ', this.value)" placeholder="#ffffff" pattern="^#[0-9A-Fa-f]{6}$" style="margin-bottom: 5px;">';
                html += '<button type="button" class="template-delete-btn" onclick="removeButton(' + index + ')" style="margin-top: 5px;">Âà™Èô§ÊåâÈàï</button>';
                html += '</div>';
            });
            html += '<button type="button" class="btn" onclick="addButton()" style="background: #28a745; color: white; margin-right: 10px;">+ Êñ∞Â¢ûÊåâÈàï</button>';
            html += '<button type="button" class="btn" onclick="addShareButton()" style="background: #00c851; color: white;">+ Êñ∞Â¢ûÂàÜ‰∫´ÊåâÈàï</button>';
            html += '</div>';
            
            form.innerHTML = html;
        }

        // Êõ¥Êñ∞‰∏ªÂúñ
        async function uploadHeroImage(input) {
            if (!input.files || input.files.length === 0) return;
            
            const file = input.files[0];
            const statusDiv = input.parentElement.querySelector('.upload-status');
            const preview = input.parentElement.querySelector('.hero-preview');
            
            console.log('ÈñãÂßã‰∏äÂÇ≥ÂúñÁâá:', file.name, 'Size:', file.size);
            statusDiv.textContent = '‰∏äÂÇ≥‰∏≠...';
            statusDiv.style.color = '#666';
            
            const formData = new FormData();
            formData.append('image', file);
            
            try {
                const response = await fetch('/api/upload-image', {
                    method: 'POST',
                    body: formData
                });
                
                console.log('‰∏äÂÇ≥ÂõûÊáâÁãÄÊÖã:', response.status);
                const result = await response.json();
                console.log('‰∏äÂÇ≥ÁµêÊûú:', result);
                
                if (result.success) {
                    const bubble = carouselData.contents[currentTabIndex];
                    if (!bubble.hero) {
                        bubble.hero = {
                            "type": "image",
                            "size": "full",
                            "aspectRatio": "20:13",
                            "aspectMode": "cover"
                        };
                    }
                    // API ÂõûÊáâÁöÑ URL Âú® data.publicUrl ‰∏≠
                    const imageUrl = result.data?.publicUrl || result.url;
                    bubble.hero.url = imageUrl;
                    templates[currentTemplateIndex].carouselData = carouselData;
                    console.log('Ë®≠ÂÆöÂúñÁâáURL:', imageUrl);
                    console.log('Êõ¥Êñ∞ÂæåÁöÑheroÂ∞çË±°:', bubble.hero);
                    
                    // Êõ¥Êñ∞È†êË¶ΩÂúñÁâá
                    if (preview) {
                        preview.src = imageUrl;
                        preview.style.display = 'block';
                        console.log('Êõ¥Êñ∞È†êË¶ΩÂúñÁâáÂÖÉÁ¥†:', preview.src);
                    }
                    
                    statusDiv.textContent = '‰∏äÂÇ≥ÊàêÂäü: ' + imageUrl;
                    statusDiv.style.color = '#28a745';
                    
                    // Êõ¥Êñ∞È†êË¶ΩÂçÄ
                    updatePreview();
                    console.log('ÂëºÂè´updatePreviewÂÆåÊàê');
                } else {
                    statusDiv.textContent = '‰∏äÂÇ≥Â§±Êïó: ' + result.error;
                    statusDiv.style.color = '#dc3545';
                }
            } catch (error) {
                console.error('‰∏äÂÇ≥ÈåØË™§:', error);
                statusDiv.textContent = '‰∏äÂÇ≥Â§±Êïó: ' + error.message;
                statusDiv.style.color = '#dc3545';
            }
        }

        function updateHeroImage(url) {
            const bubble = carouselData.contents[currentTabIndex];
            if (bubble.hero) {
                bubble.hero.url = url;
                templates[currentTemplateIndex].carouselData = carouselData;
                updatePreview();
            }
        }


        // Êõ¥Êñ∞‰∏ªÊ®ôÈ°å
        function updateMainTitle(text) {
            const bubble = carouselData.contents[currentTabIndex];
            const titleContent = bubble.body.contents.find(c => c.type === 'text' && c.weight === 'bold');
            if (titleContent) {
                titleContent.text = text;
                templates[currentTemplateIndex].carouselData = carouselData;
                updateTabs();
                updatePreview();
            }
        }

        // Êõ¥Êñ∞Êó•ÊúüË≥áË®ä
        function updateDateInfo(text) {
            const bubble = carouselData.contents[currentTabIndex];
            let dateContent = bubble.body.contents.find(c => c.type === 'text' && c.color === '#aaaaaa' && c.size === 'xs');
            
            if (!dateContent && text) {
                // Â¶ÇÊûú‰∏çÂ≠òÂú®Êó•ÊúüË≥áË®äÂÖÉÁ¥†ÔºåÂú®ÊúÄÂæåÂâµÂª∫‰∏ÄÂÄã
                dateContent = {
                    "type": "text",
                    "text": text,
                    "wrap": true,
                    "color": "#aaaaaa",
                    "size": "xs"
                };
                bubble.body.contents.push(dateContent);
            } else if (dateContent) {
                if (text) {
                    dateContent.text = text;
                } else {
                    // Â¶ÇÊûúÊñáÂ≠óÁÇ∫Á©∫ÔºåÁßªÈô§Êó•ÊúüË≥áË®ä
                    const index = bubble.body.contents.indexOf(dateContent);
                    if (index > -1) {
                        bubble.body.contents.splice(index, 1);
                    }
                }
            }
            
            templates[currentTemplateIndex].carouselData = carouselData;
            updatePreview();
        }

        // Êõ¥Êñ∞ÂâØÊ®ôÈ°å
        function updateSubtitle(text) {
            const bubble = carouselData.contents[currentTabIndex];
            let subtitleContent = bubble.body.contents.find(c => c.type === 'text' && c !== bubble.body.contents[0] && c.color !== '#aaaaaa' && c.size !== 'xs' && !c.wrap);
            
            if (!subtitleContent && text) {
                // Â¶ÇÊûú‰∏çÂ≠òÂú®ÂâØÊ®ôÈ°åÂÖÉÁ¥†ÔºåÂú®‰∏ªÊ®ôÈ°åÂæåÂâµÂª∫‰∏ÄÂÄã
                subtitleContent = {
                    "type": "text",
                    "text": text,
                    "size": "sm",
                    "color": "#666666",
                    "margin": "sm"
                };
                // ÊâæÂà∞Ê£üÂà•boxÁöÑ‰ΩçÁΩÆÔºåÊèíÂÖ•Âà∞ÂâçÈù¢ÔºåÂ¶ÇÊûúÊ≤íÊúâÂâáÊèíÂÖ•Âà∞‰ΩçÁΩÆ1
                const buildingBoxIndex = bubble.body.contents.findIndex(c => c.type === 'box' && c.layout === 'vertical');
                const insertIndex = buildingBoxIndex > -1 ? buildingBoxIndex : 1;
                bubble.body.contents.splice(insertIndex, 0, subtitleContent);
                console.log('Ê∑ªÂä†ÂâØÊ®ôÈ°åÂà∞‰ΩçÁΩÆ:', insertIndex, 'ÂÖßÂÆπ:', text);
            } else if (subtitleContent) {
                if (text) {
                    subtitleContent.text = text;
                    console.log('Êõ¥Êñ∞ÂâØÊ®ôÈ°åÂÖßÂÆπ:', text);
                } else {
                    // Â¶ÇÊûúÊñáÂ≠óÁÇ∫Á©∫ÔºåÁßªÈô§ÂâØÊ®ôÈ°å
                    const index = bubble.body.contents.indexOf(subtitleContent);
                    if (index > -1) {
                        bubble.body.contents.splice(index, 1);
                        console.log('ÁßªÈô§ÂâØÊ®ôÈ°å');
                    }
                }
            }
            
            templates[currentTemplateIndex].carouselData = carouselData;
            updatePreview();
        }

        // Êõ¥Êñ∞‰∏ãÊñπÂÖßÂÆπ
        function updateBottomContent(text) {
            const bubble = carouselData.contents[currentTabIndex];
            let bottomContent = bubble.body.contents.find(c => c.type === 'text' && c.wrap === true);
            
            if (!bottomContent && text) {
                // Â¶ÇÊûú‰∏çÂ≠òÂú®‰∏ãÊñπÂÖßÂÆπÂÖÉÁ¥†ÔºåÂú®Êó•ÊúüË≥áË®äÂâçÂâµÂª∫‰∏ÄÂÄã
                bottomContent = {
                    "type": "text",
                    "text": text,
                    "size": "sm",
                    "wrap": true,
                    "margin": "md"
                };
                
                // ÊâæÂà∞Êó•ÊúüË≥áË®äÁöÑ‰ΩçÁΩÆÔºåÊèíÂÖ•Âà∞ÂâçÈù¢
                const dateIndex = bubble.body.contents.findIndex(c => c.type === 'text' && c.color === '#aaaaaa' && c.size === 'xs');
                if (dateIndex > -1) {
                    bubble.body.contents.splice(dateIndex, 0, bottomContent);
                    console.log('Ê∑ªÂä†‰∏ãÊñπÂÖßÂÆπÂà∞Êó•ÊúüË≥áË®äÂâçÔºå‰ΩçÁΩÆ:', dateIndex, 'ÂÖßÂÆπ:', text);
                } else {
                    bubble.body.contents.push(bottomContent);
                    console.log('Ê∑ªÂä†‰∏ãÊñπÂÖßÂÆπÂà∞ÊúÄÂæåÔºåÂÖßÂÆπ:', text);
                }
            } else if (bottomContent) {
                if (text) {
                    bottomContent.text = text;
                } else {
                    // Â¶ÇÊûúÊñáÂ≠óÁÇ∫Á©∫ÔºåÁßªÈô§‰∏ãÊñπÂÖßÂÆπ
                    const index = bubble.body.contents.indexOf(bottomContent);
                    if (index > -1) {
                        bubble.body.contents.splice(index, 1);
                    }
                }
            }
            
            templates[currentTemplateIndex].carouselData = carouselData;
            updatePreview();
        }

        // Êõ¥Êñ∞Ê£üÂà•ÂêçÁ®±
        function updateBuildingName(index, name) {
            const bubble = carouselData.contents[currentTabIndex];
            const buildingBox = bubble.body.contents.find(c => c.type === 'box' && c.layout === 'vertical' && c.spacing === 'sm');
            if (buildingBox?.contents?.[index]?.type === 'box') {
                const buildingNameText = buildingBox.contents[index].contents.find(c => c.type === 'text' && c.weight === 'bold');
                if (buildingNameText) {
                    buildingNameText.text = name;
                    templates[currentTemplateIndex].carouselData = carouselData;
                    updatePreview();
                }
            }
        }

        // Êõ¥Êñ∞Ê£üÂà•ÁôæÂàÜÊØî
        function updateBuildingPercentage(index, percentage) {
            const bubble = carouselData.contents[currentTabIndex];
            const buildingBox = bubble.body.contents.find(c => c.type === 'box' && c.layout === 'vertical' && c.spacing === 'sm');
            if (buildingBox?.contents?.[index]?.type === 'box') {
                const percentageText = buildingBox.contents[index].contents.find(c => c.type === 'text' && c.align === 'end');
                if (percentageText) {
                    percentageText.text = percentage;
                    templates[currentTemplateIndex].carouselData = carouselData;
                    updatePreview();
                }
            }
        }

        // Êñ∞Â¢ûÊ£üÂà•
        function addBuilding() {
            const bubble = carouselData.contents[currentTabIndex];
            const buildingBox = bubble.body.contents.find(c => c.type === 'box' && c.layout === 'vertical' && c.spacing === 'sm');
            if (buildingBox) {
                const newBuilding = {
                    "type": "box",
                    "layout": "baseline",
                    "contents": [
                        {
                            "type": "icon",
                            "url": "https://developers-resource.landpress.line.me/fx/img/restaurant_regular_32.png"
                        },
                        {
                            "type": "text",
                            "text": "Êñ∞Ê£üÂà•",
                            "weight": "bold",
                            "margin": "sm",
                            "flex": 0
                        },
                        {
                            "type": "text",
                            "text": "0%",
                            "size": "sm",
                            "align": "end",
                            "color": "#aaaaaa"
                        }
                    ]
                };
                buildingBox.contents.push(newBuilding);
                templates[currentTemplateIndex].carouselData = carouselData;
                loadTabContent();
                updatePreview();
            }
        }

        // Êõ¥Êñ∞ÊåâÈàïÊ®ôÁ±§
        function updateButtonLabel(index, label) {
            const bubble = carouselData.contents[currentTabIndex];
            const button = bubble.footer?.contents?.[index];
            if (button?.action) {
                button.action.label = label;
                templates[currentTemplateIndex].carouselData = carouselData;
                updatePreview();
            }
        }

        // Êõ¥Êñ∞ÊåâÈàïÈÄ£Áµê
        function updateButtonUri(index, uri) {
            const bubble = carouselData.contents[currentTabIndex];
            const button = bubble.footer?.contents?.[index];
            if (button?.action) {
                button.action.uri = uri;
                templates[currentTemplateIndex].carouselData = carouselData;
                updatePreview();
            }
        }

        // Êñ∞Â¢ûÊåâÈàï
        function addButton() {
            const bubble = carouselData.contents[currentTabIndex];
            if (!bubble.footer) {
                bubble.footer = {
                    "type": "box",
                    "layout": "vertical",
                    "contents": [],
                    "paddingAll": "md",
                    "paddingTop": "none"
                };
            }
            
            const newButton = {
                "type": "button",
                "action": {
                    "type": "uri",
                    "label": "Êñ∞ÊåâÈàï",
                    "uri": "https://line.me/"
                },
                "style": "secondary",
                "margin": "md"
            };
            
            bubble.footer.contents.push(newButton);
            templates[currentTemplateIndex].carouselData = carouselData;
            loadTabContent();
            updatePreview();
        }

        // ÁßªÈô§Ê£üÂà•
        function removeBuilding(index) {
            const bubble = carouselData.contents[currentTabIndex];
            const buildingBox = bubble.body.contents.find(c => c.type === 'box' && c.layout === 'vertical' && c.spacing === 'sm');
            if (buildingBox?.contents?.[index]) {
                buildingBox.contents.splice(index, 1);
                templates[currentTemplateIndex].carouselData = carouselData;
                loadTabContent();
                updatePreview();
            }
        }

        // ÁßªÈô§ÊåâÈàï
        function removeButton(index) {
            const bubble = carouselData.contents[currentTabIndex];
            if (bubble.footer?.contents) {
                bubble.footer.contents.splice(index, 1);
                templates[currentTemplateIndex].carouselData = carouselData;
                loadTabContent();
                updatePreview();
            }
        }

        // Êõ¥Êñ∞ÊåâÈàïÈ°èËâ≤
        function updateButtonColor(index, color) {
            const bubble = carouselData.contents[currentTabIndex];
            if (bubble.footer?.contents?.[index]) {
                bubble.footer.contents[index].color = color;
                templates[currentTemplateIndex].carouselData = carouselData;
                updatePreview();
            }
        }

        // Êñ∞Â¢ûÂàÜ‰∫´ÊåâÈàï
        function addShareButton() {
            const bubble = carouselData.contents[currentTabIndex];
            if (!bubble.footer) {
                bubble.footer = {
                    "type": "box",
                    "layout": "horizontal",
                    "contents": []
                };
            }
            
            const shareButton = {
                "type": "button",
                "action": {
                    "type": "uri",
                    "label": "ÂàÜ‰∫´",
                    "uri": "https://line-bot-pusher.pages.dev/liff-share?template=" + templates[currentTemplateIndex].id
                },
                "style": "primary",
                "color": "#00c851"
            };
            
            bubble.footer.contents.push(shareButton);
            templates[currentTemplateIndex].carouselData = carouselData;
            loadTabContent();
            updatePreview();
        }

        // Êõ¥Êñ∞Ê∞£Ê≥°ÊñáÂ≠óÂÖßÂÆπ
        function updateBubbleText(type, value) {
            const bubble = carouselData.contents[currentTabIndex];
            if (!bubble.body?.contents) return;
            
            const contents = bubble.body.contents;
            
            if (type === 'title') {
                const titleItem = contents.find(c => c.weight === 'bold');
                if (titleItem) {
                    titleItem.text = value;
                } else {
                    contents.unshift({
                        type: 'text',
                        text: value,
                        wrap: true,
                        weight: 'bold',
                        size: 'xl'
                    });
                }
            } else if (type === 'subtitle') {
                let subtitleItem = contents.find(c => c.size === 'sm' && c.color === '#666666');
                if (subtitleItem) {
                    subtitleItem.text = value;
                } else {
                    const titleIndex = contents.findIndex(c => c.weight === 'bold');
                    contents.splice(titleIndex + 1, 0, {
                        type: 'text',
                        text: value,
                        wrap: true,
                        size: 'sm',
                        color: '#666666'
                    });
                }
            }
            
            updateTabs();
            updatePreview();
        }

        // Êõ¥Êñ∞È†êË¶Ω
        // ËÆäÊï∏ÊõøÊèõÂáΩÊï∏
        function replaceVariables(text, context = {}) {
            if (!text || typeof text !== 'string') return text;
            
            let result = text;
            currentVariables.forEach(variable => {
                const pattern = new RegExp(`{{${variable.code}}}`, 'g');
                
                // ÁâπÊÆäËôïÁêÜÊ£üÂà•ÈÄ≤Â∫¶
                if (variable.code === 'building_progress' && context.isBuildingContext) {
                    // Ëß£ÊûêÊñáÂ≠óÊ†ºÂºèÔºöAÊ£ü 95% BÊ£ü 80% CÊ£ü 60%
                    const buildingText = variable.defaultValue;
                    const buildingMatches = buildingText.match(/(\S+Ê£ü)\s+(\d+%)/g) || [];
                    const buildings = buildingMatches.map(match => {
                        const parts = match.trim().split(/\s+/);
                        return {
                            name: parts[0],
                            progress: parts[1] || '0%'
                        };
                    });
                    
                    if (buildings.length > 0 && context.buildingIndex !== undefined) {
                        const building = buildings[context.buildingIndex];
                        if (building) {
                            if (context.isNameField) {
                                result = result.replace(pattern, building.name);
                            } else if (context.isProgressField) {
                                result = result.replace(pattern, building.progress);
                            }
                        }
                    } else {
                        result = result.replace(pattern, variable.defaultValue);
                    }
                } else {
                    result = result.replace(pattern, variable.defaultValue);
                }
            });
            
            return result;
        }

        function updatePreview() {
            const container = document.getElementById('carousel-preview');
            let html = '';
            
            carouselData.contents.forEach((bubble, index) => {
                const hero = bubble.hero;
                const body = bubble.body?.contents || [];
                const titleContent = body.find(c => c.type === 'text' && c.weight === 'bold');
                const title = replaceVariables(titleContent?.text) || 'ÂàÜÈ†Å ' + (index + 1);
                const buildingBox = body.find(c => c.type === 'box' && c.layout === 'vertical' && c.spacing === 'sm');
                const dateContent = body.find(c => c.type === 'text' && c.color === '#aaaaaa' && c.size === 'xs');
                const buttons = bubble.footer?.contents || [];
                
                html += '<div class="bubble-preview' + (index === currentTabIndex ? ' active' : '') + '">';
                
                // ‰∏ªÂúñ
                if (hero?.url) {
                    html += '<img src="' + hero.url + '" class="bubble-image" alt="ÂúñÁâá">';
                } else {
                    html += '<div class="bubble-image" style="display: flex; align-items: center; justify-content: center; background: #f0f0f0; color: #999;">ÁÑ°ÂúñÁâá</div>';
                }
                
                // ÂÖßÂÆπÂçÄÂüü
                html += '<div class="bubble-content">';
                html += '<div class="bubble-title">' + title + '</div>';
                
                // ÂâØÊ®ôÈ°å
                const subtitleContent = body.find(c => c.type === 'text' && c !== body[0] && c.color !== '#aaaaaa' && c.size !== 'xs' && !c.wrap);
                if (subtitleContent?.text) {
                    html += '<div style="font-size: 12px; color: #666; margin-top: 4px;">' + replaceVariables(subtitleContent.text) + '</div>';
                }
                
                // Ê£üÂà•Ë≥áË®ä
                if (buildingBox?.contents) {
                    html += '<div style="margin: 8px 0;">';
                    buildingBox.contents.forEach((building, buildingIndex) => {
                        if (building.type === 'box' && building.layout === 'baseline') {
                            const buildingNameText = building.contents.find(c => c.type === 'text' && c.weight === 'bold')?.text || '';
                            const percentageText = building.contents.find(c => c.type === 'text' && c.align === 'end')?.text || '';
                            
                            // ‰ΩøÁî®context‰æÜËôïÁêÜÊ£üÂà•ÈÄ≤Â∫¶ËÆäÊï∏
                            const buildingName = replaceVariables(buildingNameText, {
                                isBuildingContext: true,
                                buildingIndex: buildingIndex,
                                isNameField: true
                            });
                            
                            const percentage = replaceVariables(percentageText, {
                                isBuildingContext: true,
                                buildingIndex: buildingIndex,
                                isProgressField: true
                            });
                            
                            html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; padding: 6px 0; font-size: 15px; border-bottom: 1px solid #f0f0f0;">';
                            html += '<span style="font-weight: bold; color: #333;">' + buildingName + '</span>';
                            html += '<span style="font-weight: bold; color: #667eea; text-align: right;">' + percentage + '</span>';
                            html += '</div>';
                        }
                    });
                    html += '</div>';
                }
                
                // ‰∏ãÊñπÂÖßÂÆπ
                const bottomContent = body.find(c => c.type === 'text' && c.wrap === true);
                if (bottomContent?.text) {
                    html += '<div style="font-size: 11px; color: #555; margin-top: 6px; line-height: 1.3;">' + replaceVariables(bottomContent.text) + '</div>';
                }
                
                // Êó•ÊúüË≥áË®ä
                if (dateContent?.text) {
                    html += '<div style="font-size: 11px; color: #aaa; margin-top: 8px;">' + replaceVariables(dateContent.text) + '</div>';
                }
                
                html += '</div>';
                
                // ÊåâÈàï
                if (buttons.length > 0) {
                    html += '<div class="bubble-buttons">';
                    buttons.forEach((btn, btnIndex) => {
                        const btnClass = btn.style === 'primary' ? 'bubble-button' : 'bubble-button secondary';
                        const btnStyle = btn.color ? 'background-color: ' + btn.color + ';' : '';
                        const buttonLabel = replaceVariables(btn.action?.label) || 'ÊåâÈàï';
                        html += '<button class="' + btnClass + '" style="' + btnStyle + '">' + buttonLabel + '</button>';
                    });
                    html += '</div>';
                }
                
                html += '</div>';
            });
            
            container.innerHTML = html;
        }

        // Â∑•ÂÖ∑ÂàóÂäüËÉΩ
        function loadProject() {
            alert('Âª∫Ê°àËºâÂÖ•ÂäüËÉΩÈñãÁôº‰∏≠...');
        }

        function showJsonPreview() {
            const jsonWindow = window.open('', '_blank', 'width=800,height=600');
            const jsonString = JSON.stringify(carouselData, null, 2);
            const jsonEscaped = jsonString.replace(/'/g, "\\'");
            
            jsonWindow.document.write(
                '<html><head><title>Flex Carousel JSON</title></head>' +
                '<body style="font-family: monospace; padding: 20px;">' +
                '<h3>ÁîüÊàêÁöÑ Flex Carousel JSON</h3>' +
                '<pre style="background: #f5f5f5; padding: 15px; border-radius: 8px; overflow: auto; white-space: pre-wrap; max-height: 80vh;">' +
                jsonString +
                '</pre><br>' +
                '<button onclick="navigator.clipboard.writeText(\'' + jsonEscaped + '\'); alert(\'JSON Â∑≤Ë§áË£ΩÂà∞Ââ™Ë≤ºÁ∞ø!\');" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer;">üìã Ë§áË£Ω JSON</button>' +
                '<button onclick="window.close();" style="margin-left: 10px; padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer;">‚úï ÈóúÈñâ</button>' +
                '</body></html>'
            );
        }

        function previewInNewWindow() {
            alert('È†êË¶ΩÂäüËÉΩÈñãÁôº‰∏≠...');
        }

        async function saveTemplate() {
            if (templates.length === 0) return;
            
            const currentTemplate = templates[currentTemplateIndex];
            
            try {
                const response = await fetch('/api/flex-templates', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        template_name: currentTemplate.name,
                        description: 'ÂÖ±' + carouselData.contents.length + 'ÂÄãÂàÜÈ†Å',
                        template_type: 'carousel',
                        flex_content: JSON.stringify(carouselData),
                        category: 'custom'
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    // Êõ¥Êñ∞Ê®°Êùø ID
                    currentTemplate.id = result.template_id;
                    alert('Ê®°ÊùøÂÑ≤Â≠òÊàêÂäü!');
                    // ÈáçÊñ∞ËºâÂÖ•Ê®°ÊùøÂàóË°®
                    await loadTemplates();
                } else {
                    alert('ÂÑ≤Â≠òÂ§±ÊïóÔºö' + result.error);
                }
            } catch (error) {
                alert('ÂÑ≤Â≠òÂá∫ÈåØÔºö' + error.message);
            }
        }

        // ËºâÂÖ•ÁèæÊúâÊ®°Êùø
        async function loadExistingTemplate(templateId) {
            try {
                const response = await fetch('/api/flex-templates/' + templateId);
                const data = await response.json();
                
                if (data.success && data.template) {
                    const template = data.template;
                    document.querySelector('.editor-title').textContent = 'üì± Á∑®ËºØÊ®°Êùø: ' + template.template_name;
                    
                    const flexContent = JSON.parse(template.flex_content);
                    if (flexContent.type === 'carousel') {
                        carouselData = flexContent;
                    }
                    
                    if (template.category) {
                        currentCategory = template.category;
                    }
                    
                    currentTabIndex = 0;
                    updateTabs();
                    updatePreview();
                } else {
                    alert('ËºâÂÖ•Ê®°ÊùøÂ§±Êïó: ' + (data.error || 'Ê®°Êùø‰∏çÂ≠òÂú®'));
                }
            } catch (error) {
                console.error('ËºâÂÖ•Ê®°ÊùøÈåØË™§:', error);
                alert('ËºâÂÖ•Ê®°ÊùøÊôÇÁôºÁîüÈåØË™§');
            }
        }

        // ÂàÜÈ†ÅÂàáÊèõÂäüËÉΩ
        function switchPanelTab(tabName) {
            // Êõ¥Êñ∞Ê®ôÁ±§ÁãÄÊÖã
            document.querySelectorAll('.panel-tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById('tab-' + tabName).classList.add('active');
            
            // Êõ¥Êñ∞ÂÖßÂÆπÈ°ØÁ§∫
            document.querySelectorAll('.panel-content').forEach(content => content.style.display = 'none');
            document.getElementById('panel-' + tabName).style.display = 'block';
            
            if (tabName === 'variables') {
                renderVariablesList();
            }
        }

        // ËÆäÊï∏ÁÆ°ÁêÜÁõ∏ÈóúÂáΩÊï∏
        let currentVariables = [
            {
                name: 'Â∞àÊ°àÂêçÁ®±',
                code: 'project_name',
                defaultValue: 'ÂãùÁæé-Âª∫ÂäüÊÆµ',
                description: 'Âª∫Ê°àÂ∞àÊ°àÂêçÁ®±'
            },
            {
                name: 'Ê£üÂà•ÈÄ≤Â∫¶',
                code: 'building_progress',
                defaultValue: 'AÊ£ü 95% BÊ£ü 80% CÊ£ü 60%',
                description: 'ÂêÑÊ£üÂà•ÊñΩÂ∑•ÈÄ≤Â∫¶'
            },
            {
                name: '‰ªäÊó•ÈÄ≤Â∫¶',
                code: 'today_progress',
                defaultValue: 'ÈãºÁ≠ãÁ∂ÅÁ¥ÆÂÆåÊàê',
                description: 'Áï∂Êó•Â∑•‰ΩúÈÄ≤Â∫¶'
            },
            {
                name: 'Ê°àÂ†¥Ë≤†Ë≤¨‰∫∫',
                code: 'site_manager',
                defaultValue: 'ÁéãÂª∫ÁØâÂ∏´',
                description: 'Ê°àÂ†¥Ë≤†Ë≤¨‰∫∫ÂßìÂêç'
            },
            {
                name: 'ËÅØÁµ°ÈõªË©±',
                code: 'contact_phone',
                defaultValue: '02-1234-5678',
                description: 'Ê°àÂ†¥ËÅØÁµ°ÈõªË©±'
            },
            {
                name: '‰ªäÂ§©Êó•Êúü',
                code: 'today_date',
                defaultValue: new Date().toLocaleDateString('zh-TW'),
                description: '‰ªäÂ§©ÁöÑÊó•Êúü'
            }
        ];

        function renderVariablesList() {
            const container = document.getElementById('variables-list');
            let html = '';
            
            currentVariables.forEach((variable, index) => {
                html += `
                    <div class="variable-item">
                        <div class="variable-item-header">
                            <div>
                                <span class="variable-name">${variable.name}</span>
                                <span class="variable-code">{{${variable.code}}}</span>
                            </div>
                            <button class="copy-variable-btn" onclick="copyVariableCode('${variable.code}')" title="Ë§áË£ΩËÆäÊï∏‰ª£Á¢º">
                                üìã Ë§áË£Ω
                            </button>
                        </div>
                        <input type="text" 
                               class="variable-input" 
                               value="${variable.defaultValue}"
                               placeholder="${variable.description}"
                               onchange="updateVariableValue('${variable.code}', this.value)"
                               id="var-${variable.code}">
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function updateVariableValue(code, value) {
            const variable = currentVariables.find(v => v.code === code);
            if (variable) {
                variable.defaultValue = value;
                updatePreview(); // Êõ¥Êñ∞È†êË¶ΩÔºåÂ•óÁî®Êñ∞ÁöÑËÆäÊï∏ÂÄº
            }
        }

        function copyVariableCode(code) {
            const variableText = `{{${code}}}`;
            navigator.clipboard.writeText(variableText).then(() => {
                showToast(`ËÆäÊï∏ {{${code}}} Â∑≤Ë§áË£ΩÂà∞Ââ™Ë≤ºÁ∞øÔºÅ`);
            }).catch(err => {
                console.error('Ë§áË£ΩÂ§±Êïó:', err);
                // ÂÇôÁî®ÊñπÊ°à
                const textArea = document.createElement('textarea');
                textArea.value = variableText;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showToast(`ËÆäÊï∏ {{${code}}} Â∑≤Ë§áË£ΩÂà∞Ââ™Ë≤ºÁ∞øÔºÅ`);
            });
        }

        function showToast(message) {
            // ÁßªÈô§ÁèæÊúâÁöÑ toast
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }

            // Âª∫Á´ãÊñ∞ÁöÑ toast
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);

            // È°ØÁ§∫ÂãïÁï´
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);

            // 3ÁßíÂæåÈö±Ëóè
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }

        // È†ÅÈù¢ËºâÂÖ•ÊôÇÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>