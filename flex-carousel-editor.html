<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flex Carousel 編輯器 - 房地產專用</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            height: 100vh;
            overflow: hidden;
        }

        /* 頭部工具列 */
        .editor-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        .editor-title {
            font-size: 20px;
            font-weight: bold;
        }

        .editor-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 14px;
        }

        .btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .btn-primary {
            background: rgba(255,255,255,0.9);
            color: #667eea;
            font-weight: 500;
        }

        /* 主要編輯區域 */
        .editor-main {
            display: flex;
            height: calc(100vh - 70px);
        }

        /* 左側模板選擇面板 */
        .template-panel {
            width: 320px;
            background: white;
            border-right: 1px solid #e1e8ed;
            display: flex;
            flex-direction: column;
        }

        .panel-header {
            padding: 20px;
            border-bottom: 1px solid #e1e8ed;
            background: #f8f9fa;
        }

        .panel-title {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        /* 面板標籤 */
        .panel-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #e1e8ed;
        }

        .panel-tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
            font-size: 14px;
            background: transparent;
            border: none;
        }

        .panel-tab.active {
            background: white;
            border-bottom-color: #667eea;
            color: #667eea;
            font-weight: bold;
        }

        .panel-tab:hover {
            background: #e9ecef;
        }

        /* 新的變數管理樣式 */
        .variable-floating-panel {
            position: fixed;
            top: 70px;
            right: 20px;
            width: 350px;
            max-height: calc(100vh - 100px);
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            z-index: 1000;
            overflow: hidden;
        }

        .variable-panel-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .variable-panel-header h4 {
            margin: 0;
            font-size: 16px;
        }

        .variable-panel-content {
            padding: 20px;
            max-height: calc(100vh - 180px);
            overflow-y: auto;
        }

        .variable-section-title {
            font-size: 14px;
            font-weight: bold;
            color: #333;
            margin: 20px 0 10px 0;
            padding-bottom: 5px;
            border-bottom: 2px solid #e9ecef;
        }

        .variable-row {
            margin-bottom: 15px;
        }

        .variable-row label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: #555;
            margin-bottom: 5px;
        }

        .variable-input-group {
            display: flex;
            gap: 5px;
        }

        .variable-input-group input,
        .variable-input-group textarea {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .variable-input-group textarea {
            min-height: 60px;
            max-height: 120px;
        }

        .insert-var-btn {
            padding: 8px 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            white-space: nowrap;
        }

        .insert-var-btn:hover {
            background: #5a67d8;
        }

        /* 表格編輯器樣式 */
        .table-editor-header {
            margin-bottom: 10px;
        }

        .add-row-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .add-row-btn:hover {
            background: #218838;
        }

        .table-editor {
            border: 1px solid #e1e8ed;
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .table-row {
            display: flex;
            border-bottom: 1px solid #e1e8ed;
            background: white;
        }

        .table-row:last-child {
            border-bottom: none;
        }

        .table-row:nth-child(even) {
            background: #f8f9fa;
        }

        .table-cell {
            flex: 1;
            padding: 8px 12px;
            border-right: 1px solid #e1e8ed;
            display: flex;
            align-items: center;
        }

        .table-cell:last-child {
            border-right: none;
        }

        .table-cell input {
            width: 100%;
            border: none;
            background: transparent;
            font-size: 13px;
            padding: 2px;
        }

        .table-cell input:focus {
            outline: 1px solid #667eea;
            border-radius: 2px;
        }

        .table-cell-header {
            background: #f1f3f4;
            font-weight: 600;
            font-size: 12px;
            color: #333;
        }

        .delete-row-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
        }

        .delete-row-btn:hover {
            background: #c82333;
        }

        /* 變數模式指示器 */
        .variable-mode-active {
            background: #28a745 !important;
            color: white !important;
            border-color: #28a745 !important;
        }

        /* 變數高亮樣式 */
        .variable-highlight {
            background-color: #e7f3ff;
            color: #1976d2;
            padding: 2px 4px;
            border-radius: 3px;
            font-weight: bold;
        }

        /* 插入變數按鈕 */
        .insert-variable-btn {
            background: #f8f9fa;
            border: 1px solid #ddd;
            color: #667eea;
            font-size: 12px;
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            margin-left: 5px;
        }

        .insert-variable-btn:hover {
            background: #667eea;
            color: white;
        }

        /* 變數值編輯區樣式 */
        .variable-values-section h5 {
            margin-bottom: 15px;
            color: #333;
        }

        .variable-editor-row {
            margin-bottom: 15px;
            padding: 12px;
            border: 1px solid #e1e8ed;
            border-radius: 6px;
            background: #f8f9fa;
        }

        .variable-editor-label {
            font-size: 13px;
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
            display: block;
        }

        .variable-editor-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }

        .variable-editor-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }

        /* 複雜變數編輯器 */
        .complex-variable-editor {
            margin-top: 10px;
        }

        .complex-editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .complex-editor-title {
            font-size: 12px;
            font-weight: bold;
            color: #666;
        }

        .add-item-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
        }

        .add-item-btn:hover {
            background: #218838;
        }

        .complex-item {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            align-items: center;
        }

        .complex-item input {
            flex: 1;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 12px;
        }

        .remove-item-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 4px 6px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 10px;
        }

        .remove-item-btn:hover {
            background: #c82333;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .template-list {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
        }


        .template-item {
            padding: 12px 15px;
            margin-bottom: 8px;
            background: white;
            border: 1px solid #e1e8ed;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }

        .template-item:hover {
            background: #f8f9ff;
            border-color: #667eea;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .template-item.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .template-item-title {
            font-weight: 500;
            margin-bottom: 4px;
        }

        .template-item-info {
            font-size: 12px;
            color: #666;
        }

        .template-item.active .template-item-info {
            color: rgba(255,255,255,0.8);
        }

        .template-item-actions {
            display: flex;
            gap: 5px;
            margin-top: 8px;
        }

        .template-delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 11px;
            cursor: pointer;
        }

        .template-delete-btn:hover {
            background: #c82333;
        }

        /* 中間內容編輯區 */
        .content-editor {
            flex: 1;
            background: white;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #e1e8ed;
        }

        .tabs-header {
            padding: 15px 20px;
            border-bottom: 1px solid #e1e8ed;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .carousel-tabs {
            display: flex;
            gap: 8px;
            flex: 1;
        }

        .tab-item {
            background: #e9ecef;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .tab-item:hover {
            background: #dee2e6;
        }

        .tab-item.active {
            background: #667eea;
            color: white;
        }

        .tab-close {
            margin-left: 8px;
            font-weight: bold;
            opacity: 0.7;
        }

        .tab-close:hover {
            opacity: 1;
        }

        .add-tab {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
        }

        .content-form {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .form-section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #f0f0f0;
        }

        .form-section:last-child {
            border-bottom: none;
        }

        .section-title {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .section-icon {
            margin-right: 8px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 6px;
            font-size: 14px;
            font-weight: 500;
            color: #333;
        }

        .form-input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e1e8ed;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-textarea {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e1e8ed;
            border-radius: 6px;
            font-size: 14px;
            resize: vertical;
            min-height: 80px;
        }

        /* 右側預覽區 */
        .preview-area {
            width: 400px;
            background: #f0f2f5;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 30px 20px;
        }

        .phone-preview {
            width: 320px;
            height: 580px;
            background: #000;
            border-radius: 25px;
            padding: 15px 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            position: relative;
        }

        .phone-screen {
            width: 100%;
            height: 100%;
            background: #f0f0f0;
            border-radius: 18px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            background: #00b300;
            color: white;
            padding: 12px;
            font-size: 14px;
            font-weight: bold;
            text-align: center;
        }

        .chat-content {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
        }

        .carousel-preview {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding: 10px 0;
        }

        .bubble-preview {
            min-width: 200px;
            max-width: 200px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .bubble-image {
            width: 100%;
            height: 100px;
            object-fit: cover;
            background: #f0f0f0;
        }

        .bubble-content {
            padding: 12px;
        }

        .bubble-title {
            font-size: 14px;
            font-weight: bold;
            color: #333;
            margin-bottom: 4px;
        }

        .bubble-buttons {
            padding: 8px 12px;
            border-top: 1px solid #f0f0f0;
        }

        .bubble-button {
            display: block;
            width: 100%;
            padding: 8px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 4px;
            margin-bottom: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .bubble-button:last-child {
            margin-bottom: 0;
        }

        .bubble-button.secondary {
            background: #f8f9fa;
            color: #333;
            border: 1px solid #dee2e6;
        }

        .bubble-button.share {
            background: #1db446;
        }

        /* Toast 通知樣式 */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #333;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            z-index: 9999;
            opacity: 0;
            transform: translateX(300px);
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }

        .toast.success {
            background: #28a745;
        }

        .toast.error {
            background: #dc3545;
        }

        /* 面板分頁樣式 */
        .panel-tabs {
            display: flex;
            border-bottom: 1px solid #e1e8ed;
            background: #f8f9fa;
        }

        .panel-tab {
            flex: 1;
            padding: 12px 16px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            color: #666;
            transition: all 0.2s;
            border-bottom: 2px solid transparent;
        }

        .panel-tab:hover {
            background: #e9ecef;
            color: #333;
        }

        .panel-tab.active {
            color: #667eea;
            background: white;
            border-bottom-color: #667eea;
        }

        .panel-content {
            padding: 15px;
            flex: 1;
            overflow-y: auto;
        }

        .panel-actions {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
        }

        /* 變數管理樣式 */
        .variables-container {
            height: 100%;
        }

        .variables-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .variable-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e1e8ed;
        }

        .variable-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .variable-name {
            font-weight: bold;
            color: #333;
            font-size: 14px;
        }

        .variable-code {
            font-family: 'Monaco', 'Menlo', monospace;
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 12px;
            color: #667eea;
        }

        .variable-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
            transition: border-color 0.2s;
        }

        .variable-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }

        .copy-variable-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .copy-variable-btn:hover {
            background: #5a6fd8;
        }
    </style>
</head>
<body>
    <!-- 頭部工具列 -->
    <div class="editor-header">
        <div style="display: flex; align-items: center; gap: 15px;">
            <a href="./management" style="color: white; text-decoration: none; font-size: 14px; font-weight: bold; padding: 10px 16px; border-radius: 8px; background: #667eea; border: 2px solid #667eea; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1);" onmouseover="this.style.background='#5a67d8'; this.style.borderColor='#5a67d8'; this.style.transform='translateY(-1px)'" onmouseout="this.style.background='#667eea'; this.style.borderColor='#667eea'; this.style.transform='translateY(0)'">← 返回管理頁面</a>
            <div class="editor-title" id="editor-title" onclick="editTemplateTitle()" style="cursor: pointer;">🏗️ Flex Carousel 編輯器</div>
        </div>
        <div class="editor-actions">
            <button class="btn" onclick="showJsonPreview()">📝 檢視 JSON</button>
            <button class="btn btn-primary" onclick="window.close()">✕ 關閉</button>
        </div>
    </div>

    <!-- 主要編輯區域 -->
    <div class="editor-main">
        <!-- 左側管理面板 -->
        <div class="template-panel">
            <!-- 分頁標籤 -->
            <div class="panel-tabs">
                <button class="panel-tab active" onclick="switchPanelTab('templates')" id="tab-templates">📋 模板管理</button>
                <button class="panel-tab" onclick="switchPanelTab('variables')" id="tab-variables">🎯 變數管理</button>
            </div>
            
            <!-- 模板管理分頁 -->
            <div class="panel-content" id="panel-templates">
                <div class="panel-actions">
                    <button class="btn" onclick="addNewTemplate()" style="background: #28a745; color: white; border: none; padding: 6px 10px; border-radius: 4px; font-size: 12px;">+ 新增</button>
                    <button class="btn" onclick="saveTemplate()" style="background: #007bff; color: white; border: none; padding: 6px 10px; border-radius: 4px; font-size: 12px;">💾 儲存</button>
                </div>
                <div class="template-list" id="template-list">
                    <!-- 動態載入模板列表 -->
                </div>
            </div>
            
            <!-- 變數管理分頁 -->
            <div class="panel-content" id="panel-variables" style="display: none;">
                <div class="variables-container">
                    <div class="variables-header">
                        <h4 style="margin: 0 0 15px 0; color: #333;">🎯 變數管理</h4>
                        <p style="color: #666; font-size: 12px; margin-bottom: 20px;">設定變數預設值，模板預覽會自動代入這些值</p>
                    </div>
                    <div class="variables-list" id="variables-list">
                        <!-- 動態載入變數列表 -->
                    </div>
                </div>
            </div>

        </div>

        <!-- 中間內容編輯區 -->
        <div class="content-editor">
            <!-- 模板標題 -->
            <div style="padding: 15px 20px; background: #f8f9fa; border-bottom: 1px solid #e1e8ed;">
                <input type="text" id="template-title" class="form-input" placeholder="模板標題" style="font-size: 16px; font-weight: bold; border: 1px solid #ddd; padding: 8px 12px;" onchange="updateCurrentTemplateTitle(this.value)">
            </div>
            <div class="tabs-header">
                <div class="carousel-tabs" id="carousel-tabs">
                    <!-- 動態載入分頁標籤 -->
                </div>
                <button class="add-tab" onclick="addNewTab()">+ 新增分頁</button>
            </div>

            <div class="content-form" id="content-form">
                <!-- 動態載入表單內容 -->
            </div>
        </div>

        <!-- 右側預覽區 -->
        <div class="preview-area">
            <div class="phone-preview">
                <div class="phone-screen">
                    <div class="chat-header">LINE Chat 預覽</div>
                    <div class="chat-content">
                        <div class="carousel-preview" id="carousel-preview">
                            <!-- 動態產生預覽內容 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全域變數
        let currentTemplateIndex = 0;
        let currentTabIndex = 0;
        let templates = [];
        let carouselData = {
            type: 'carousel',
            contents: []
        };

        // 變數管理
        let templateVariables = {
            project_name: '',
            total_progress: '',
            manager: '',
            date: '',
            building_progress: [],
            today_progress: [],
            work_log: ''
        };

        // 變數模板
        const variableTemplate = {
            "type": "carousel",
            "contents": [
                // 第一頁：今日進度
                {
                    "type": "bubble",
                    "hero": {
                        "type": "image",
                        "url": "https://developers-resource.landpress.line.me/fx/img/01_2_restaurant.png",
                        "size": "full",
                        "aspectRatio": "20:13",
                        "aspectMode": "cover"
                    },
                    "body": {
                        "type": "box",
                        "layout": "vertical",
                        "spacing": "md",
                        "contents": [
                            {
                                "type": "text",
                                "text": "{{project_name}}",
                                "size": "xl",
                                "weight": "bold"
                            },
                            {
                                "type": "text",
                                "text": "今日進度報告",
                                "size": "md",
                                "color": "#666666",
                                "margin": "sm"
                            },
                            {
                                "type": "box",
                                "layout": "vertical",
                                "spacing": "sm",
                                "margin": "lg",
                                "contents": []
                            },
                            {
                                "type": "separator",
                                "margin": "lg"
                            },
                            {
                                "type": "box",
                                "layout": "baseline",
                                "spacing": "sm",
                                "margin": "lg",
                                "contents": [
                                    {
                                        "type": "text",
                                        "text": "負責人：",
                                        "size": "sm",
                                        "color": "#aaaaaa",
                                        "flex": 0
                                    },
                                    {
                                        "type": "text",
                                        "text": "{{manager}}",
                                        "size": "sm",
                                        "color": "#666666",
                                        "wrap": true
                                    }
                                ]
                            },
                            {
                                "type": "text",
                                "text": "{{date}}",
                                "size": "xs",
                                "color": "#aaaaaa",
                                "margin": "sm"
                            }
                        ]
                    }
                },
                // 第二頁：總進度與棟別進度
                {
                    "type": "bubble",
                    "hero": {
                        "type": "image",
                        "url": "https://developers-resource.landpress.line.me/fx/img/01_2_restaurant.png",
                        "size": "full",
                        "aspectRatio": "20:13",
                        "aspectMode": "cover"
                    },
                    "body": {
                        "type": "box",
                        "layout": "vertical",
                        "spacing": "md",
                        "contents": [
                            {
                                "type": "text",
                                "text": "{{project_name}}",
                                "size": "xl",
                                "weight": "bold"
                            },
                            {
                                "type": "box",
                                "layout": "baseline",
                                "spacing": "sm",
                                "margin": "lg",
                                "contents": [
                                    {
                                        "type": "text",
                                        "text": "總進度：",
                                        "size": "md",
                                        "color": "#333333",
                                        "flex": 0
                                    },
                                    {
                                        "type": "text",
                                        "text": "{{total_progress}}",
                                        "size": "xl",
                                        "color": "#00B900",
                                        "weight": "bold"
                                    }
                                ]
                            },
                            {
                                "type": "separator",
                                "margin": "lg"
                            },
                            {
                                "type": "text",
                                "text": "各棟進度",
                                "size": "md",
                                "weight": "bold",
                                "margin": "lg"
                            },
                            {
                                "type": "box",
                                "layout": "vertical",
                                "spacing": "sm",
                                "contents": []
                            },
                            {
                                "type": "text",
                                "text": "{{date}} 更新",
                                "size": "xs",
                                "color": "#aaaaaa",
                                "margin": "lg"
                            }
                        ]
                    }
                }
            ]
        };

        // 預設模板
        const defaultBubbleTemplate = {
            "type": "bubble",
            "hero": {
                "type": "image",
                "url": "https://developers-resource.landpress.line.me/fx/img/01_2_restaurant.png",
                "size": "full",
                "aspectRatio": "20:13",
                "aspectMode": "cover",
                "action": {
                    "type": "uri",
                    "uri": "https://line.me/"
                }
            },
            "body": {
                "type": "box",
                "layout": "vertical",
                "spacing": "md",
                "action": {
                    "type": "uri",
                    "uri": "https://line.me/"
                },
                "contents": [
                    {
                        "type": "text",
                        "text": "勝美 - 建功段",
                        "size": "xl",
                        "weight": "bold"
                    },
                    {
                        "type": "box",
                        "layout": "vertical",
                        "spacing": "sm",
                        "contents": [
                            {
                                "type": "box",
                                "layout": "baseline",
                                "contents": [
                                    {
                                        "type": "icon",
                                        "url": "https://developers-resource.landpress.line.me/fx/img/restaurant_regular_32.png"
                                    },
                                    {
                                        "type": "text",
                                        "text": "A棟",
                                        "weight": "bold",
                                        "margin": "sm",
                                        "flex": 0
                                    },
                                    {
                                        "type": "text",
                                        "text": "95%",
                                        "size": "sm",
                                        "align": "end",
                                        "color": "#aaaaaa"
                                    }
                                ]
                            },
                            {
                                "type": "box",
                                "layout": "baseline",
                                "contents": [
                                    {
                                        "type": "icon",
                                        "url": "https://developers-resource.landpress.line.me/fx/img/restaurant_large_32.png"
                                    },
                                    {
                                        "type": "text",
                                        "text": "{{building_progress}}",
                                        "weight": "bold",
                                        "margin": "sm",
                                        "flex": 0
                                    },
                                    {
                                        "type": "text",
                                        "text": "{{building_progress}}",
                                        "size": "sm",
                                        "align": "end",
                                        "color": "#aaaaaa"
                                    }
                                ]
                            }
                        ]
                    },
                    {
                        "type": "text",
                        "text": "2025-08-24 進度報告",
                        "wrap": true,
                        "color": "#aaaaaa",
                        "size": "xs"
                    }
                ],
                "paddingBottom": "xs"
            },
            "footer": {
                "type": "box",
                "layout": "vertical",
                "contents": [
                    {
                        "type": "button",
                        "style": "secondary",
                        "color": "#84C7D0",
                        "margin": "lg",
                        "action": {
                            "type": "uri",
                            "label": "了解更多",
                            "uri": "https://line.me/"
                        },
                        "offsetTop": "none",
                        "offsetEnd": "none",
                        "offsetStart": "none",
                        "offsetBottom": "xs"
                    },
                    {
                        "type": "button",
                        "action": {
                            "type": "uri",
                            "label": "分享",
                            "uri": "http://linecorp.com/"
                        },
                        "offsetTop": "none",
                        "offsetEnd": "none",
                        "offsetBottom": "none",
                        "offsetStart": "none",
                        "adjustMode": "shrink-to-fit",
                        "margin": "md",
                        "style": "secondary"
                    }
                ],
                "paddingAll": "md",
                "paddingTop": "none"
            }
        };

        // ========== 新的變數管理功能 ==========
        
        let isVariableMode = false;
        let buildingProgressData = [];
        let todayProgressData = [];
        
        // 切換變數模式
        function toggleVariableMode() {
            isVariableMode = !isVariableMode;
            const btn = document.getElementById('variable-mode-btn');
            const panel = document.getElementById('variable-panel');
            
            if (isVariableMode) {
                btn.textContent = '✓ 變數模式';
                btn.classList.add('variable-mode-active');
                panel.style.display = 'block';
                
                // 初始化變數管理面板
                initializeVariablePanel();
                
                // 在編輯表單中新增插入變數按鈕
                addVariableButtonsToForm();
            } else {
                btn.textContent = '🎯 變數模式';
                btn.classList.remove('variable-mode-active');
                panel.style.display = 'none';
                
                // 移除插入變數按鈕
                removeVariableButtonsFromForm();
            }
        }
        
        // 關閉變數面板
        function closeVariablePanel() {
            isVariableMode = false;
            const btn = document.getElementById('variable-mode-btn');
            const panel = document.getElementById('variable-panel');
            
            btn.textContent = '🎯 變數模式';
            btn.classList.remove('variable-mode-active');
            panel.style.display = 'none';
            
            removeVariableButtonsFromForm();
        }
        
        // 建立變數模板
        function createVariableTemplate() {
            // 新增變數模板
            const newTemplate = {
                id: Date.now(),
                name: '新變數模板',
                carouselData: JSON.parse(JSON.stringify(variableTemplate))
            };
            
            templates.push(newTemplate);
            currentTemplateIndex = templates.length - 1;
            carouselData = newTemplate.carouselData;
            
            renderTemplateList();
            updateTabs();
            updatePreview();
            
            // 自動開啟變數模式
            if (!isVariableMode) {
                toggleVariableMode();
            }
            
            // 初始化變數值
            initializeVariableValues();
            
            alert('變數模板已建立！正在開啟變數管理面板。');
        }
        
        // 初始化變數面板
        function initializeVariablePanel() {
            // 初始化基本變數
            if (!document.getElementById('var-project-name').value) {
                document.getElementById('var-project-name').value = '勝美 - 建功段';
            }
            if (!document.getElementById('var-total-progress').value) {
                document.getElementById('var-total-progress').value = '78%';
            }
            if (!document.getElementById('var-manager').value) {
                document.getElementById('var-manager').value = '張經理';
            }
            if (!document.getElementById('var-date').value) {
                document.getElementById('var-date').value = new Date().toISOString().split('T')[0];
            }
            if (!document.getElementById('var-work-log').value) {
                document.getElementById('var-work-log').value = '今日完成B棟3樓至4樓梁柱施工，C棟地基開挖';
            }
            
            // 初始化棟別進度
            if (buildingProgressData.length === 0) {
                buildingProgressData = [
                    {name: "A棟", progress: "95%"},
                    {name: "B棟", progress: "80%"},
                    {name: "C棟", progress: "60%"}
                ];
            }
            
            // 初始化今日進度
            if (todayProgressData.length === 0) {
                todayProgressData = [
                    {building: "B棟", work: "3FB4樓版", url: "https://example.com/b3fb4"},
                    {building: "C棟", work: "地基施工", url: "https://example.com/foundation"}
                ];
            }
            
            // 渲染表格
            renderBuildingProgressTable();
            renderTodayProgressTable();
            
            // 更新變數
            updateVariables();
        }
        
        // 初始化變數值(保持相容性)
        function initializeVariableValues() {
            initializeVariablePanel();
        }
        
        // 更新變數
        function updateVariables() {
            // 讀取變數值
            templateVariables.project_name = document.getElementById('var-project-name').value || '專案名稱';
            templateVariables.total_progress = document.getElementById('var-total-progress').value || '0%';
            templateVariables.manager = document.getElementById('var-manager').value || '負責人';
            templateVariables.date = document.getElementById('var-date').value || new Date().toISOString().split('T')[0];
            templateVariables.work_log = document.getElementById('var-work-log').value || '';
            
            // 使用表格數據
            templateVariables.building_progress = buildingProgressData;
            templateVariables.today_progress = todayProgressData;
            
            // 如果目前模板含有變數，更新預覽
            if (templates.length > 0 && hasVariables(carouselData)) {
                applyVariablesToTemplate();
                updatePreview();
            }
        }
        
        // 檢查模板是否含有變數
        function hasVariables(data) {
            const str = JSON.stringify(data);
            return str.includes('{{') && str.includes('}}');
        }
        
        // 插入變數到目前焦點的輸入框
        function insertVariable(varName) {
            const activeElement = document.activeElement;
            const variableText = `{{${varName}}}`;
            
            if (activeElement && (activeElement.tagName === 'INPUT' || activeElement.tagName === 'TEXTAREA')) {
                const start = activeElement.selectionStart;
                const end = activeElement.selectionEnd;
                const text = activeElement.value;
                
                activeElement.value = text.substring(0, start) + variableText + text.substring(end);
                activeElement.setSelectionRange(start + variableText.length, start + variableText.length);
                activeElement.focus();
                
                // 觸發 onchange 事件
                const event = new Event('change', { bubbles: true });
                activeElement.dispatchEvent(event);
            } else {
                alert('請先點擊要插入變數的輸入框');
            }
        }
        
        // 將變數應用到模板
        function applyVariablesToTemplate() {
            if (!carouselData || !carouselData.contents) return;
            
            carouselData.contents.forEach((bubble, pageIndex) => {
                if (pageIndex === 0) {
                    // 第一頁：今日進度
                    applyVariablesToBubble(bubble, true);
                } else if (pageIndex === 1) {
                    // 第二頁：總進度
                    applyVariablesToBubble(bubble, false);
                }
            });
            
            // 更新模板資料
            if (templates[currentTemplateIndex]) {
                templates[currentTemplateIndex].carouselData = carouselData;
            }
        }
        
        // 應用變數到单一 bubble
        function applyVariablesToBubble(bubble, isTodayProgressPage) {
            if (!bubble.body || !bubble.body.contents) return;
            
            bubble.body.contents.forEach(content => {
                if (content.type === 'text') {
                    // 替換文字變數
                    content.text = replaceVariables(content.text);
                } else if (content.type === 'box' && content.layout === 'vertical' && content.contents) {
                    if (isTodayProgressPage && content.contents.length === 0) {
                        // 第一頁的今日進度區域
                        content.contents = generateTodayProgressItems(templateVariables.today_progress);
                    } else if (!isTodayProgressPage && content.contents.length === 0) {
                        // 第二頁的棟別進度區域
                        content.contents = generateBuildingProgressItems(templateVariables.building_progress);
                    }
                } else if (content.type === 'box' && content.layout === 'baseline' && content.contents) {
                    // 處理 baseline 內的文字
                    content.contents.forEach(item => {
                        if (item.type === 'text') {
                            item.text = replaceVariables(item.text);
                        }
                    });
                }
            });
        }
        
        // 替換變數
        function replaceVariables(text) {
            if (!text) return text;
            
            return text
                .replace(/{{project_name}}/g, templateVariables.project_name)
                .replace(/{{total_progress}}/g, templateVariables.total_progress)
                .replace(/{{manager}}/g, templateVariables.manager)
                .replace(/{{date}}/g, templateVariables.date)
                .replace(/{{work_log}}/g, templateVariables.work_log);
        }
        
        // 生成今日進度項目
        function generateTodayProgressItems(todayProgressData) {
            if (!Array.isArray(todayProgressData) || todayProgressData.length === 0) {
                return [{
                    "type": "text",
                    "text": "無今日進度資料",
                    "size": "sm",
                    "color": "#aaaaaa"
                }];
            }
            
            return todayProgressData.map(item => ({
                "type": "box",
                "layout": "baseline",
                "spacing": "sm",
                "contents": [
                    {
                        "type": "text",
                        "text": item.building || '未知',
                        "size": "sm",
                        "color": "#333333",
                        "weight": "bold",
                        "flex": 0
                    },
                    {
                        "type": "text",
                        "text": item.work || '未知工作',
                        "size": "sm",
                        "color": item.url ? "#0099CC" : "#666666",
                        "wrap": true,
                        "action": item.url ? {
                            "type": "uri",
                            "uri": item.url
                        } : null
                    }
                ]
            }));
        }
        
        // 生成棟別進度項目
        function generateBuildingProgressItems(buildingProgressData) {
            if (!Array.isArray(buildingProgressData) || buildingProgressData.length === 0) {
                return [{
                    "type": "text",
                    "text": "無棟別進度資料",
                    "size": "sm",
                    "color": "#aaaaaa"
                }];
            }
            
            return buildingProgressData.map(building => ({
                "type": "box",
                "layout": "baseline",
                "spacing": "sm",
                "contents": [
                    {
                        "type": "text",
                        "text": building.name || '未知棟別',
                        "size": "sm",
                        "color": "#333333",
                        "weight": "bold",
                        "flex": 0
                    },
                    {
                        "type": "text",
                        "text": building.progress || '0%',
                        "size": "sm",
                        "color": "#00B900",
                        "align": "end"
                    }
                ]
            }));
        }

        // ========== 表格編輯器功能 ==========
        
        // 渲染棟別進度表格
        function renderBuildingProgressTable() {
            const table = document.getElementById('building-progress-table');
            let html = '';
            
            // 表格標頭
            html += '<div class="table-row">';
            html += '<div class="table-cell table-cell-header">棟名</div>';
            html += '<div class="table-cell table-cell-header">進度</div>';
            html += '<div class="table-cell table-cell-header" style="flex: 0 0 60px;">操作</div>';
            html += '</div>';
            
            // 数据行
            buildingProgressData.forEach((building, index) => {
                html += '<div class="table-row">';
                html += `<div class="table-cell"><input type="text" value="${building.name || ''}" onchange="updateBuildingProgress(${index}, 'name', this.value)"></div>`;
                html += `<div class="table-cell"><input type="text" value="${building.progress || ''}" onchange="updateBuildingProgress(${index}, 'progress', this.value)" placeholder="例: 85%"></div>`;
                html += `<div class="table-cell" style="flex: 0 0 60px;"><button class="delete-row-btn" onclick="deleteBuildingRow(${index})">×</button></div>`;
                html += '</div>';
            });
            
            table.innerHTML = html;
        }
        
        // 渲染今日進度表格
        function renderTodayProgressTable() {
            const table = document.getElementById('today-progress-table');
            let html = '';
            
            // 表格標頭
            html += '<div class="table-row">';
            html += '<div class="table-cell table-cell-header">棟別</div>';
            html += '<div class="table-cell table-cell-header">工作內容</div>';
            html += '<div class="table-cell table-cell-header">連結</div>';
            html += '<div class="table-cell table-cell-header" style="flex: 0 0 60px;">操作</div>';
            html += '</div>';
            
            // 数据行
            todayProgressData.forEach((progress, index) => {
                html += '<div class="table-row">';
                html += `<div class="table-cell"><input type="text" value="${progress.building || ''}" onchange="updateTodayProgress(${index}, 'building', this.value)"></div>`;
                html += `<div class="table-cell"><input type="text" value="${progress.work || ''}" onchange="updateTodayProgress(${index}, 'work', this.value)"></div>`;
                html += `<div class="table-cell"><input type="url" value="${progress.url || ''}" onchange="updateTodayProgress(${index}, 'url', this.value)" placeholder="https://..."></div>`;
                html += `<div class="table-cell" style="flex: 0 0 60px;"><button class="delete-row-btn" onclick="deleteTodayProgressRow(${index})">×</button></div>`;
                html += '</div>';
            });
            
            table.innerHTML = html;
        }
        
        // 新增棟別行
        function addBuildingRow() {
            buildingProgressData.push({name: '', progress: ''});
            renderBuildingProgressTable();
            updateVariables();
        }
        
        // 新增今日進度行
        function addTodayProgressRow() {
            todayProgressData.push({building: '', work: '', url: ''});
            renderTodayProgressTable();
            updateVariables();
        }
        
        // 更新棟別進度
        function updateBuildingProgress(index, field, value) {
            if (buildingProgressData[index]) {
                buildingProgressData[index][field] = value;
                updateVariables();
            }
        }
        
        // 更新今日進度
        function updateTodayProgress(index, field, value) {
            if (todayProgressData[index]) {
                todayProgressData[index][field] = value;
                updateVariables();
            }
        }
        
        // 刪除棟別行
        function deleteBuildingRow(index) {
            buildingProgressData.splice(index, 1);
            renderBuildingProgressTable();
            updateVariables();
        }
        
        // 刪除今日進度行
        function deleteTodayProgressRow(index) {
            todayProgressData.splice(index, 1);
            renderTodayProgressTable();
            updateVariables();
        }
        
        // 在編輯表單中新增插入變數按鈕
        function addVariableButtonsToForm() {
            // 這個功能將在下一階段實作
        }
        
        // 移除插入變數按鈕
        function removeVariableButtonsFromForm() {
            // 這個功能將在下一階段實作
        }

        // 初始化編輯器
        async function init() {
            console.log('Carousel 編輯器初始化...');
            
            // 載入已儲存的模板
            await loadTemplates();
            
            // 如果沒有模板，建立第一個預設模板
            if (templates.length === 0) {
                addNewTemplate();
            } else {
                selectTemplate(0);
            }
            
            updateTabs();
            updatePreview();
        }

        // 編輯模板標題
        function editTemplateTitle() {
            if (templates.length === 0) return;
            
            const currentTemplate = templates[currentTemplateIndex];
            const newName = prompt('請輸入新的模板名稱:', currentTemplate.name);
            
            if (newName && newName !== currentTemplate.name) {
                currentTemplate.name = newName;
                document.getElementById('editor-title').textContent = '📝 ' + newName;
                renderTemplateList();
            }
        }

        // 載入已儲存的模板
        async function loadTemplates() {
            try {
                const response = await fetch('/api/flex-templates');
                const data = await response.json();
                
                if (data.success && data.templates) {
                    templates = data.templates.map(t => ({
                        id: t.template_id,
                        name: t.template_name,
                        carouselData: JSON.parse(t.flex_content)
                    }));
                }
            } catch (error) {
                console.error('載入模板失敗:', error);
                templates = [];
            }
            
            renderTemplateList();
        }

        // 渲染模板列表
        function renderTemplateList() {
            const container = document.getElementById('template-list');
            let html = '';
            
            templates.forEach((template, index) => {
                const isActive = index === currentTemplateIndex;
                const bubbleCount = template.carouselData?.contents?.length || 0;
                
                html += '<div class="template-item' + (isActive ? ' active' : '') + '" onclick="selectTemplate(' + index + ')">';
                html += '<div class="template-item-title">' + template.name + '</div>';
                html += '<div class="template-item-info">' + bubbleCount + ' 個分頁</div>';
                html += '<div class="template-item-actions">';
                html += '<button class="template-delete-btn" onclick="event.stopPropagation(); deleteTemplate(' + index + ')">刪除</button>';
                html += '</div>';
                html += '</div>';
            });
            
            container.innerHTML = html;
        }

        // 更新當前模板標題
        function updateCurrentTemplateTitle(title) {
            if (templates.length > 0 && title) {
                templates[currentTemplateIndex].name = title;
                document.getElementById('editor-title').textContent = '📝 ' + title;
                renderTemplateList();
            }
        }

        // 選擇模板
        function selectTemplate(index) {
            if (index >= 0 && index < templates.length) {
                currentTemplateIndex = index;
                carouselData = templates[index].carouselData;
                currentTabIndex = 0;
                
                document.querySelector('.editor-title').textContent = '📝 ' + templates[index].name;
                document.getElementById('template-title').value = templates[index].name;
                
                renderTemplateList();
                updateTabs();
                updatePreview();
            }
        }

        // 新增模板
        function addNewTemplate() {
            const templateName = prompt('請輸入模板名稱:', '新模板 ' + (templates.length + 1));
            if (!templateName) return;
            
            const newTemplate = {
                id: 'temp_' + Date.now(),
                name: templateName,
                carouselData: {
                    type: 'carousel',
                    contents: [JSON.parse(JSON.stringify(defaultBubbleTemplate))]
                }
            };
            
            templates.push(newTemplate);
            currentTemplateIndex = templates.length - 1;
            carouselData = newTemplate.carouselData;
            currentTabIndex = 0;
            
            document.querySelector('.editor-title').textContent = '📝 ' + templateName;
            
            renderTemplateList();
            updateTabs();
            updatePreview();
        }

        // 刪除模板
        async function deleteTemplate(index) {
            if (templates.length <= 1) {
                alert('至少需要保留一個模板');
                return;
            }
            
            if (!confirm('確定要刪除模板 "' + templates[index].name + '" 嗎？')) {
                return;
            }

            const templateToDelete = templates[index];
            
            // 如果有 template_id，從資料庫刪除
            if (templateToDelete.id && !templateToDelete.id.startsWith('temp_')) {
                try {
                    const response = await fetch('/api/flex-templates/' + templateToDelete.id, {
                        method: 'DELETE'
                    });
                    const result = await response.json();
                    if (!result.success) {
                        console.error('Delete template failed:', result.error);
                    }
                } catch (error) {
                    console.error('Delete template error:', error);
                }
            }
            
            templates.splice(index, 1);
            
            // 調整當前選中的模板索引
            if (currentTemplateIndex >= templates.length) {
                currentTemplateIndex = templates.length - 1;
            } else if (currentTemplateIndex >= index && currentTemplateIndex > 0) {
                currentTemplateIndex--;
            }
            
            // 切換到調整後的模板
            if (templates.length > 0) {
                carouselData = templates[currentTemplateIndex].carouselData;
                document.querySelector('.editor-title').textContent = '📝 ' + templates[currentTemplateIndex].name;
                document.getElementById('template-title').value = templates[currentTemplateIndex].name;
            }
            
            renderTemplateList();
            updateTabs();
            updatePreview();
        }

        // 載入預設模板（保留向後兼容）
        function loadDefaultTemplate() {
            // 這個函數現在主要用於向後兼容
            // 實際的模板載入在 init() 中處理
        }

        // 更新分頁標籤
        function updateTabs() {
            const tabsContainer = document.getElementById('carousel-tabs');
            let html = '';
            
            carouselData.contents.forEach((bubble, index) => {
                const isActive = index === currentTabIndex;
                const title = getBubbleTitle(bubble, index);
                html += '<button class="tab-item' + (isActive ? ' active' : '') + '" onclick="selectTab('+index+')">';
                html += title;
                if (carouselData.contents.length > 1) {
                    html += '<span class="tab-close" onclick="event.stopPropagation(); removeTab('+index+')">×</span>';
                }
                html += '</button>';
            });
            
            tabsContainer.innerHTML = html;
            loadTabContent();
        }

        // 取得氣泡標題
        function getBubbleTitle(bubble, index) {
            // 查找主標題（第一個 text 元素且 weight 為 bold）
            const titleContent = bubble.body?.contents?.find(c => 
                c.type === 'text' && c.weight === 'bold'
            );
            
            if (titleContent?.text) {
                return titleContent.text.length > 8 ? 
                    titleContent.text.substring(0, 8) + '...' : 
                    titleContent.text;
            }
            
            return '分頁 ' + (index + 1);
        }

        // 選擇分頁
        function selectTab(index) {
            if (index >= 0 && index < carouselData.contents.length) {
                currentTabIndex = index;
                updateTabs();
            }
        }

        // 新增分頁
        function addNewTab() {
            const newBubble = JSON.parse(JSON.stringify(defaultBubbleTemplate));
            // 修改標題為新的分頁編號
            newBubble.body.contents[0].text = '分頁 ' + (carouselData.contents.length + 1);
            
            carouselData.contents.push(newBubble);
            currentTabIndex = carouselData.contents.length - 1;
            
            // 更新對應的模板
            templates[currentTemplateIndex].carouselData = carouselData;
            
            renderTemplateList();
            updateTabs();
            updatePreview();
        }

        // 移除分頁
        function removeTab(index) {
            if (carouselData.contents.length > 1) {
                carouselData.contents.splice(index, 1);
                if (currentTabIndex >= carouselData.contents.length) {
                    currentTabIndex = carouselData.contents.length - 1;
                }
                if (currentTabIndex >= index && currentTabIndex > 0) {
                    currentTabIndex--;
                }
                
                // 更新對應的模板
                templates[currentTemplateIndex].carouselData = carouselData;
                
                renderTemplateList();
                updateTabs();
                updatePreview();
            } else {
                alert('至少需要保留一個分頁');
            }
        }

        // 載入分頁內容表單
        function loadTabContent() {
            const form = document.getElementById('content-form');
            const bubble = carouselData.contents[currentTabIndex];
            
            if (!bubble) return;
            
            let html = '';
            
            // 主圖設定
            html += '<div class="form-section">';
            html += '<div class="section-title"><span class="section-icon">🖼️</span>主圖設定</div>';
            html += '<div class="form-group">';
            html += '<label class="form-label">圖片上傳</label>';
            html += '<input type="file" class="form-input hero-upload" accept="image/*" onchange="uploadHeroImage(this)" style="margin-bottom: 5px;">';
            html += '<div class="upload-status" style="font-size: 12px; color: #666; margin-bottom: 5px;"></div>';
            html += '<img class="hero-preview" src="' + (bubble.hero?.url || '') + '" style="max-width: 100%; height: 100px; object-fit: cover; border-radius: 4px; display: ' + (bubble.hero?.url ? 'block' : 'none') + ';">';
            html += '</div>';
            html += '</div>';
            
            // 內容設定 - 按順序定義內容元素
            const body = bubble.body?.contents || [];
            const titleContent = body[0]; // 主標題（第一個元素）
            const subtitleContent = body.find(c => c.type === 'text' && c !== titleContent && c.color !== '#aaaaaa' && c.size !== 'xs' && !c.wrap); // 副標題（普通文字）
            const buildingBox = body.find(c => c.type === 'box' && c.layout === 'vertical' && c.spacing === 'sm'); // 棟別box
            const bottomContent = body.find(c => c.type === 'text' && c !== titleContent && c !== subtitleContent && c.wrap === true); // 下方內容（有wrap的文字）
            const dateContent = body.find(c => c.type === 'text' && c.color === '#aaaaaa' && c.size === 'xs'); // 日期資訊（灰色小字）
            
            html += '<div class="form-section">';
            html += '<div class="section-title"><span class="section-icon">📝</span>內容設定</div>';
            html += '<div class="form-group">';
            html += '<label class="form-label">主標題</label>';
            html += '<input type="text" class="form-input" value="' + (titleContent?.text || '') + '" onchange="updateMainTitle(this.value)" placeholder="例：勝美 - 建功段">';
            html += '</div>';
            html += '<div class="form-group">';
            html += '<label class="form-label">副標題</label>';
            html += '<input type="text" class="form-input" value="' + (subtitleContent?.text || '') + '" onchange="updateSubtitle(this.value)" placeholder="例：台北市信義區">';
            html += '</div>';
            html += '<div class="form-group">';
            html += '<label class="form-label">下方內容</label>';
            html += '<textarea class="form-textarea" onchange="updateBottomContent(this.value)" placeholder="例：工程進度說明或其他補充資訊">' + (bottomContent?.text || '') + '</textarea>';
            html += '</div>';
            html += '<div class="form-group">';
            html += '<label class="form-label">日期資訊</label>';
            html += '<input type="text" class="form-input" value="' + (dateContent?.text || '') + '" onchange="updateDateInfo(this.value)" placeholder="例：2025-08-24 進度報告">';
            html += '</div>';
            html += '</div>';
            
            // 按鈕設定
            const buttons = bubble.footer?.contents || [];
            html += '<div class="form-section">';
            html += '<div class="section-title"><span class="section-icon">🔘</span>按鈕設定</div>';
            buttons.forEach((button, index) => {
                html += '<div class="form-group" style="border: 1px solid #e1e8ed; padding: 10px; margin-bottom: 10px; border-radius: 4px;">';
                html += '<label class="form-label">按鈕 ' + (index + 1) + '</label>';
                html += '<input type="text" class="form-input" value="' + (button.action?.label || '') + '" onchange="updateButtonLabel(' + index + ', this.value)" placeholder="按鈕文字" style="margin-bottom: 5px;">';
                html += '<input type="url" class="form-input" value="' + (button.action?.uri || '') + '" onchange="updateButtonUri(' + index + ', this.value)" placeholder="按鈕連結" style="margin-bottom: 5px;">';
                html += '<label class="form-label">按鈕顏色</label>';
                html += '<input type="text" class="form-input" value="' + (button.color || '#1976d2') + '" onchange="updateButtonColor(' + index + ', this.value)" placeholder="#ffffff" pattern="^#[0-9A-Fa-f]{6}$" style="margin-bottom: 5px;">';
                html += '<button type="button" class="template-delete-btn" onclick="removeButton(' + index + ')" style="margin-top: 5px;">刪除按鈕</button>';
                html += '</div>';
            });
            html += '<button type="button" class="btn" onclick="addButton()" style="background: #28a745; color: white; margin-right: 10px;">+ 新增按鈕</button>';
            html += '<button type="button" class="btn" onclick="addShareButton()" style="background: #00c851; color: white;">+ 新增分享按鈕</button>';
            html += '</div>';
            
            form.innerHTML = html;
        }

        // 更新主圖
        async function uploadHeroImage(input) {
            if (!input.files || input.files.length === 0) return;
            
            const file = input.files[0];
            const statusDiv = input.parentElement.querySelector('.upload-status');
            const preview = input.parentElement.querySelector('.hero-preview');
            
            console.log('開始上傳圖片:', file.name, 'Size:', file.size);
            statusDiv.textContent = '上傳中...';
            statusDiv.style.color = '#666';
            
            const formData = new FormData();
            formData.append('image', file);
            
            try {
                const response = await fetch('/api/upload-image', {
                    method: 'POST',
                    body: formData
                });
                
                console.log('上傳回應狀態:', response.status);
                const result = await response.json();
                console.log('上傳結果:', result);
                
                if (result.success) {
                    const bubble = carouselData.contents[currentTabIndex];
                    if (!bubble.hero) {
                        bubble.hero = {
                            "type": "image",
                            "size": "full",
                            "aspectRatio": "20:13",
                            "aspectMode": "cover"
                        };
                    }
                    // API 回應的 URL 在 data.publicUrl 中
                    const imageUrl = result.data?.publicUrl || result.url;
                    bubble.hero.url = imageUrl;
                    templates[currentTemplateIndex].carouselData = carouselData;
                    console.log('設定圖片URL:', imageUrl);
                    console.log('更新後的hero對象:', bubble.hero);
                    
                    // 更新預覽圖片
                    if (preview) {
                        preview.src = imageUrl;
                        preview.style.display = 'block';
                        console.log('更新預覽圖片元素:', preview.src);
                    }
                    
                    statusDiv.textContent = '上傳成功: ' + imageUrl;
                    statusDiv.style.color = '#28a745';
                    
                    // 更新預覽區
                    updatePreview();
                    console.log('呼叫updatePreview完成');
                } else {
                    statusDiv.textContent = '上傳失敗: ' + result.error;
                    statusDiv.style.color = '#dc3545';
                }
            } catch (error) {
                console.error('上傳錯誤:', error);
                statusDiv.textContent = '上傳失敗: ' + error.message;
                statusDiv.style.color = '#dc3545';
            }
        }

        function updateHeroImage(url) {
            const bubble = carouselData.contents[currentTabIndex];
            if (bubble.hero) {
                bubble.hero.url = url;
                templates[currentTemplateIndex].carouselData = carouselData;
                updatePreview();
            }
        }


        // 更新主標題
        function updateMainTitle(text) {
            const bubble = carouselData.contents[currentTabIndex];
            const titleContent = bubble.body.contents.find(c => c.type === 'text' && c.weight === 'bold');
            if (titleContent) {
                titleContent.text = text;
                templates[currentTemplateIndex].carouselData = carouselData;
                updateTabs();
                updatePreview();
            }
        }

        // 更新日期資訊
        function updateDateInfo(text) {
            const bubble = carouselData.contents[currentTabIndex];
            let dateContent = bubble.body.contents.find(c => c.type === 'text' && c.color === '#aaaaaa' && c.size === 'xs');
            
            if (!dateContent && text) {
                // 如果不存在日期資訊元素，在最後創建一個
                dateContent = {
                    "type": "text",
                    "text": text,
                    "wrap": true,
                    "color": "#aaaaaa",
                    "size": "xs"
                };
                bubble.body.contents.push(dateContent);
            } else if (dateContent) {
                if (text) {
                    dateContent.text = text;
                } else {
                    // 如果文字為空，移除日期資訊
                    const index = bubble.body.contents.indexOf(dateContent);
                    if (index > -1) {
                        bubble.body.contents.splice(index, 1);
                    }
                }
            }
            
            templates[currentTemplateIndex].carouselData = carouselData;
            updatePreview();
        }

        // 更新副標題
        function updateSubtitle(text) {
            const bubble = carouselData.contents[currentTabIndex];
            let subtitleContent = bubble.body.contents.find(c => c.type === 'text' && c !== bubble.body.contents[0] && c.color !== '#aaaaaa' && c.size !== 'xs' && !c.wrap);
            
            if (!subtitleContent && text) {
                // 如果不存在副標題元素，在主標題後創建一個
                subtitleContent = {
                    "type": "text",
                    "text": text,
                    "size": "sm",
                    "color": "#666666",
                    "margin": "sm"
                };
                // 找到棟別box的位置，插入到前面，如果沒有則插入到位置1
                const buildingBoxIndex = bubble.body.contents.findIndex(c => c.type === 'box' && c.layout === 'vertical');
                const insertIndex = buildingBoxIndex > -1 ? buildingBoxIndex : 1;
                bubble.body.contents.splice(insertIndex, 0, subtitleContent);
                console.log('添加副標題到位置:', insertIndex, '內容:', text);
            } else if (subtitleContent) {
                if (text) {
                    subtitleContent.text = text;
                    console.log('更新副標題內容:', text);
                } else {
                    // 如果文字為空，移除副標題
                    const index = bubble.body.contents.indexOf(subtitleContent);
                    if (index > -1) {
                        bubble.body.contents.splice(index, 1);
                        console.log('移除副標題');
                    }
                }
            }
            
            templates[currentTemplateIndex].carouselData = carouselData;
            updatePreview();
        }

        // 更新下方內容
        function updateBottomContent(text) {
            const bubble = carouselData.contents[currentTabIndex];
            let bottomContent = bubble.body.contents.find(c => c.type === 'text' && c.wrap === true);
            
            if (!bottomContent && text) {
                // 如果不存在下方內容元素，在日期資訊前創建一個
                bottomContent = {
                    "type": "text",
                    "text": text,
                    "size": "sm",
                    "wrap": true,
                    "margin": "md"
                };
                
                // 找到日期資訊的位置，插入到前面
                const dateIndex = bubble.body.contents.findIndex(c => c.type === 'text' && c.color === '#aaaaaa' && c.size === 'xs');
                if (dateIndex > -1) {
                    bubble.body.contents.splice(dateIndex, 0, bottomContent);
                    console.log('添加下方內容到日期資訊前，位置:', dateIndex, '內容:', text);
                } else {
                    bubble.body.contents.push(bottomContent);
                    console.log('添加下方內容到最後，內容:', text);
                }
            } else if (bottomContent) {
                if (text) {
                    bottomContent.text = text;
                } else {
                    // 如果文字為空，移除下方內容
                    const index = bubble.body.contents.indexOf(bottomContent);
                    if (index > -1) {
                        bubble.body.contents.splice(index, 1);
                    }
                }
            }
            
            templates[currentTemplateIndex].carouselData = carouselData;
            updatePreview();
        }

        // 更新棟別名稱
        function updateBuildingName(index, name) {
            const bubble = carouselData.contents[currentTabIndex];
            const buildingBox = bubble.body.contents.find(c => c.type === 'box' && c.layout === 'vertical' && c.spacing === 'sm');
            if (buildingBox?.contents?.[index]?.type === 'box') {
                const buildingNameText = buildingBox.contents[index].contents.find(c => c.type === 'text' && c.weight === 'bold');
                if (buildingNameText) {
                    buildingNameText.text = name;
                    templates[currentTemplateIndex].carouselData = carouselData;
                    updatePreview();
                }
            }
        }

        // 更新棟別百分比
        function updateBuildingPercentage(index, percentage) {
            const bubble = carouselData.contents[currentTabIndex];
            const buildingBox = bubble.body.contents.find(c => c.type === 'box' && c.layout === 'vertical' && c.spacing === 'sm');
            if (buildingBox?.contents?.[index]?.type === 'box') {
                const percentageText = buildingBox.contents[index].contents.find(c => c.type === 'text' && c.align === 'end');
                if (percentageText) {
                    percentageText.text = percentage;
                    templates[currentTemplateIndex].carouselData = carouselData;
                    updatePreview();
                }
            }
        }

        // 新增棟別
        function addBuilding() {
            const bubble = carouselData.contents[currentTabIndex];
            const buildingBox = bubble.body.contents.find(c => c.type === 'box' && c.layout === 'vertical' && c.spacing === 'sm');
            if (buildingBox) {
                const newBuilding = {
                    "type": "box",
                    "layout": "baseline",
                    "contents": [
                        {
                            "type": "icon",
                            "url": "https://developers-resource.landpress.line.me/fx/img/restaurant_regular_32.png"
                        },
                        {
                            "type": "text",
                            "text": "新棟別",
                            "weight": "bold",
                            "margin": "sm",
                            "flex": 0
                        },
                        {
                            "type": "text",
                            "text": "0%",
                            "size": "sm",
                            "align": "end",
                            "color": "#aaaaaa"
                        }
                    ]
                };
                buildingBox.contents.push(newBuilding);
                templates[currentTemplateIndex].carouselData = carouselData;
                loadTabContent();
                updatePreview();
            }
        }

        // 更新按鈕標籤
        function updateButtonLabel(index, label) {
            const bubble = carouselData.contents[currentTabIndex];
            const button = bubble.footer?.contents?.[index];
            if (button?.action) {
                button.action.label = label;
                templates[currentTemplateIndex].carouselData = carouselData;
                updatePreview();
            }
        }

        // 更新按鈕連結
        function updateButtonUri(index, uri) {
            const bubble = carouselData.contents[currentTabIndex];
            const button = bubble.footer?.contents?.[index];
            if (button?.action) {
                button.action.uri = uri;
                templates[currentTemplateIndex].carouselData = carouselData;
                updatePreview();
            }
        }

        // 新增按鈕
        function addButton() {
            const bubble = carouselData.contents[currentTabIndex];
            if (!bubble.footer) {
                bubble.footer = {
                    "type": "box",
                    "layout": "vertical",
                    "contents": [],
                    "paddingAll": "md",
                    "paddingTop": "none"
                };
            }
            
            const newButton = {
                "type": "button",
                "action": {
                    "type": "uri",
                    "label": "新按鈕",
                    "uri": "https://line.me/"
                },
                "style": "secondary",
                "margin": "md"
            };
            
            bubble.footer.contents.push(newButton);
            templates[currentTemplateIndex].carouselData = carouselData;
            loadTabContent();
            updatePreview();
        }

        // 移除棟別
        function removeBuilding(index) {
            const bubble = carouselData.contents[currentTabIndex];
            const buildingBox = bubble.body.contents.find(c => c.type === 'box' && c.layout === 'vertical' && c.spacing === 'sm');
            if (buildingBox?.contents?.[index]) {
                buildingBox.contents.splice(index, 1);
                templates[currentTemplateIndex].carouselData = carouselData;
                loadTabContent();
                updatePreview();
            }
        }

        // 移除按鈕
        function removeButton(index) {
            const bubble = carouselData.contents[currentTabIndex];
            if (bubble.footer?.contents) {
                bubble.footer.contents.splice(index, 1);
                templates[currentTemplateIndex].carouselData = carouselData;
                loadTabContent();
                updatePreview();
            }
        }

        // 更新按鈕顏色
        function updateButtonColor(index, color) {
            const bubble = carouselData.contents[currentTabIndex];
            if (bubble.footer?.contents?.[index]) {
                bubble.footer.contents[index].color = color;
                templates[currentTemplateIndex].carouselData = carouselData;
                updatePreview();
            }
        }

        // 新增分享按鈕
        function addShareButton() {
            const bubble = carouselData.contents[currentTabIndex];
            if (!bubble.footer) {
                bubble.footer = {
                    "type": "box",
                    "layout": "horizontal",
                    "contents": []
                };
            }
            
            const shareButton = {
                "type": "button",
                "action": {
                    "type": "uri",
                    "label": "分享",
                    "uri": "https://line-bot-pusher.pages.dev/liff-share?template=" + templates[currentTemplateIndex].id
                },
                "style": "primary",
                "color": "#00c851"
            };
            
            bubble.footer.contents.push(shareButton);
            templates[currentTemplateIndex].carouselData = carouselData;
            loadTabContent();
            updatePreview();
        }

        // 更新氣泡文字內容
        function updateBubbleText(type, value) {
            const bubble = carouselData.contents[currentTabIndex];
            if (!bubble.body?.contents) return;
            
            const contents = bubble.body.contents;
            
            if (type === 'title') {
                const titleItem = contents.find(c => c.weight === 'bold');
                if (titleItem) {
                    titleItem.text = value;
                } else {
                    contents.unshift({
                        type: 'text',
                        text: value,
                        wrap: true,
                        weight: 'bold',
                        size: 'xl'
                    });
                }
            } else if (type === 'subtitle') {
                let subtitleItem = contents.find(c => c.size === 'sm' && c.color === '#666666');
                if (subtitleItem) {
                    subtitleItem.text = value;
                } else {
                    const titleIndex = contents.findIndex(c => c.weight === 'bold');
                    contents.splice(titleIndex + 1, 0, {
                        type: 'text',
                        text: value,
                        wrap: true,
                        size: 'sm',
                        color: '#666666'
                    });
                }
            }
            
            updateTabs();
            updatePreview();
        }

        // 更新預覽
        // 變數替換函數
        function replaceVariables(text, context = {}) {
            if (!text || typeof text !== 'string') return text;
            
            let result = text;
            currentVariables.forEach(variable => {
                const pattern = new RegExp(`{{${variable.code}}}`, 'g');
                
                // 特殊處理棟別進度
                if (variable.code === 'building_progress' && context.isBuildingContext) {
                    // 解析文字格式：A棟 95% B棟 80% C棟 60%
                    const buildingText = variable.defaultValue;
                    const buildingMatches = buildingText.match(/(\S+棟)\s+(\d+%)/g) || [];
                    const buildings = buildingMatches.map(match => {
                        const parts = match.trim().split(/\s+/);
                        return {
                            name: parts[0],
                            progress: parts[1] || '0%'
                        };
                    });
                    
                    if (buildings.length > 0 && context.buildingIndex !== undefined) {
                        const building = buildings[context.buildingIndex];
                        if (building) {
                            if (context.isNameField) {
                                result = result.replace(pattern, building.name);
                            } else if (context.isProgressField) {
                                result = result.replace(pattern, building.progress);
                            }
                        }
                    } else {
                        result = result.replace(pattern, variable.defaultValue);
                    }
                } else {
                    result = result.replace(pattern, variable.defaultValue);
                }
            });
            
            return result;
        }

        function updatePreview() {
            const container = document.getElementById('carousel-preview');
            let html = '';
            
            carouselData.contents.forEach((bubble, index) => {
                const hero = bubble.hero;
                const body = bubble.body?.contents || [];
                const titleContent = body.find(c => c.type === 'text' && c.weight === 'bold');
                const title = replaceVariables(titleContent?.text) || '分頁 ' + (index + 1);
                const buildingBox = body.find(c => c.type === 'box' && c.layout === 'vertical' && c.spacing === 'sm');
                const dateContent = body.find(c => c.type === 'text' && c.color === '#aaaaaa' && c.size === 'xs');
                const buttons = bubble.footer?.contents || [];
                
                html += '<div class="bubble-preview' + (index === currentTabIndex ? ' active' : '') + '">';
                
                // 主圖
                if (hero?.url) {
                    html += '<img src="' + hero.url + '" class="bubble-image" alt="圖片">';
                } else {
                    html += '<div class="bubble-image" style="display: flex; align-items: center; justify-content: center; background: #f0f0f0; color: #999;">無圖片</div>';
                }
                
                // 內容區域
                html += '<div class="bubble-content">';
                html += '<div class="bubble-title">' + title + '</div>';
                
                // 副標題
                const subtitleContent = body.find(c => c.type === 'text' && c !== body[0] && c.color !== '#aaaaaa' && c.size !== 'xs' && !c.wrap);
                if (subtitleContent?.text) {
                    html += '<div style="font-size: 12px; color: #666; margin-top: 4px;">' + replaceVariables(subtitleContent.text) + '</div>';
                }
                
                // 棟別資訊
                if (buildingBox?.contents) {
                    html += '<div style="margin: 8px 0;">';
                    buildingBox.contents.forEach((building, buildingIndex) => {
                        if (building.type === 'box' && building.layout === 'baseline') {
                            const buildingNameText = building.contents.find(c => c.type === 'text' && c.weight === 'bold')?.text || '';
                            const percentageText = building.contents.find(c => c.type === 'text' && c.align === 'end')?.text || '';
                            
                            // 使用context來處理棟別進度變數
                            const buildingName = replaceVariables(buildingNameText, {
                                isBuildingContext: true,
                                buildingIndex: buildingIndex,
                                isNameField: true
                            });
                            
                            const percentage = replaceVariables(percentageText, {
                                isBuildingContext: true,
                                buildingIndex: buildingIndex,
                                isProgressField: true
                            });
                            
                            html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; padding: 6px 0; font-size: 15px; border-bottom: 1px solid #f0f0f0;">';
                            html += '<span style="font-weight: bold; color: #333;">' + buildingName + '</span>';
                            html += '<span style="font-weight: bold; color: #667eea; text-align: right;">' + percentage + '</span>';
                            html += '</div>';
                        }
                    });
                    html += '</div>';
                }
                
                // 下方內容
                const bottomContent = body.find(c => c.type === 'text' && c.wrap === true);
                if (bottomContent?.text) {
                    html += '<div style="font-size: 11px; color: #555; margin-top: 6px; line-height: 1.3;">' + replaceVariables(bottomContent.text) + '</div>';
                }
                
                // 日期資訊
                if (dateContent?.text) {
                    html += '<div style="font-size: 11px; color: #aaa; margin-top: 8px;">' + replaceVariables(dateContent.text) + '</div>';
                }
                
                html += '</div>';
                
                // 按鈕
                if (buttons.length > 0) {
                    html += '<div class="bubble-buttons">';
                    buttons.forEach((btn, btnIndex) => {
                        const btnClass = btn.style === 'primary' ? 'bubble-button' : 'bubble-button secondary';
                        const btnStyle = btn.color ? 'background-color: ' + btn.color + ';' : '';
                        const buttonLabel = replaceVariables(btn.action?.label) || '按鈕';
                        html += '<button class="' + btnClass + '" style="' + btnStyle + '">' + buttonLabel + '</button>';
                    });
                    html += '</div>';
                }
                
                html += '</div>';
            });
            
            container.innerHTML = html;
        }

        // 工具列功能
        function loadProject() {
            alert('建案載入功能開發中...');
        }

        function showJsonPreview() {
            const jsonWindow = window.open('', '_blank', 'width=800,height=600');
            const jsonString = JSON.stringify(carouselData, null, 2);
            const jsonEscaped = jsonString.replace(/'/g, "\\'");
            
            jsonWindow.document.write(
                '<html><head><title>Flex Carousel JSON</title></head>' +
                '<body style="font-family: monospace; padding: 20px;">' +
                '<h3>生成的 Flex Carousel JSON</h3>' +
                '<pre style="background: #f5f5f5; padding: 15px; border-radius: 8px; overflow: auto; white-space: pre-wrap; max-height: 80vh;">' +
                jsonString +
                '</pre><br>' +
                '<button onclick="navigator.clipboard.writeText(\'' + jsonEscaped + '\'); alert(\'JSON 已複製到剪貼簿!\');" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer;">📋 複製 JSON</button>' +
                '<button onclick="window.close();" style="margin-left: 10px; padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer;">✕ 關閉</button>' +
                '</body></html>'
            );
        }

        function previewInNewWindow() {
            alert('預覽功能開發中...');
        }

        async function saveTemplate() {
            if (templates.length === 0) return;
            
            const currentTemplate = templates[currentTemplateIndex];
            
            try {
                const response = await fetch('/api/flex-templates', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        template_name: currentTemplate.name,
                        description: '共' + carouselData.contents.length + '個分頁',
                        template_type: 'carousel',
                        flex_content: JSON.stringify(carouselData),
                        category: 'custom'
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    // 更新模板 ID
                    currentTemplate.id = result.template_id;
                    alert('模板儲存成功!');
                    // 重新載入模板列表
                    await loadTemplates();
                } else {
                    alert('儲存失敗：' + result.error);
                }
            } catch (error) {
                alert('儲存出錯：' + error.message);
            }
        }

        // 載入現有模板
        async function loadExistingTemplate(templateId) {
            try {
                const response = await fetch('/api/flex-templates/' + templateId);
                const data = await response.json();
                
                if (data.success && data.template) {
                    const template = data.template;
                    document.querySelector('.editor-title').textContent = '📱 編輯模板: ' + template.template_name;
                    
                    const flexContent = JSON.parse(template.flex_content);
                    if (flexContent.type === 'carousel') {
                        carouselData = flexContent;
                    }
                    
                    if (template.category) {
                        currentCategory = template.category;
                    }
                    
                    currentTabIndex = 0;
                    updateTabs();
                    updatePreview();
                } else {
                    alert('載入模板失敗: ' + (data.error || '模板不存在'));
                }
            } catch (error) {
                console.error('載入模板錯誤:', error);
                alert('載入模板時發生錯誤');
            }
        }

        // 分頁切換功能
        function switchPanelTab(tabName) {
            // 更新標籤狀態
            document.querySelectorAll('.panel-tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById('tab-' + tabName).classList.add('active');
            
            // 更新內容顯示
            document.querySelectorAll('.panel-content').forEach(content => content.style.display = 'none');
            document.getElementById('panel-' + tabName).style.display = 'block';
            
            if (tabName === 'variables') {
                renderVariablesList();
            }
        }

        // 變數管理相關函數
        let currentVariables = [
            {
                name: '專案名稱',
                code: 'project_name',
                defaultValue: '勝美-建功段',
                description: '建案專案名稱'
            },
            {
                name: '棟別進度',
                code: 'building_progress',
                defaultValue: 'A棟 95% B棟 80% C棟 60%',
                description: '各棟別施工進度'
            },
            {
                name: '今日進度',
                code: 'today_progress',
                defaultValue: '鋼筋綁紮完成',
                description: '當日工作進度'
            },
            {
                name: '案場負責人',
                code: 'site_manager',
                defaultValue: '王建築師',
                description: '案場負責人姓名'
            },
            {
                name: '聯絡電話',
                code: 'contact_phone',
                defaultValue: '02-1234-5678',
                description: '案場聯絡電話'
            },
            {
                name: '今天日期',
                code: 'today_date',
                defaultValue: new Date().toLocaleDateString('zh-TW'),
                description: '今天的日期'
            }
        ];

        function renderVariablesList() {
            const container = document.getElementById('variables-list');
            let html = '';
            
            currentVariables.forEach((variable, index) => {
                html += `
                    <div class="variable-item">
                        <div class="variable-item-header">
                            <div>
                                <span class="variable-name">${variable.name}</span>
                                <span class="variable-code">{{${variable.code}}}</span>
                            </div>
                            <button class="copy-variable-btn" onclick="copyVariableCode('${variable.code}')" title="複製變數代碼">
                                📋 複製
                            </button>
                        </div>
                        <input type="text" 
                               class="variable-input" 
                               value="${variable.defaultValue}"
                               placeholder="${variable.description}"
                               onchange="updateVariableValue('${variable.code}', this.value)"
                               id="var-${variable.code}">
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function updateVariableValue(code, value) {
            const variable = currentVariables.find(v => v.code === code);
            if (variable) {
                variable.defaultValue = value;
                updatePreview(); // 更新預覽，套用新的變數值
            }
        }

        function copyVariableCode(code) {
            const variableText = `{{${code}}}`;
            navigator.clipboard.writeText(variableText).then(() => {
                showToast(`變數 {{${code}}} 已複製到剪貼簿！`);
            }).catch(err => {
                console.error('複製失敗:', err);
                // 備用方案
                const textArea = document.createElement('textarea');
                textArea.value = variableText;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showToast(`變數 {{${code}}} 已複製到剪貼簿！`);
            });
        }

        function showToast(message) {
            // 移除現有的 toast
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }

            // 建立新的 toast
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);

            // 顯示動畫
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);

            // 3秒後隱藏
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }

        // 頁面載入時初始化
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>