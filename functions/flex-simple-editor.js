// Á∞°ÂåñÁâà Flex Message Á∑®ËºØÂô®
export async function onRequest(context) {
  const { request, env } = context;
  const url = new URL(request.url);
  const templateId = url.searchParams.get('id');

  const flexSimpleEditorHtml = `<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flex Message Á∑®ËºØÂô®</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            height: 100vh;
            overflow: hidden;
        }

        /* È†≠ÈÉ®Â∑•ÂÖ∑Âàó */
        .editor-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .editor-title {
            font-size: 20px;
            font-weight: bold;
        }

        .editor-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .btn-primary {
            background: rgba(255,255,255,0.9);
            color: #667eea;
        }

        /* ‰∏ªË¶ÅÁ∑®ËºØÂçÄÂüü */
        .editor-main {
            display: flex;
            height: calc(100vh - 70px);
        }

        /* Â∑¶ÂÅ¥Ë®≠ÂÆöÈù¢Êùø */
        .settings-panel {
            width: 350px;
            background: white;
            border-right: 1px solid #e1e8ed;
            display: flex;
            flex-direction: column;
        }

        .panel-header {
            padding: 20px;
            border-bottom: 1px solid #e1e8ed;
            background: #f8f9fa;
        }

        .panel-title {
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }

        .template-selector {
            padding: 20px;
            border-bottom: 1px solid #e1e8ed;
        }

        .template-type {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .type-btn {
            flex: 1;
            padding: 15px 10px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }

        .type-btn:hover {
            border-color: #667eea;
        }

        .type-btn.active {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .type-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .type-name {
            font-size: 14px;
            font-weight: 500;
        }

        .settings-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 500;
            color: #333;
        }

        .form-input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e1e8ed;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-textarea {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e1e8ed;
            border-radius: 6px;
            font-size: 14px;
            resize: vertical;
            min-height: 80px;
        }

        .form-select {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e1e8ed;
            border-radius: 6px;
            font-size: 14px;
            background: white;
        }

        .color-input {
            width: 100%;
            height: 40px;
            padding: 0;
            border: 2px solid #e1e8ed;
            border-radius: 6px;
            cursor: pointer;
        }

        .button-list {
            margin-top: 10px;
        }

        .button-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid #e1e8ed;
            border-radius: 6px;
            background: #f8f9fa;
        }

        .button-item input {
            flex: 1;
            padding: 6px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
        }

        .remove-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
        }

        .add-btn {
            width: 100%;
            padding: 10px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
        }

        /* ‰∏≠ÈñìÈ†êË¶ΩÂçÄ */
        .preview-area {
            flex: 1;
            background: #f0f2f5;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 30px;
        }

        .phone-preview {
            width: 375px;
            height: 600px;
            background: #000;
            border-radius: 25px;
            padding: 20px 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .phone-screen {
            width: 100%;
            height: 100%;
            background: #f0f0f0;
            border-radius: 15px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            background: #00b300;
            color: white;
            padding: 15px;
            font-size: 16px;
            font-weight: bold;
            text-align: center;
        }

        .chat-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .message-bubble {
            background: white;
            border-radius: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .bubble-content {
            padding: 15px;
        }

        .bubble-image {
            width: 100%;
            height: 120px;
            object-fit: cover;
        }

        .bubble-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }

        .bubble-subtitle {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }

        .bubble-text {
            font-size: 14px;
            line-height: 1.4;
            color: #333;
        }

        .bubble-buttons {
            border-top: 1px solid #f0f0f0;
            padding: 10px 15px;
        }

        .bubble-button {
            display: block;
            width: 100%;
            padding: 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: pointer;
            font-size: 14px;
        }

        .bubble-button:last-child {
            margin-bottom: 0;
        }

        .bubble-button.secondary {
            background: #f8f9fa;
            color: #333;
            border: 1px solid #dee2e6;
        }

        /* Carousel Ê®£Âºè */
        .carousel-container {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding: 10px 0;
        }

        .carousel-bubble {
            min-width: 250px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            overflow: hidden;
        }
    </style>
</head>
<body>
    <!-- È†≠ÈÉ®Â∑•ÂÖ∑Âàó -->
    <div class="editor-header">
        <div class="editor-title">üì± Flex Message Á∑®ËºØÂô®</div>
        <div class="editor-actions">
            <button class="btn" onclick="showJsonPreview()">üìù Ê™¢Ë¶ñ JSON</button>
            <button class="btn" onclick="previewInNewWindow()">üëÅÔ∏è È†êË¶Ω</button>
            <button class="btn" onclick="saveTemplate()">üíæ ÂÑ≤Â≠ò</button>
            <button class="btn btn-primary" onclick="window.close()">‚úï ÈóúÈñâ</button>
        </div>
    </div>

    <!-- ‰∏ªË¶ÅÁ∑®ËºØÂçÄÂüü -->
    <div class="editor-main">
        <!-- Â∑¶ÂÅ¥Ë®≠ÂÆöÈù¢Êùø -->
        <div class="settings-panel">
            <div class="panel-header">
                <div class="panel-title">‚öôÔ∏è Ê®°ÊùøË®≠ÂÆö</div>
            </div>
            
            <!-- Ê®°ÊùøÈ°ûÂûãÈÅ∏Êìá -->
            <div class="template-selector">
                <label class="form-label">ÈÅ∏ÊìáÊ®°ÊùøÈ°ûÂûã</label>
                <div class="template-type">
                    <div class="type-btn active" onclick="selectTemplate('text')" data-type="text">
                        <div class="type-icon">üìù</div>
                        <div class="type-name">Á¥îÊñáÂ≠ó</div>
                    </div>
                    <div class="type-btn" onclick="selectTemplate('card')" data-type="card">
                        <div class="type-icon">üñºÔ∏è</div>
                        <div class="type-name">ÂúñÊñáÂç°Áâá</div>
                    </div>
                </div>
                
                <label class="form-label">È°ØÁ§∫ÊñπÂºè</label>
                <select class="form-select" id="displayType" onchange="updateDisplay()">
                    <option value="single">ÂñÆ‰∏ÄÊ∞£Ê≥°</option>
                    <option value="carousel">Â§öÂÄãÊ∞£Ê≥° (Ëº™Êí≠)</option>
                </select>
                
                <div id="bubbleCount" style="display: none;">
                    <label class="form-label">Ê∞£Ê≥°Êï∏Èáè</label>
                    <select class="form-select" id="bubbleCountSelect" onchange="updateBubbleCount()">
                        <option value="2">2 ÂÄã</option>
                        <option value="3">3 ÂÄã</option>
                        <option value="4">4 ÂÄã</option>
                        <option value="5">5 ÂÄã</option>
                    </select>
                </div>
            </div>

            <!-- Ë®≠ÂÆöÂÖßÂÆπÂçÄ -->
            <div class="settings-content" id="settings-content">
                <!-- ÂãïÊÖãËºâÂÖ•Ë®≠ÂÆöË°®ÂñÆ -->
            </div>
        </div>

        <!-- ‰∏≠ÈñìÈ†êË¶ΩÂçÄ -->
        <div class="preview-area">
            <div class="phone-preview">
                <div class="phone-screen">
                    <div class="chat-header">LINE Chat È†êË¶Ω</div>
                    <div class="chat-content" id="preview-content">
                        <!-- ÂãïÊÖãÁî¢ÁîüÈ†êË¶ΩÂÖßÂÆπ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ÂÖ®ÂüüËÆäÊï∏
        let currentTemplate = 'text';
        let currentDisplay = 'single';
        let bubbleCount = 1;
        let templateData = {
            text: {
                bubbles: [{
                    text: 'ÈÄôÊòØ‰∏ÄÊÆµÊñáÂ≠óË®äÊÅØ',
                    size: 'md',
                    color: '#000000',
                    buttons: []
                }]
            },
            card: {
                bubbles: [{
                    image: 'https://via.placeholder.com/300x180',
                    title: 'Âç°ÁâáÊ®ôÈ°å',
                    subtitle: 'ÂâØÊ®ôÈ°å',
                    text: 'ÈÄôË£°ÊòØÂç°ÁâáÁöÑË©≥Á¥∞ÊèèËø∞ÂÖßÂÆπ...',
                    buttons: []
                }]
            }
        };

        // ÂàùÂßãÂåñ
        async function init() {
            // Ê™¢Êü•ÊòØÂê¶ÊúâÊ®°Êùø ID ÂèÉÊï∏
            const urlParams = new URLSearchParams(window.location.search);
            const templateId = urlParams.get('id');
            
            if (templateId) {
                await loadExistingTemplate(templateId);
            } else {
                selectTemplate('text');
                loadSettingsForm();
                updatePreview();
            }
        }

        // ËºâÂÖ•ÁèæÊúâÊ®°Êùø
        async function loadExistingTemplate(templateId) {
            try {
                const response = await fetch('/api/flex-templates/' + templateId);
                const data = await response.json();
                
                if (data.success && data.template) {
                    const template = data.template;
                    document.querySelector('.editor-title').textContent = 'üì± Á∑®ËºØÊ®°Êùø: ' + template.template_name;
                    
                    // Ëß£Êûê flex_content
                    const flexContent = JSON.parse(template.flex_content);
                    parseFlexJson(flexContent);
                    
                    loadSettingsForm();
                    updatePreview();
                } else {
                    alert('ËºâÂÖ•Ê®°ÊùøÂ§±Êïó: ' + (data.error || 'Ê®°Êùø‰∏çÂ≠òÂú®'));
                    // ËºâÂÖ•Â§±ÊïóÊôÇ‰ΩøÁî®È†êË®≠Ê®°Êùø
                    selectTemplate('text');
                    loadSettingsForm();
                    updatePreview();
                }
            } catch (error) {
                console.error('ËºâÂÖ•Ê®°ÊùøÈåØË™§:', error);
                alert('ËºâÂÖ•Ê®°ÊùøÊôÇÁôºÁîüÈåØË™§Ôºå‰ΩøÁî®È†êË®≠Ê®°Êùø');
                selectTemplate('text');
                loadSettingsForm();
                updatePreview();
            }
        }

        // Ëß£Êûê Flex JSON ‰∏¶ËºâÂÖ•Âà∞Á∑®ËºØÂô®
        function parseFlexJson(flexJson) {
            if (flexJson.type === 'carousel') {
                // Ëº™Êí≠Ê®°Âºè
                currentDisplay = 'carousel';
                document.getElementById('displayType').value = 'carousel';
                document.getElementById('bubbleCount').style.display = 'block';
                
                const bubbles = flexJson.contents || [];
                bubbleCount = bubbles.length;
                document.getElementById('bubbleCountSelect').value = bubbleCount.toString();
                
                // Âà§Êñ∑Ê®°ÊùøÈ°ûÂûãÔºàÊ™¢Êü•Á¨¨‰∏ÄÂÄãÊ∞£Ê≥°Ôºâ
                const firstBubble = bubbles[0];
                if (firstBubble && firstBubble.hero) {
                    currentTemplate = 'card';
                    document.querySelector('[data-type="card"]').classList.add('active');
                    document.querySelector('[data-type="text"]').classList.remove('active');
                } else {
                    currentTemplate = 'text';
                    document.querySelector('[data-type="text"]').classList.add('active');
                    document.querySelector('[data-type="card"]').classList.remove('active');
                }
                
                // Ëß£ÊûêÊØèÂÄãÊ∞£Ê≥°
                templateData[currentTemplate].bubbles = bubbles.map(bubble => parseBubbleData(bubble));
                
            } else {
                // ÂñÆ‰∏ÄÊ∞£Ê≥°Ê®°Âºè
                currentDisplay = 'single';
                document.getElementById('displayType').value = 'single';
                document.getElementById('bubbleCount').style.display = 'none';
                bubbleCount = 1;
                
                // Âà§Êñ∑Ê®°ÊùøÈ°ûÂûã
                if (flexJson.hero) {
                    currentTemplate = 'card';
                    document.querySelector('[data-type="card"]').classList.add('active');
                    document.querySelector('[data-type="text"]').classList.remove('active');
                } else {
                    currentTemplate = 'text';
                    document.querySelector('[data-type="text"]').classList.add('active');
                    document.querySelector('[data-type="card"]').classList.remove('active');
                }
                
                // Ëß£ÊûêÊ∞£Ê≥°Ë≥áÊñô
                templateData[currentTemplate].bubbles = [parseBubbleData(flexJson)];
            }
        }

        // Ëß£ÊûêÂñÆ‰∏ÄÊ∞£Ê≥°Ë≥áÊñô
        function parseBubbleData(bubbleJson) {
            const bubbleData = {
                buttons: []
            };
            
            if (currentTemplate === 'text') {
                // Á¥îÊñáÂ≠óÊ®°Âºè
                const textContent = bubbleJson.body?.contents?.find(c => c.type === 'text');
                bubbleData.text = textContent?.text || 'ÊñáÂ≠óÂÖßÂÆπ';
                bubbleData.size = textContent?.size || 'md';
                bubbleData.color = textContent?.color || '#000000';
            } else if (currentTemplate === 'card') {
                // ÂúñÊñáÂç°ÁâáÊ®°Âºè
                bubbleData.image = bubbleJson.hero?.url || 'https://via.placeholder.com/300x180';
                
                const contents = bubbleJson.body?.contents || [];
                bubbleData.title = contents.find(c => c.weight === 'bold')?.text || 'Âç°ÁâáÊ®ôÈ°å';
                bubbleData.subtitle = contents.find(c => c.size === 'sm' && c.color === '#666666')?.text || 'ÂâØÊ®ôÈ°å';
                bubbleData.text = contents.find(c => c.size === 'md' && c.wrap)?.text || 'ÂÖßÂÆπÊñáÂ≠ó';
            }
            
            // Ëß£ÊûêÊåâÈàï
            if (bubbleJson.footer && bubbleJson.footer.contents) {
                bubbleData.buttons = bubbleJson.footer.contents
                    .filter(c => c.type === 'button')
                    .map(btn => ({
                        label: btn.action?.label || 'ÊåâÈàï',
                        uri: btn.action?.uri || 'https://example.com'
                    }));
            }
            
            return bubbleData;
        }

        // ÈÅ∏ÊìáÊ®°ÊùøÈ°ûÂûã
        function selectTemplate(type) {
            currentTemplate = type;
            
            // Êõ¥Êñ∞ÊåâÈàïÁãÄÊÖã
            document.querySelectorAll('.type-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(\`[data-type="\${type}"]\`).classList.add('active');
            
            loadSettingsForm();
            updatePreview();
        }

        // Êõ¥Êñ∞È°ØÁ§∫ÊñπÂºè
        function updateDisplay() {
            currentDisplay = document.getElementById('displayType').value;
            const bubbleCountDiv = document.getElementById('bubbleCount');
            
            if (currentDisplay === 'carousel') {
                bubbleCountDiv.style.display = 'block';
                updateBubbleCount();
            } else {
                bubbleCountDiv.style.display = 'none';
                bubbleCount = 1;
                // ‰øùÁïôÁ¨¨‰∏ÄÂÄãÊ∞£Ê≥°ÔºåÁßªÈô§ÂÖ∂‰ªñ
                templateData[currentTemplate].bubbles = [templateData[currentTemplate].bubbles[0]];
            }
            
            loadSettingsForm();
            updatePreview();
        }

        // Êõ¥Êñ∞Ê∞£Ê≥°Êï∏Èáè
        function updateBubbleCount() {
            const newCount = parseInt(document.getElementById('bubbleCountSelect').value);
            const currentBubbles = templateData[currentTemplate].bubbles;
            
            if (newCount > currentBubbles.length) {
                // Â¢ûÂä†Ê∞£Ê≥°
                for (let i = currentBubbles.length; i < newCount; i++) {
                    currentBubbles.push(JSON.parse(JSON.stringify(currentBubbles[0])));
                }
            } else if (newCount < currentBubbles.length) {
                // Ê∏õÂ∞ëÊ∞£Ê≥°
                templateData[currentTemplate].bubbles = currentBubbles.slice(0, newCount);
            }
            
            bubbleCount = newCount;
            loadSettingsForm();
            updatePreview();
        }

        // ËºâÂÖ•Ë®≠ÂÆöË°®ÂñÆ
        function loadSettingsForm() {
            const settingsContent = document.getElementById('settings-content');
            const bubbles = templateData[currentTemplate].bubbles;
            
            let formHtml = '';
            
            bubbles.forEach((bubble, bubbleIndex) => {
                const bubbleTitle = bubbles.length > 1 ? \`Ê∞£Ê≥° \${bubbleIndex + 1}\` : 'ÂÖßÂÆπË®≠ÂÆö';
                
                formHtml += \`<div style="border-bottom: 2px solid #f0f0f0; padding-bottom: 20px; margin-bottom: 20px;">
                    <h4 style="margin-bottom: 15px; color: #667eea;">\${bubbleTitle}</h4>\`;

                if (currentTemplate === 'text') {
                    formHtml += \`
                        <div class="form-group">
                            <label class="form-label">ÊñáÂ≠óÂÖßÂÆπ</label>
                            <textarea class="form-textarea" onchange="updateBubbleData(\${bubbleIndex}, 'text', this.value)">\${bubble.text}</textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">ÊñáÂ≠óÂ§ßÂ∞è</label>
                            <select class="form-select" onchange="updateBubbleData(\${bubbleIndex}, 'size', this.value)">
                                <option value="xs" \${bubble.size === 'xs' ? 'selected' : ''}>Ê•µÂ∞è</option>
                                <option value="sm" \${bubble.size === 'sm' ? 'selected' : ''}>Â∞è</option>
                                <option value="md" \${bubble.size === 'md' ? 'selected' : ''}>‰∏≠Á≠â</option>
                                <option value="lg" \${bubble.size === 'lg' ? 'selected' : ''}>Â§ß</option>
                                <option value="xl" \${bubble.size === 'xl' ? 'selected' : ''}>ÁâπÂ§ß</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">ÊñáÂ≠óÈ°èËâ≤</label>
                            <input type="color" class="color-input" value="\${bubble.color}" onchange="updateBubbleData(\${bubbleIndex}, 'color', this.value)">
                        </div>\`;
                } else if (currentTemplate === 'card') {
                    formHtml += \`
                        <div class="form-group">
                            <label class="form-label">ÂúñÁâáÁ∂≤ÂùÄ</label>
                            <input type="url" class="form-input" value="\${bubble.image}" onchange="updateBubbleData(\${bubbleIndex}, 'image', this.value)" placeholder="https://example.com/image.jpg">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Ê®ôÈ°å</label>
                            <input type="text" class="form-input" value="\${bubble.title}" onchange="updateBubbleData(\${bubbleIndex}, 'title', this.value)">
                        </div>
                        <div class="form-group">
                            <label class="form-label">ÂâØÊ®ôÈ°å</label>
                            <input type="text" class="form-input" value="\${bubble.subtitle}" onchange="updateBubbleData(\${bubbleIndex}, 'subtitle', this.value)">
                        </div>
                        <div class="form-group">
                            <label class="form-label">ÂÖßÂÆπÊñáÂ≠ó</label>
                            <textarea class="form-textarea" onchange="updateBubbleData(\${bubbleIndex}, 'text', this.value)">\${bubble.text}</textarea>
                        </div>\`;
                }

                // ÊåâÈàïË®≠ÂÆö
                formHtml += \`
                    <div class="form-group">
                        <label class="form-label">ÊåâÈàïË®≠ÂÆö</label>
                        <div class="button-list" id="buttons-\${bubbleIndex}">
                \`;

                bubble.buttons.forEach((button, buttonIndex) => {
                    formHtml += \`
                        <div class="button-item">
                            <input type="text" placeholder="ÊåâÈàïÊñáÂ≠ó" value="\${button.label}" onchange="updateButtonData(\${bubbleIndex}, \${buttonIndex}, 'label', this.value)">
                            <input type="url" placeholder="ÈÄ£ÁµêÁ∂≤ÂùÄ" value="\${button.uri}" onchange="updateButtonData(\${bubbleIndex}, \${buttonIndex}, 'uri', this.value)">
                            <button class="remove-btn" onclick="removeButton(\${bubbleIndex}, \${buttonIndex})">Âà™Èô§</button>
                        </div>
                    \`;
                });

                formHtml += \`
                        </div>
                        <button class="add-btn" onclick="addButton(\${bubbleIndex})">‚ûï Êñ∞Â¢ûÊåâÈàï</button>
                    </div>
                </div>\`;
            });

            settingsContent.innerHTML = formHtml;
        }

        // Êõ¥Êñ∞Ê∞£Ê≥°Ë≥áÊñô
        function updateBubbleData(bubbleIndex, field, value) {
            templateData[currentTemplate].bubbles[bubbleIndex][field] = value;
            updatePreview();
        }

        // Êõ¥Êñ∞ÊåâÈàïË≥áÊñô
        function updateButtonData(bubbleIndex, buttonIndex, field, value) {
            templateData[currentTemplate].bubbles[bubbleIndex].buttons[buttonIndex][field] = value;
            updatePreview();
        }

        // Êñ∞Â¢ûÊåâÈàï
        function addButton(bubbleIndex) {
            templateData[currentTemplate].bubbles[bubbleIndex].buttons.push({
                label: 'Êñ∞ÊåâÈàï',
                uri: 'https://example.com'
            });
            loadSettingsForm();
            updatePreview();
        }

        // ÁßªÈô§ÊåâÈàï
        function removeButton(bubbleIndex, buttonIndex) {
            templateData[currentTemplate].bubbles[bubbleIndex].buttons.splice(buttonIndex, 1);
            loadSettingsForm();
            updatePreview();
        }

        // Êõ¥Êñ∞È†êË¶Ω
        function updatePreview() {
            const previewContent = document.getElementById('preview-content');
            const bubbles = templateData[currentTemplate].bubbles;
            
            if (currentDisplay === 'carousel' && bubbles.length > 1) {
                // Ëº™Êí≠È°ØÁ§∫
                let carouselHtml = '<div class="carousel-container">';
                bubbles.forEach((bubble, index) => {
                    carouselHtml += \`<div class="carousel-bubble">\${renderBubble(bubble)}</div>\`;
                });
                carouselHtml += '</div>';
                previewContent.innerHTML = carouselHtml;
            } else {
                // ÂñÆ‰∏ÄÊ∞£Ê≥°È°ØÁ§∫
                previewContent.innerHTML = bubbles.map(bubble => 
                    \`<div class="message-bubble">\${renderBubble(bubble)}</div>\`
                ).join('');
            }
        }

        // Ê∏≤ÊüìÊ∞£Ê≥°ÂÖßÂÆπ
        function renderBubble(bubble) {
            let bubbleHtml = '';
            
            if (currentTemplate === 'text') {
                const fontSize = getSizePixels(bubble.size);
                bubbleHtml = \`
                    <div class="bubble-content">
                        <div class="bubble-text" style="font-size: \${fontSize}; color: \${bubble.color};">
                            \${bubble.text.replace(/\\n/g, '<br>')}
                        </div>
                    </div>
                \`;
            } else if (currentTemplate === 'card') {
                bubbleHtml = \`
                    <img src="\${bubble.image}" class="bubble-image" alt="Âç°ÁâáÂúñÁâá">
                    <div class="bubble-content">
                        <div class="bubble-title">\${bubble.title}</div>
                        <div class="bubble-subtitle">\${bubble.subtitle}</div>
                        <div class="bubble-text">\${bubble.text.replace(/\\n/g, '<br>')}</div>
                    </div>
                \`;
            }
            
            // Êñ∞Â¢ûÊåâÈàï
            if (bubble.buttons && bubble.buttons.length > 0) {
                bubbleHtml += '<div class="bubble-buttons">';
                bubble.buttons.forEach((button, index) => {
                    const buttonClass = index === 0 ? 'bubble-button' : 'bubble-button secondary';
                    bubbleHtml += \`<button class="\${buttonClass}">\${button.label}</button>\`;
                });
                bubbleHtml += '</div>';
            }
            
            return bubbleHtml;
        }

        // ËºîÂä©ÂáΩÊï∏ÔºöÂ∞∫ÂØ∏ËΩâÂÉèÁ¥†
        function getSizePixels(size) {
            const sizeMap = {
                'xs': '12px',
                'sm': '14px', 
                'md': '16px',
                'lg': '18px',
                'xl': '20px'
            };
            return sizeMap[size] || '16px';
        }

        // ÁîüÊàê Flex JSON
        function generateFlexJson() {
            const bubbles = templateData[currentTemplate].bubbles;
            
            if (currentDisplay === 'carousel' && bubbles.length > 1) {
                // Carousel Ê†ºÂºè
                return {
                    type: 'carousel',
                    contents: bubbles.map(bubble => generateBubbleJson(bubble))
                };
            } else {
                // ÂñÆ‰∏Ä Bubble Ê†ºÂºè
                return generateBubbleJson(bubbles[0]);
            }
        }

        // ÁîüÊàêÂñÆ‰∏ÄÊ∞£Ê≥° JSON
        function generateBubbleJson(bubble) {
            const bubbleJson = {
                type: 'bubble'
            };

            if (currentTemplate === 'card') {
                // ÂúñÁâáÂçÄÂüü
                bubbleJson.hero = {
                    type: 'image',
                    url: bubble.image,
                    size: 'full',
                    aspectRatio: '20:13',
                    aspectMode: 'cover'
                };
            }

            // ÂÖßÂÆπÂçÄÂüü
            const contents = [];
            
            if (currentTemplate === 'text') {
                contents.push({
                    type: 'text',
                    text: bubble.text,
                    size: bubble.size,
                    color: bubble.color,
                    wrap: true
                });
            } else if (currentTemplate === 'card') {
                contents.push({
                    type: 'text',
                    text: bubble.title,
                    weight: 'bold',
                    size: 'lg'
                });
                
                if (bubble.subtitle) {
                    contents.push({
                        type: 'text',
                        text: bubble.subtitle,
                        size: 'sm',
                        color: '#666666',
                        margin: 'md'
                    });
                }
                
                contents.push({
                    type: 'text',
                    text: bubble.text,
                    size: 'md',
                    color: '#333333',
                    margin: 'md',
                    wrap: true
                });
            }

            bubbleJson.body = {
                type: 'box',
                layout: 'vertical',
                contents: contents
            };

            // ÊåâÈàïÂçÄÂüü
            if (bubble.buttons && bubble.buttons.length > 0) {
                bubbleJson.footer = {
                    type: 'box',
                    layout: 'vertical',
                    spacing: 'sm',
                    contents: bubble.buttons.map((button, index) => ({
                        type: 'button',
                        style: index === 0 ? 'primary' : 'secondary',
                        height: 'sm',
                        action: {
                            type: 'uri',
                            label: button.label,
                            uri: button.uri
                        }
                    }))
                };
            }

            return bubbleJson;
        }

        // Â∑•ÂÖ∑ÂàóÂäüËÉΩ
        function showJsonPreview() {
            const flexJson = generateFlexJson();
            const jsonWindow = window.open('', '_blank', 'width=800,height=600');
            jsonWindow.document.write(\`
                <html>
                    <head><title>Flex Message JSON</title></head>
                    <body style="font-family: monospace; padding: 20px;">
                        <h3>ÁîüÊàêÁöÑ Flex Message JSON</h3>
                        <pre style="background: #f5f5f5; padding: 15px; border-radius: 8px; overflow: auto; white-space: pre-wrap;">\${JSON.stringify(flexJson, null, 2)}</pre>
                        <br>
                        <button onclick="navigator.clipboard.writeText('\${JSON.stringify(flexJson).replace(/'/g, "\\\\'")}'); alert('JSON Â∑≤Ë§áË£ΩÂà∞Ââ™Ë≤ºÁ∞ø!');" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer;">üìã Ë§áË£Ω JSON</button>
                        <button onclick="window.close();" style="margin-left: 10px; padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer;">‚úï ÈóúÈñâ</button>
                    </body>
                </html>
            \`);
        }

        function previewInNewWindow() {
            alert('È†êË¶ΩÂäüËÉΩÈñãÁôº‰∏≠...');
        }

        async function saveTemplate() {
            const flexJson = generateFlexJson();
            const templateName = prompt('Ë´ãËº∏ÂÖ•Ê®°ÊùøÂêçÁ®±:');
            
            if (!templateName) return;
            
            try {
                const response = await fetch('/api/flex-templates', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        template_name: templateName,
                        description: \`\${currentTemplate === 'text' ? 'Á¥îÊñáÂ≠ó' : 'ÂúñÊñáÂç°Áâá'}Ê®°Êùø\`,
                        template_type: currentDisplay === 'carousel' ? 'carousel' : 'bubble',
                        flex_content: JSON.stringify(flexJson),
                        category: 'custom'
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('Ê®°ÊùøÂÑ≤Â≠òÊàêÂäüÔºÅ\\nÊ®°Êùø ID: ' + result.template_id);
                } else {
                    alert('ÂÑ≤Â≠òÂ§±ÊïóÔºö' + result.error);
                }
            } catch (error) {
                alert('ÂÑ≤Â≠òÂá∫ÈåØÔºö' + error.message);
            }
        }

        // ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>`;

  return new Response(flexSimpleEditorHtml, {
    headers: { 'Content-Type': 'text/html; charset=utf-8' }
  });
}