// Flex Carousel å°ˆæ¥­ç·¨è¼¯å™¨ - æˆ¿åœ°ç”¢å°ˆç”¨
export async function onRequest(context) {
  const { request, env } = context;
  const url = new URL(request.url);
  const templateId = url.searchParams.get('id');
  const categoryId = url.searchParams.get('category') || 'construction_progress';

  const flexCarouselEditorHtml = `<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flex Carousel ç·¨è¼¯å™¨ - æˆ¿åœ°ç”¢å°ˆç”¨</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            height: 100vh;
            overflow: hidden;
        }

        /* é ­éƒ¨å·¥å…·åˆ— */
        .editor-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        .editor-title {
            font-size: 20px;
            font-weight: bold;
        }

        .editor-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 14px;
        }

        .btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .btn-primary {
            background: rgba(255,255,255,0.9);
            color: #667eea;
            font-weight: 500;
        }

        /* ä¸»è¦ç·¨è¼¯å€åŸŸ */
        .editor-main {
            display: flex;
            height: calc(100vh - 70px);
        }

        /* å·¦å´æ¨¡æ¿é¸æ“‡é¢æ¿ */
        .template-panel {
            width: 280px;
            background: white;
            border-right: 1px solid #e1e8ed;
            display: flex;
            flex-direction: column;
        }

        .panel-header {
            padding: 20px;
            border-bottom: 1px solid #e1e8ed;
            background: #f8f9fa;
        }

        .panel-title {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        .template-categories {
            flex: 1;
            padding: 0;
            overflow-y: auto;
        }

        .category-item {
            border-bottom: 1px solid #f0f0f0;
        }

        .category-header {
            padding: 15px 20px;
            background: #f8f9fa;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: background 0.2s;
        }

        .category-header:hover {
            background: #e9ecef;
        }

        .category-header.active {
            background: #667eea;
            color: white;
        }

        .category-icon {
            font-size: 18px;
            margin-right: 10px;
        }

        .category-name {
            flex: 1;
            font-weight: 500;
        }

        .category-arrow {
            transition: transform 0.2s;
        }

        .category-header.expanded .category-arrow {
            transform: rotate(90deg);
        }

        .category-templates {
            display: none;
            padding: 10px 20px;
            background: white;
        }

        .category-item.expanded .category-templates {
            display: block;
        }

        .template-item {
            padding: 8px 0;
            font-size: 14px;
            color: #666;
            cursor: pointer;
            border-radius: 4px;
            padding-left: 8px;
        }

        .template-item:hover {
            background: #f8f9ff;
            color: #667eea;
        }

        /* ä¸­é–“å…§å®¹ç·¨è¼¯å€ */
        .content-editor {
            flex: 1;
            background: white;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #e1e8ed;
        }

        .tabs-header {
            padding: 15px 20px;
            border-bottom: 1px solid #e1e8ed;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .carousel-tabs {
            display: flex;
            gap: 8px;
            flex: 1;
        }

        .tab-item {
            background: #e9ecef;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .tab-item:hover {
            background: #dee2e6;
        }

        .tab-item.active {
            background: #667eea;
            color: white;
        }

        .tab-close {
            margin-left: 8px;
            font-weight: bold;
            opacity: 0.7;
        }

        .tab-close:hover {
            opacity: 1;
        }

        .add-tab {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
        }

        .content-form {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .form-section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #f0f0f0;
        }

        .form-section:last-child {
            border-bottom: none;
        }

        .section-title {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .section-icon {
            margin-right: 8px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 6px;
            font-size: 14px;
            font-weight: 500;
            color: #333;
        }

        .form-input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e1e8ed;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-textarea {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e1e8ed;
            border-radius: 6px;
            font-size: 14px;
            resize: vertical;
            min-height: 80px;
        }

        .form-select {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e1e8ed;
            border-radius: 6px;
            font-size: 14px;
            background: white;
        }

        /* åœ–ç‰‡ä¸Šå‚³å€ */
        .image-upload {
            border: 2px dashed #e1e8ed;
            border-radius: 8px;
            padding: 30px 20px;
            text-align: center;
            background: #fafbfc;
            transition: all 0.2s;
            cursor: pointer;
            position: relative;
        }

        .image-upload:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .image-upload.dragover {
            border-color: #667eea;
            background: #f0f2ff;
        }

        .upload-icon {
            font-size: 48px;
            color: #ccc;
            margin-bottom: 15px;
        }

        .upload-text {
            color: #666;
            margin-bottom: 10px;
        }

        .upload-hint {
            font-size: 12px;
            color: #999;
        }

        .image-preview {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .image-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        /* æŒ‰éˆ•ç®¡ç† */
        .buttons-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
        }

        .button-list {
            margin-bottom: 15px;
        }

        .button-item {
            background: white;
            border: 1px solid #e1e8ed;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 10px;
            position: relative;
        }

        .button-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .button-type-select {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
        }

        .button-remove {
            background: #dc3545;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
        }

        .button-fields {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .button-fields input {
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
        }

        .add-button {
            width: 100%;
            background: #28a745;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
        }

        /* å³å´é è¦½å€ */
        .preview-area {
            width: 400px;
            background: #f0f2f5;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 30px 20px;
        }

        .phone-preview {
            width: 320px;
            height: 580px;
            background: #000;
            border-radius: 25px;
            padding: 15px 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            position: relative;
        }

        .phone-screen {
            width: 100%;
            height: 100%;
            background: #f0f0f0;
            border-radius: 18px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            background: #00b300;
            color: white;
            padding: 12px;
            font-size: 14px;
            font-weight: bold;
            text-align: center;
        }

        .chat-content {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
        }

        .carousel-preview {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding: 10px 0;
        }

        .bubble-preview {
            min-width: 200px;
            max-width: 200px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .bubble-image {
            width: 100%;
            height: 100px;
            object-fit: cover;
            background: #f0f0f0;
        }

        .bubble-content {
            padding: 12px;
        }

        .bubble-title {
            font-size: 14px;
            font-weight: bold;
            color: #333;
            margin-bottom: 4px;
        }

        .bubble-price {
            font-size: 16px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 8px;
        }

        .bubble-buttons {
            padding: 8px 12px;
            border-top: 1px solid #f0f0f0;
        }

        .bubble-button {
            display: block;
            width: 100%;
            padding: 8px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 4px;
            margin-bottom: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .bubble-button:last-child {
            margin-bottom: 0;
        }

        .bubble-button.secondary {
            background: #f8f9fa;
            color: #333;
            border: 1px solid #dee2e6;
        }

        .bubble-button.share {
            background: #1db446;
        }

        /* è®Šæ•¸é¢æ¿ */
        .variables-panel {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }

        .variables-title {
            font-size: 14px;
            font-weight: bold;
            color: #856404;
            margin-bottom: 10px;
        }

        .variable-item {
            background: white;
            padding: 8px 10px;
            border-radius: 4px;
            margin-bottom: 5px;
            font-size: 12px;
            font-family: monospace;
            border: 1px solid #f0e68c;
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 1400px) {
            .template-panel {
                width: 250px;
            }
            .preview-area {
                width: 350px;
            }
            .phone-preview {
                width: 280px;
                height: 500px;
            }
        }
    </style>
</head>
<body>
    <!-- é ­éƒ¨å·¥å…·åˆ— -->
    <div class="editor-header">
        <div class="editor-title">ğŸ—ï¸ Flex Carousel ç·¨è¼¯å™¨</div>
        <div class="editor-actions">
            <button class="btn" onclick="loadProject()">ğŸ“‚ è¼‰å…¥å»ºæ¡ˆ</button>
            <button class="btn" onclick="showJsonPreview()">ğŸ“ æª¢è¦– JSON</button>
            <button class="btn" onclick="previewInNewWindow()">ğŸ‘ï¸ é è¦½</button>
            <button class="btn" onclick="saveTemplate()">ğŸ’¾ å„²å­˜æ¨¡æ¿</button>
            <button class="btn btn-primary" onclick="window.close()">âœ• é—œé–‰</button>
        </div>
    </div>

    <!-- ä¸»è¦ç·¨è¼¯å€åŸŸ -->
    <div class="editor-main">
        <!-- å·¦å´æ¨¡æ¿é¢æ¿ -->
        <div class="template-panel">
            <div class="panel-header">
                <div class="panel-title">ğŸ“‹ æ¨¡æ¿é¡åˆ¥</div>
                <div style="font-size: 12px; color: #666;">é¸æ“‡æˆ–å»ºç«‹æ¨¡æ¿</div>
            </div>
            <div class="template-categories">
                <!-- å‹•æ…‹è¼‰å…¥æ¨¡æ¿é¡åˆ¥ -->
            </div>
        </div>

        <!-- ä¸­é–“å…§å®¹ç·¨è¼¯å€ -->
        <div class="content-editor">
            <div class="tabs-header">
                <div class="carousel-tabs" id="carousel-tabs">
                    <!-- å‹•æ…‹è¼‰å…¥åˆ†é æ¨™ç±¤ -->
                </div>
                <button class="add-tab" onclick="addNewTab()">+ æ–°å¢åˆ†é </button>
            </div>

            <div class="content-form" id="content-form">
                <!-- å‹•æ…‹è¼‰å…¥è¡¨å–®å…§å®¹ -->
            </div>
        </div>

        <!-- å³å´é è¦½å€ -->
        <div class="preview-area">
            <div class="phone-preview">
                <div class="phone-screen">
                    <div class="chat-header">LINE Chat é è¦½</div>
                    <div class="chat-content">
                        <div class="carousel-preview" id="carousel-preview">
                            <!-- å‹•æ…‹ç”¢ç”Ÿé è¦½å…§å®¹ -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- è®Šæ•¸é¢æ¿ -->
            <div class="variables-panel">
                <div class="variables-title">ğŸ”§ å¯ç”¨è®Šæ•¸</div>
                <div id="variables-list">
                    <div class="variable-item">{{project_name}} - å»ºæ¡ˆåç¨±</div>
                    <div class="variable-item">{{date}} - ä»Šæ—¥æ—¥æœŸ</div>
                    <div class="variable-item">{{building_count}} - æ£Ÿæ•¸</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨åŸŸè®Šæ•¸
        let currentCategory = '${categoryId}';
        let currentTabIndex = 0;
        let carouselData = {
            type: 'carousel',
            contents: []
        };
        let templateCategories = [];

        // åˆå§‹åŒ–ç·¨è¼¯å™¨
        async function init() {
            console.log('Carousel ç·¨è¼¯å™¨åˆå§‹åŒ–...');
            
            await loadTemplateCategories();
            await loadDefaultTemplate();
            
            // æª¢æŸ¥æ˜¯å¦æœ‰æ¨¡æ¿ ID
            const urlParams = new URLSearchParams(window.location.search);
            const templateId = urlParams.get('id');
            
            if (templateId) {
                await loadExistingTemplate(templateId);
            }
            
            updateTabs();
            updatePreview();
            updateVariablesList();
        }

        // è¼‰å…¥æ¨¡æ¿é¡åˆ¥
        async function loadTemplateCategories() {
            try {
                const response = await fetch('/api/template-categories');
                const data = await response.json();
                
                if (data.success) {
                    templateCategories = data.categories;
                    renderTemplateCategories();
                }
            } catch (error) {
                console.error('è¼‰å…¥æ¨¡æ¿é¡åˆ¥å¤±æ•—:', error);
                // ä½¿ç”¨é è¨­é¡åˆ¥
                templateCategories = [
                    { category_id: 'construction_progress', category_name: 'å·¥åœ°é€²åº¦æ¨é€', icon: 'ğŸ—ï¸' },
                    { category_id: 'new_project_launch', category_name: 'æ–°å»ºæ¡ˆé–‹è³£', icon: 'ğŸ¢' },
                    { category_id: 'completion_handover', category_name: 'å®Œå·¥äº¤å±‹é€šçŸ¥', icon: 'ğŸ—ï¸' },
                    { category_id: 'sales_update', category_name: 'éŠ·å”®é€²åº¦æ›´æ–°', icon: 'ğŸ“Š' },
                    { category_id: 'event_promotion', category_name: 'æ´»å‹•æ¨å»£', icon: 'ğŸ‰' }
                ];
                renderTemplateCategories();
            }
        }

        // æ¸²æŸ“æ¨¡æ¿é¡åˆ¥
        function renderTemplateCategories() {
            const container = document.querySelector('.template-categories');
            let html = '';
            
            templateCategories.forEach(category => {
                const isActive = category.category_id === currentCategory;
                html += \`
                    <div class="category-item \\${isActive ? 'expanded' : ''}">
                        <div class="category-header \\${isActive ? 'active' : ''}" onclick="toggleCategory('\\${category.category_id}')">
                            <span class="category-icon">\\${category.icon}</span>
                            <span class="category-name">\\${category.category_name}</span>
                            <span class="category-arrow">â–¶</span>
                        </div>
                        <div class="category-templates">
                            <div class="template-item" onclick="selectTemplate('\\${category.category_id}', 'default')">
                                é è¨­æ¨¡æ¿
                            </div>
                            <div class="template-item" onclick="selectTemplate('\\${category.category_id}', 'custom')">
                                è‡ªè¨‚æ¨¡æ¿
                            </div>
                        </div>
                    </div>
                \`;
            });
            
            container.innerHTML = html;
        }

        // åˆ‡æ›é¡åˆ¥
        function toggleCategory(categoryId) {
            const categoryItem = document.querySelector(\`[onclick="toggleCategory('\\${categoryId}')"]\`).parentElement;
            const header = categoryItem.querySelector('.category-header');
            
            // é—œé–‰å…¶ä»–é¡åˆ¥
            document.querySelectorAll('.category-item').forEach(item => {
                if (item !== categoryItem) {
                    item.classList.remove('expanded');
                    item.querySelector('.category-header').classList.remove('expanded');
                }
            });
            
            // åˆ‡æ›ç•¶å‰é¡åˆ¥
            categoryItem.classList.toggle('expanded');
            header.classList.toggle('expanded');
        }

        // é¸æ“‡æ¨¡æ¿
        function selectTemplate(categoryId, templateType) {
            currentCategory = categoryId;
            document.title = \`Flex ç·¨è¼¯å™¨ - \\${templateCategories.find(c => c.category_id === categoryId)?.category_name || 'æ¨¡æ¿'}\`;
            
            // æ›´æ–°æ¨™é¡Œ
            const categoryName = templateCategories.find(c => c.category_id === categoryId)?.category_name || 'æ¨¡æ¿';
            const categoryIcon = templateCategories.find(c => c.category_id === categoryId)?.icon || 'ğŸ“';
            document.querySelector('.editor-title').textContent = \`\\${categoryIcon} \\${categoryName} ç·¨è¼¯å™¨\`;
            
            loadDefaultTemplate();
            updateTabs();
            updatePreview();
        }

        // è¼‰å…¥é è¨­æ¨¡æ¿
        function loadDefaultTemplate() {
            // æ ¹æ“šé¡åˆ¥è¼‰å…¥ä¸åŒçš„é è¨­æ¨¡æ¿
            switch(currentCategory) {
                case 'construction_progress':
                    carouselData = {
                        type: 'carousel',
                        contents: [
                            createDefaultBubble('å·¥ç¨‹é€²åº¦æ›´æ–°', '{{project_name}} Aæ£Ÿ', 'é€²åº¦: {{progress}}%'),
                            createDefaultBubble('æ–½å·¥ç…§ç‰‡', '{{project_name}} Bæ£Ÿ', 'é€²åº¦: {{progress}}%'),
                            createSeeMoreBubble()
                        ]
                    };
                    break;
                case 'new_project_launch':
                    carouselData = {
                        type: 'carousel',
                        contents: [
                            createDefaultBubble('æ–°æ¡ˆæ¨å‡º', '{{project_name}}', 'èµ·åƒ¹ {{price}} è¬'),
                            createDefaultBubble('é ç´„è³å±‹', 'é™æ™‚å„ªæƒ ', 'ç¾åœ¨é ç´„äº«å„ªæƒ '),
                            createSeeMoreBubble()
                        ]
                    };
                    break;
                default:
                    carouselData = {
                        type: 'carousel',
                        contents: [
                            createDefaultBubble('æ¨™é¡Œ', 'å‰¯æ¨™é¡Œ', 'å…§å®¹æè¿°'),
                            createSeeMoreBubble()
                        ]
                    };
            }
        }

        // å»ºç«‹é è¨­æ°£æ³¡
        function createDefaultBubble(title, subtitle, description) {
            return {
                type: 'bubble',
                hero: {
                    type: 'image',
                    size: 'full',
                    aspectRatio: '20:13',
                    aspectMode: 'cover',
                    url: 'https://via.placeholder.com/300x195/667eea/white?text=' + encodeURIComponent(title)
                },
                body: {
                    type: 'box',
                    layout: 'vertical',
                    spacing: 'sm',
                    contents: [
                        {
                            type: 'text',
                            text: title,
                            wrap: true,
                            weight: 'bold',
                            size: 'xl'
                        },
                        {
                            type: 'text',
                            text: subtitle,
                            wrap: true,
                            size: 'sm',
                            color: '#666666'
                        },
                        {
                            type: 'text',
                            text: description,
                            wrap: true,
                            size: 'sm',
                            margin: 'md'
                        }
                    ]
                },
                footer: {
                    type: 'box',
                    layout: 'vertical',
                    spacing: 'sm',
                    contents: [
                        {
                            type: 'button',
                            style: 'primary',
                            action: {
                                type: 'uri',
                                label: 'æŸ¥çœ‹è©³æƒ…',
                                uri: 'https://example.com'
                            }
                        }
                    ]
                }
            };
        }

        // å»ºç«‹"æŸ¥çœ‹æ›´å¤š"æ°£æ³¡
        function createSeeMoreBubble() {
            return {
                type: 'bubble',
                body: {
                    type: 'box',
                    layout: 'vertical',
                    spacing: 'sm',
                    contents: [
                        {
                            type: 'button',
                            flex: 1,
                            gravity: 'center',
                            action: {
                                type: 'uri',
                                label: 'æŸ¥çœ‹æ›´å¤š',
                                uri: 'https://example.com'
                            }
                        }
                    ]
                }
            };
        }

        // æ›´æ–°åˆ†é æ¨™ç±¤
        function updateTabs() {
            const tabsContainer = document.getElementById('carousel-tabs');
            let html = '';
            
            carouselData.contents.forEach((bubble, index) => {
                const isActive = index === currentTabIndex;
                const title = getBubbleTitle(bubble, index);
                html += \`
                    <button class="tab-item \\${isActive ? 'active' : ''}" onclick="selectTab(\\${index})">
                        \\${title}
                        \\${carouselData.contents.length > 1 ? \`<span class="tab-close" onclick="event.stopPropagation(); removeTab(\\${index})">Ã—</span>\` : ''}
                    </button>
                \`;
            });
            
            tabsContainer.innerHTML = html;
            loadTabContent();
        }

        // å–å¾—æ°£æ³¡æ¨™é¡Œ
        function getBubbleTitle(bubble, index) {
            if (bubble.body?.contents?.[0]?.text) {
                return bubble.body.contents[0].text.substring(0, 10) + '...';
            }
            return \`åˆ†é  \\${index + 1}\`;
        }

        // é¸æ“‡åˆ†é 
        function selectTab(index) {
            if (index >= 0 && index < carouselData.contents.length) {
                currentTabIndex = index;
                updateTabs();
            }
        }

        // æ–°å¢åˆ†é 
        function addNewTab() {
            const newBubble = createDefaultBubble('æ–°åˆ†é ', 'å‰¯æ¨™é¡Œ', 'å…§å®¹æè¿°');
            carouselData.contents.splice(-1, 0, newBubble); // æ’å…¥åˆ°æœ€å¾Œä¸€å€‹ä¹‹å‰
            currentTabIndex = carouselData.contents.length - 2; // é¸ä¸­æ–°å¢çš„åˆ†é 
            updateTabs();
            updatePreview();
        }

        // ç§»é™¤åˆ†é 
        function removeTab(index) {
            if (carouselData.contents.length > 2) { // è‡³å°‘ä¿ç•™2å€‹åˆ†é 
                carouselData.contents.splice(index, 1);
                if (currentTabIndex >= carouselData.contents.length) {
                    currentTabIndex = carouselData.contents.length - 1;
                }
                if (currentTabIndex >= index && currentTabIndex > 0) {
                    currentTabIndex--;
                }
                updateTabs();
                updatePreview();
            } else {
                alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€å€‹å…§å®¹åˆ†é å’Œä¸€å€‹"æŸ¥çœ‹æ›´å¤š"åˆ†é ');
            }
        }

        // è¼‰å…¥åˆ†é å…§å®¹è¡¨å–®
        function loadTabContent() {
            const form = document.getElementById('content-form');
            const bubble = carouselData.contents[currentTabIndex];
            
            if (!bubble) return;
            
            // æª¢æŸ¥æ˜¯å¦æ˜¯"æŸ¥çœ‹æ›´å¤š"åˆ†é 
            const isSeeMore = bubble.body?.contents?.length === 1 && 
                            bubble.body.contents[0].type === 'button';
            
            if (isSeeMore) {
                form.innerHTML = \`
                    <div class="form-section">
                        <div class="section-title">
                            <span class="section-icon">ğŸ”—</span>
                            æŸ¥çœ‹æ›´å¤šæŒ‰éˆ•è¨­å®š
                        </div>
                        <div class="form-group">
                            <label class="form-label">æŒ‰éˆ•æ–‡å­—</label>
                            <input type="text" class="form-input" value="\\${bubble.body.contents[0].action?.label || 'æŸ¥çœ‹æ›´å¤š'}" 
                                   onchange="updateSeeMoreButton('label', this.value)">
                        </div>
                        <div class="form-group">
                            <label class="form-label">é€£çµç¶²å€</label>
                            <input type="url" class="form-input" value="\\${bubble.body.contents[0].action?.uri || 'https://example.com'}" 
                                   onchange="updateSeeMoreButton('uri', this.value)">
                        </div>
                    </div>
                \`;
            } else {
                // ä¸€èˆ¬å…§å®¹åˆ†é 
                const hero = bubble.hero;
                const body = bubble.body?.contents || [];
                const title = body.find(c => c.weight === 'bold')?.text || '';
                const subtitle = body.find(c => c.size === 'sm' && c.color === '#666666')?.text || '';
                const description = body.find(c => c.wrap && c.margin)?.text || '';
                const buttons = bubble.footer?.contents || [];
                
                form.innerHTML = \`
                    <!-- åœ–ç‰‡è¨­å®š -->
                    <div class="form-section">
                        <div class="section-title">
                            <span class="section-icon">ğŸ–¼ï¸</span>
                            ä¸»åœ–è¨­å®š
                        </div>
                        <div class="form-group">
                            <label class="form-label">åœ–ç‰‡</label>
                            <div class="image-upload" onclick="uploadImage()" ondrop="handleImageDrop(event)" ondragover="handleImageDragover(event)">
                                \\${hero?.url ? `
                                    <img src="\\${hero.url}" class="image-preview" alt="é è¦½åœ–ç‰‡">
                                    <div class="image-actions">
                                        <button type="button" onclick="event.stopPropagation(); uploadImage()" style="background: #667eea; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; margin-right: 10px;">æ›´æ›åœ–ç‰‡</button>
                                        <button type="button" onclick="event.stopPropagation(); removeImage()" style="background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;">ç§»é™¤åœ–ç‰‡</button>
                                    </div>
                                ` : `
                                    <div class="upload-icon">ğŸ“¸</div>
                                    <div class="upload-text">é»æ“Šæˆ–æ‹–æ‹½åœ–ç‰‡åˆ°æ­¤è™•ä¸Šå‚³</div>
                                    <div class="upload-hint">æ”¯æ´ JPGã€PNGã€GIF æ ¼å¼ï¼Œæœ€å¤§ 5MB</div>
                                `}
                            </div>
                        </div>
                    </div>

                    <!-- å…§å®¹è¨­å®š -->
                    <div class="form-section">
                        <div class="section-title">
                            <span class="section-icon">ğŸ“</span>
                            å…§å®¹è¨­å®š
                        </div>
                        <div class="form-group">
                            <label class="form-label">ä¸»æ¨™é¡Œ</label>
                            <input type="text" class="form-input" value="\\${title}" onchange="updateBubbleText('title', this.value)" placeholder="è«‹è¼¸å…¥ä¸»æ¨™é¡Œ">
                        </div>
                        <div class="form-group">
                            <label class="form-label">å‰¯æ¨™é¡Œ</label>
                            <input type="text" class="form-input" value="\\${subtitle}" onchange="updateBubbleText('subtitle', this.value)" placeholder="è«‹è¼¸å…¥å‰¯æ¨™é¡Œ">
                        </div>
                        <div class="form-group">
                            <label class="form-label">å…§å®¹æè¿°</label>
                            <textarea class="form-textarea" onchange="updateBubbleText('description', this.value)" placeholder="è«‹è¼¸å…¥å…§å®¹æè¿°">\\${description}</textarea>
                        </div>
                    </div>

                    <!-- æŒ‰éˆ•è¨­å®š -->
                    <div class="form-section">
                        <div class="section-title">
                            <span class="section-icon">ğŸ”˜</span>
                            æŒ‰éˆ•è¨­å®š
                        </div>
                        <div class="buttons-section">
                            <div class="button-list" id="button-list">
                                <!-- å‹•æ…‹ç”¢ç”ŸæŒ‰éˆ•åˆ—è¡¨ -->
                            </div>
                            <button class="add-button" onclick="addButton()">â• æ–°å¢æŒ‰éˆ•</button>
                        </div>
                    </div>
                \`;
                
                // è¼‰å…¥æŒ‰éˆ•åˆ—è¡¨
                loadButtonList();
            }
        }

        // æ›´æ–°"æŸ¥çœ‹æ›´å¤š"æŒ‰éˆ•
        function updateSeeMoreButton(field, value) {
            const bubble = carouselData.contents[currentTabIndex];
            if (bubble.body?.contents?.[0]?.action) {
                bubble.body.contents[0].action[field] = value;
                updatePreview();
            }
        }

        // æ›´æ–°æ°£æ³¡æ–‡å­—å…§å®¹
        function updateBubbleText(type, value) {
            const bubble = carouselData.contents[currentTabIndex];
            if (!bubble.body?.contents) return;
            
            const contents = bubble.body.contents;
            
            switch(type) {
                case 'title':
                    const titleItem = contents.find(c => c.weight === 'bold');
                    if (titleItem) {
                        titleItem.text = value;
                    } else {
                        contents.unshift({
                            type: 'text',
                            text: value,
                            wrap: true,
                            weight: 'bold',
                            size: 'xl'
                        });
                    }
                    break;
                    
                case 'subtitle':
                    let subtitleItem = contents.find(c => c.size === 'sm' && c.color === '#666666');
                    if (subtitleItem) {
                        subtitleItem.text = value;
                    } else {
                        // æ’å…¥åˆ°æ¨™é¡Œå¾Œé¢
                        const titleIndex = contents.findIndex(c => c.weight === 'bold');
                        contents.splice(titleIndex + 1, 0, {
                            type: 'text',
                            text: value,
                            wrap: true,
                            size: 'sm',
                            color: '#666666'
                        });
                    }
                    break;
                    
                case 'description':
                    let descItem = contents.find(c => c.wrap && c.margin);
                    if (descItem) {
                        descItem.text = value;
                    } else {
                        contents.push({
                            type: 'text',
                            text: value,
                            wrap: true,
                            size: 'sm',
                            margin: 'md'
                        });
                    }
                    break;
            }
            
            updateTabs(); // æ›´æ–°åˆ†é æ¨™é¡Œ
            updatePreview();
        }

        // è¼‰å…¥æŒ‰éˆ•åˆ—è¡¨
        function loadButtonList() {
            const bubble = carouselData.contents[currentTabIndex];
            const buttons = bubble.footer?.contents || [];
            const container = document.getElementById('button-list');
            
            let html = '';
            buttons.forEach((button, index) => {
                html += \`
                    <div class="button-item">
                        <div class="button-header">
                            <select class="button-type-select" onchange="updateButtonType(\\${index}, this.value)">
                                <option value="uri" \\${button.action?.type === 'uri' ? 'selected' : ''}>é€£çµæŒ‰éˆ•</option>
                                <option value="postback" \\${button.action?.type === 'postback' ? 'selected' : ''}>å›å‚³æŒ‰éˆ•</option>
                                <option value="share" \\${button.action?.type === 'share' ? 'selected' : ''}>åˆ†äº«æŒ‰éˆ•</option>
                            </select>
                            <button class="button-remove" onclick="removeButton(\\${index})">åˆªé™¤</button>
                        </div>
                        <div class="button-fields">
                            <input type="text" placeholder="æŒ‰éˆ•æ–‡å­—" value="\\${button.action?.label || ''}" 
                                   onchange="updateButton(\\${index}, 'label', this.value)">
                            \\${button.action?.type === 'uri' ? 
                                \`<input type="url" placeholder="é€£çµç¶²å€" value="\\${button.action?.uri || ''}" 
                                       onchange="updateButton(\\${index}, 'uri', this.value)">\` :
                                button.action?.type === 'postback' ?
                                \`<input type="text" placeholder="å›å‚³è³‡æ–™" value="\\${button.action?.data || ''}" 
                                       onchange="updateButton(\\${index}, 'data', this.value)">\` :
                                \`<input type="text" placeholder="åˆ†äº«å…§å®¹" value="åˆ†äº«æ­¤å»ºæ¡ˆè³‡è¨Š" readonly>\`
                            }
                        </div>
                    </div>
                \`;
            });
            
            if (container) {
                container.innerHTML = html;
            }
        }

        // æ–°å¢æŒ‰éˆ•
        function addButton() {
            const bubble = carouselData.contents[currentTabIndex];
            if (!bubble.footer) {
                bubble.footer = {
                    type: 'box',
                    layout: 'vertical',
                    spacing: 'sm',
                    contents: []
                };
            }
            
            if (bubble.footer.contents.length >= 3) {
                alert('æ¯å€‹åˆ†é æœ€å¤šåªèƒ½æœ‰3å€‹æŒ‰éˆ•');
                return;
            }
            
            bubble.footer.contents.push({
                type: 'button',
                style: bubble.footer.contents.length === 0 ? 'primary' : 'secondary',
                action: {
                    type: 'uri',
                    label: 'æ–°æŒ‰éˆ•',
                    uri: 'https://example.com'
                }
            });
            
            loadButtonList();
            updatePreview();
        }

        // ç§»é™¤æŒ‰éˆ•
        function removeButton(index) {
            const bubble = carouselData.contents[currentTabIndex];
            if (bubble.footer?.contents) {
                bubble.footer.contents.splice(index, 1);
                loadButtonList();
                updatePreview();
            }
        }

        // æ›´æ–°æŒ‰éˆ•
        function updateButton(index, field, value) {
            const bubble = carouselData.contents[currentTabIndex];
            if (bubble.footer?.contents?.[index]?.action) {
                bubble.footer.contents[index].action[field] = value;
                updatePreview();
            }
        }

        // æ›´æ–°æŒ‰éˆ•é¡å‹
        function updateButtonType(index, type) {
            const bubble = carouselData.contents[currentTabIndex];
            if (bubble.footer?.contents?.[index]) {
                const button = bubble.footer.contents[index];
                const oldLabel = button.action?.label || 'æŒ‰éˆ•';
                
                switch(type) {
                    case 'uri':
                        button.action = {
                            type: 'uri',
                            label: oldLabel,
                            uri: 'https://example.com'
                        };
                        break;
                    case 'postback':
                        button.action = {
                            type: 'postback',
                            label: oldLabel,
                            data: 'action=click'
                        };
                        break;
                    case 'share':
                        button.action = {
                            type: 'uri',
                            label: 'åˆ†äº«çµ¦æœ‹å‹',
                            uri: 'line://app/YOUR_LIFF_ID?action=share'
                        };
                        button.style = 'secondary';
                        break;
                }
                
                loadButtonList();
                updatePreview();
            }
        }

        // åœ–ç‰‡ä¸Šå‚³è™•ç†
        async function uploadImage() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (file) {
                    await handleImageUpload(file);
                }
            };
            input.click();
        }

        // è™•ç†åœ–ç‰‡ä¸Šå‚³
        async function handleImageUpload(file) {
            const formData = new FormData();
            formData.append('image', file);
            
            try {
                // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
                const uploadArea = document.querySelector('.image-upload');
                uploadArea.innerHTML = '<div class="upload-icon">â³</div><div class="upload-text">ä¸Šå‚³ä¸­...</div>';
                
                const response = await fetch('/api/upload-image', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // æ›´æ–°åœ–ç‰‡ URL
                    const bubble = carouselData.contents[currentTabIndex];
                    if (!bubble.hero) {
                        bubble.hero = {
                            type: 'image',
                            size: 'full',
                            aspectRatio: '20:13',
                            aspectMode: 'cover',
                            url: result.data.publicUrl
                        };
                    } else {
                        bubble.hero.url = result.data.publicUrl;
                    }
                    
                    loadTabContent(); // é‡æ–°è¼‰å…¥è¡¨å–®
                    updatePreview();
                    
                } else {
                    alert('ä¸Šå‚³å¤±æ•—: ' + result.error);
                    loadTabContent(); // æ¢å¾©è¡¨å–®
                }
            } catch (error) {
                console.error('ä¸Šå‚³éŒ¯èª¤:', error);
                alert('ä¸Šå‚³å¤±æ•—: ' + error.message);
                loadTabContent(); // æ¢å¾©è¡¨å–®
            }
        }

        // æ‹–æ”¾åœ–ç‰‡è™•ç†
        function handleImageDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].type.startsWith('image/')) {
                handleImageUpload(files[0]);
            }
        }

        function handleImageDragover(e) {
            e.preventDefault();
            e.stopPropagation();
            e.currentTarget.classList.add('dragover');
        }

        // ç§»é™¤åœ–ç‰‡
        function removeImage() {
            const bubble = carouselData.contents[currentTabIndex];
            if (bubble.hero) {
                bubble.hero.url = 'https://via.placeholder.com/300x195/667eea/white?text=No+Image';
            }
            loadTabContent();
            updatePreview();
        }

        // æ›´æ–°é è¦½
        function updatePreview() {
            const container = document.getElementById('carousel-preview');
            let html = '';
            
            carouselData.contents.forEach((bubble, index) => {
                const hero = bubble.hero;
                const body = bubble.body?.contents || [];
                const title = body.find(c => c.weight === 'bold')?.text || \`åˆ†é  \\${index + 1}\`;
                const subtitle = body.find(c => c.size === 'sm' && c.color === '#666666')?.text || '';
                const buttons = bubble.footer?.contents || [];
                
                // æª¢æŸ¥æ˜¯å¦æ˜¯"æŸ¥çœ‹æ›´å¤š"åˆ†é 
                const isSeeMore = bubble.body?.contents?.length === 1 && 
                                bubble.body.contents[0].type === 'button';
                
                if (isSeeMore) {
                    html += \`
                        <div class="bubble-preview \\${index === currentTabIndex ? 'active' : ''}">
                            <div class="bubble-content" style="padding: 40px 20px; text-align: center;">
                                <button class="bubble-button" style="background: #667eea; padding: 15px 20px;">
                                    \\${bubble.body.contents[0].action?.label || 'æŸ¥çœ‹æ›´å¤š'}
                                </button>
                            </div>
                        </div>
                    \`;
                } else {
                    html += \`
                        <div class="bubble-preview \\${index === currentTabIndex ? 'active' : ''}">
                            \\${hero?.url && hero.url !== 'https://via.placeholder.com/300x195/667eea/white?text=No+Image' ? 
                                \`<img src="\\${hero.url}" class="bubble-image" alt="åœ–ç‰‡">\` : 
                                \`<div class="bubble-image" style="display: flex; align-items: center; justify-content: center; background: #f0f0f0; color: #999;">ç„¡åœ–ç‰‡</div>\`
                            }
                            <div class="bubble-content">
                                <div class="bubble-title">\\${title}</div>
                                \\${subtitle ? \`<div style="font-size: 12px; color: #666; margin-bottom: 6px;">\\${subtitle}</div>\` : ''}
                            </div>
                            \\${buttons.length > 0 ? \`
                                <div class="bubble-buttons">
                                    \\${buttons.map((btn, btnIndex) => {
                                        const btnClass = btnIndex === 0 ? 'bubble-button' : 
                                                       btn.action?.type === 'share' ? 'bubble-button share' :
                                                       'bubble-button secondary';
                                        return \`<button class="\\${btnClass}">\\${btn.action?.label || 'æŒ‰éˆ•'}</button>\`;
                                    }).join('')}
                                </div>
                            \` : ''}
                        </div>
                    \`;
                }
            });
            
            container.innerHTML = html;
        }

        // æ›´æ–°è®Šæ•¸åˆ—è¡¨
        function updateVariablesList() {
            const container = document.getElementById('variables-list');
            const baseVariables = [
                '{{project_name}} - å»ºæ¡ˆåç¨±',
                '{{date}} - ä»Šæ—¥æ—¥æœŸ',
                '{{building_count}} - æ£Ÿæ•¸',
                '{{contact_phone}} - è¯çµ¡é›»è©±',
                '{{contact_person}} - è¯çµ¡äºº'
            ];
            
            // æ ¹æ“šé¡åˆ¥å¢åŠ ç‰¹å®šè®Šæ•¸
            let categoryVariables = [];
            switch(currentCategory) {
                case 'construction_progress':
                    categoryVariables = [
                        '{{progress}} - å·¥ç¨‹é€²åº¦',
                        '{{completion_date}} - é è¨ˆå®Œå·¥',
                        '{{current_phase}} - ç›®å‰éšæ®µ'
                    ];
                    break;
                case 'sales_update':
                    categoryVariables = [
                        '{{building_A_sold}} - Aæ£ŸéŠ·å”®ç‡',
                        '{{building_B_sold}} - Bæ£ŸéŠ·å”®ç‡',
                        '{{remaining_units}} - å‰©é¤˜æˆ¶æ•¸'
                    ];
                    break;
                case 'new_project_launch':
                    categoryVariables = [
                        '{{starting_price}} - èµ·å§‹åƒ¹æ ¼',
                        '{{total_units}} - ç¸½æˆ¶æ•¸',
                        '{{launch_date}} - é–‹è³£æ—¥æœŸ'
                    ];
                    break;
            }
            
            const allVariables = [...baseVariables, ...categoryVariables];
            
            container.innerHTML = allVariables.map(variable => 
                \`<div class="variable-item">\\${variable}</div>\`
            ).join('');
        }

        // å·¥å…·åˆ—åŠŸèƒ½
        function loadProject() {
            // TODO: è¼‰å…¥å»ºæ¡ˆè³‡æ–™
            alert('å»ºæ¡ˆè¼‰å…¥åŠŸèƒ½é–‹ç™¼ä¸­...');
        }

        function showJsonPreview() {
            const jsonWindow = window.open('', '_blank', 'width=800,height=600');
            jsonWindow.document.write(`
                <html>
                    <head><title>Flex Carousel JSON</title></head>
                    <body style="font-family: monospace; padding: 20px;">
                        <h3>ç”Ÿæˆçš„ Flex Carousel JSON</h3>
                        <pre style="background: #f5f5f5; padding: 15px; border-radius: 8px; overflow: auto; white-space: pre-wrap; max-height: 80vh;">\\${JSON.stringify(carouselData, null, 2)}</pre>
                        <br>
                        <button onclick="navigator.clipboard.writeText('\\${JSON.stringify(carouselData).replace(/'/g, "\\\\'")}'); alert('JSON å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿!');" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer;">ğŸ“‹ è¤‡è£½ JSON</button>
                        <button onclick="window.close();" style="margin-left: 10px; padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer;">âœ• é—œé–‰</button>
                    </body>
                </html>
            `);
        }

        function previewInNewWindow() {
            alert('é è¦½åŠŸèƒ½é–‹ç™¼ä¸­...');
        }

        async function saveTemplate() {
            const templateName = prompt('è«‹è¼¸å…¥æ¨¡æ¿åç¨±:');
            if (!templateName) return;
            
            const categoryName = templateCategories.find(c => c.category_id === currentCategory)?.category_name || 'è‡ªè¨‚';
            
            try {
                const response = await fetch('/api/flex-templates', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        template_name: templateName,
                        description: \`\\${categoryName}æ¨¡æ¿ - å…±\\${carouselData.contents.length}å€‹åˆ†é \`,
                        template_type: 'carousel',
                        flex_content: JSON.stringify(carouselData),
                        category: currentCategory
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('æ¨¡æ¿å„²å­˜æˆåŠŸï¼\\næ¨¡æ¿ ID: ' + result.template_id);
                } else {
                    alert('å„²å­˜å¤±æ•—ï¼š' + result.error);
                }
            } catch (error) {
                alert('å„²å­˜å‡ºéŒ¯ï¼š' + error.message);
            }
        }

        // è¼‰å…¥ç¾æœ‰æ¨¡æ¿
        async function loadExistingTemplate(templateId) {
            try {
                const response = await fetch('/api/flex-templates/' + templateId);
                const data = await response.json();
                
                if (data.success && data.template) {
                    const template = data.template;
                    document.querySelector('.editor-title').textContent = 'ğŸ“± ç·¨è¼¯æ¨¡æ¿: ' + template.template_name;
                    
                    // è§£æ flex_content
                    const flexContent = JSON.parse(template.flex_content);
                    if (flexContent.type === 'carousel') {
                        carouselData = flexContent;
                    }
                    
                    // è¨­å®šåˆ†é¡
                    if (template.category) {
                        currentCategory = template.category;
                    }
                    
                    currentTabIndex = 0;
                    updateTabs();
                    updatePreview();
                    updateVariablesList();
                } else {
                    alert('è¼‰å…¥æ¨¡æ¿å¤±æ•—: ' + (data.error || 'æ¨¡æ¿ä¸å­˜åœ¨'));
                }
            } catch (error) {
                console.error('è¼‰å…¥æ¨¡æ¿éŒ¯èª¤:', error);
                alert('è¼‰å…¥æ¨¡æ¿æ™‚ç™¼ç”ŸéŒ¯èª¤');
            }
        }

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>\`;

  return new Response(flexCarouselEditorHtml, {
    headers: { 'Content-Type': 'text/html; charset=utf-8' }
  });
}